<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GridGRAMM: functions.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>functions.php</h1><a href="functions_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 &lt;?<span class="comment"></span>
00002 <span class="comment">/**</span>
00003 <span class="comment"> * General utility functions</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * This file contains convenience functions used throughout the package. </span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> * @package GridGRAMM</span>
00008 <span class="comment"> * @author David Garcia Aristegui &lt;david@cnb.uam.es&gt;</span>
00009 <span class="comment"> * @version 1.0</span>
00010 <span class="comment"> * @copyright CSIC - GPL</span>
00011 <span class="comment"> */</span>
00012 <span class="comment"></span>
00013 <span class="comment">/**</span>
00014 <span class="comment"> * include global configuration definitions</span>
00015 <span class="comment"> */</span>
00016 require(<span class="stringliteral">"./variables.php"</span>);
00017 <span class="comment"></span>
00018 <span class="comment">/**</span>
00019 <span class="comment"> * open a connection to the Grid UI server</span>
00020 <span class="comment"> * </span>
00021 <span class="comment"> *      The Grid User Interface server is the entry point to the Grid</span>
00022 <span class="comment"> *  for users and user applications. This is where jobs are launched from.</span>
00023 <span class="comment"> * </span>
00024 <span class="comment"> *      GridGRAMM has been designed to be able to be installed in any</span>
00025 <span class="comment"> *  host, independent of whether it is an UI or not. Thus, to be able to</span>
00026 <span class="comment"> *  submit jobs to the Grid, the server hosting GridGRAMM must connect to</span>
00027 <span class="comment"> *  a Grid UI host to do the work.</span>
00028 <span class="comment"> * </span>
00029 <span class="comment"> *      This routine opens a connection to a Grid UI host using a predefined</span>
00030 <span class="comment"> *  username (i.e. all jobs will be run under said username). To allow the</span>
00031 <span class="comment"> *  caller to communicate with the remote end, it creates two pipes, one for</span>
00032 <span class="comment"> *  input and one for output, and redirect error messages to a file.</span>
00033 <span class="comment"> * </span>
00034 <span class="comment"> *      These pipes lead to a child process that actually manages the </span>
00035 <span class="comment"> *  communication. Using a child process has several advantages: it simplifies</span>
00036 <span class="comment"> *  the communication process by offloading the comm. logic to a separate,</span>
00037 <span class="comment"> *  convenience tool, and by being able to use SSH as the child, we can increase</span>
00038 <span class="comment"> *  security taking advantage of its encryption capabilities.</span>
00039 <span class="comment"> * </span>
00040 <span class="comment"> *      The panorama therefore will look like this:</span>
00041 <span class="comment"> * </span>
00042 <span class="comment"> *      HTML front-end --&gt; processor.php &lt;--&gt; SSH &lt;--&gt; remote host &lt;--&gt; Grid</span>
00043 <span class="comment"> * </span>
00044 <span class="comment"> *      @param server   A username@remove.grid.ui.host pair to use a command</span>
00045 <span class="comment"> *                      processor</span>
00046 <span class="comment"> *      @param grid_path Path to working directory in the local machine</span>
00047 <span class="comment"> *      @param process  A handle to the child process that manages communication</span>
00048 <span class="comment"> *                      with the Grid access point</span>
00049 <span class="comment"> *      @param descriptorspec</span>
00050 <span class="comment"> *      @param pipes    An array of file descriptors to be used to communicate</span>
00051 <span class="comment"> *                      withe the Grid UI through the child process.</span>
00052 <span class="comment"> */</span>
<a name="l00053"></a><a class="code" href="functions_8php.html#a0">00053</a> function <a class="code" href="functions_8php.html#a0">open_connection</a>($server, $grid_path, $process, $descriptorspec, $pipes)
00054 {
00055         <span class="comment">// The ssh connection is a 'child' process, in the User Interface </span>
00056         <span class="comment">// opened wit 'proc_open'</span>
00057         
00058         global <a class="code" href="kkk_8php.html#a3">$process</a>, <a class="code" href="kkk_8php.html#a2">$descriptorspec</a>, $pipes;
00059         <a class="code" href="kkk_8php.html#a2">$descriptorspec</a> = array(
00060                 0 =&gt; array(<span class="stringliteral">"pipe"</span>, <span class="stringliteral">"r"</span>),  <span class="comment">// stdin is a pipe that the child will read from</span>
00061                 1 =&gt; array(<span class="stringliteral">"pipe"</span>, <span class="stringliteral">"w"</span>),  <span class="comment">// stdout is a pipe that the child will write to</span>
00062                 2 =&gt; array(<span class="stringliteral">"file"</span>, <span class="stringliteral">"$grid_path/error-output.txt"</span>, <span class="stringliteral">"a"</span>) <span class="comment">// stderr is a file to write to</span>
00063         );
00064         
00065         <span class="comment">// Open the child process with 'proc_open' function. SSH connection with</span>
00066         <span class="comment">//  -x parameter, we need to disable the X11 forwarding.</span>
00067         <span class="comment">// $process = proc_open("ssh -t -t $server", $descriptorspec, $pipes);</span>
00068         <span class="comment">// Is required to us twice the parameter -t, otherwise we get the error:</span>
00069         <span class="comment">// "Pseudo-terminal will not be allocated because stdin is not a terminal".</span>
00070         <a class="code" href="kkk_8php.html#a3">$process</a> = proc_open(<span class="stringliteral">"ssh -x -t -t $server"</span>, $descriptorspec, $pipes);
00071         
00072         <span class="comment">// $pipes now looks like this:</span>
00073         <span class="comment">//   0 =&gt; writeable handle connected to child stdin</span>
00074         <span class="comment">//   1 =&gt; readable handle connected to child stdout</span>
00075         <span class="comment">// Any error output will be appended to $grid_path/error-output.txt</span>
00076 
00077 
00078         <span class="keywordflow">if</span> (!is_resource($process)) 
00079         {
00080                 echo <span class="stringliteral">"connection error!!!&lt;br &gt;&lt;/body&gt;&lt;/html&gt;\n"</span>;
00081                 <a class="code" href="results_8php.html#a1">exit</a>;
00082         }
00083 
00084 }
00085 
00086 <span class="comment"></span>
00087 <span class="comment">/**</span>
00088 <span class="comment"> * Close the connection with the remote Grid access point (UI node)</span>
00089 <span class="comment"> *</span>
00090 <span class="comment"> *      What we are going to do is to close the communication pipes</span>
00091 <span class="comment"> *  and kill the child processes that actually handles communication</span>
00092 <span class="comment"> *  with the remote Grid UI host (ssh).</span>
00093 <span class="comment"> * </span>
00094 <span class="comment"> *  @note CLOSE_CONNECTION IS USEFUL TO DEBUG!!!</span>
00095 <span class="comment"> *</span>
00096 <span class="comment"> *  @param $process</span>
00097 <span class="comment"> *  @param $descriptorspec</span>
00098 <span class="comment"> *  @param $pipes</span>
00099 <span class="comment"> */</span>
<a name="l00100"></a><a class="code" href="functions_8php.html#a1">00100</a> function <a class="code" href="functions_8php.html#a1">close_connection</a>($process, $descriptorspec, $pipes)
00101 {
00102         
00103         <span class="comment">// Required to close the 'child' process, otherwise 'proc_close' function hangs!!!</span>
00104         fwrite($pipes[0], <span class="stringliteral">"exit\n"</span>);
00105 
00106         fclose($pipes[0]);
00107 
00108         <span class="comment">// The output from the commands</span>
00109         <span class="comment">// Uncomment to debug the 'child' process!!!</span>
00110         <span class="comment">/*</span>
00111 <span class="comment">        while (!feof($pipes[1]))</span>
00112 <span class="comment">        {</span>
00113 <span class="comment">                echo fgets($pipes[1], 1024)."&lt;br /&gt;";</span>
00114 <span class="comment">        }</span>
00115 <span class="comment">        */</span>
00116         fclose($pipes[1]);
00117 
00118         <span class="comment">// It's important that you close any pipes before calling</span>
00119         <span class="comment">// proc_close in order to avoid a deadlock</span>
00120         <a class="code" href="kkk_8php.html#a4">$return_value</a> = proc_close($process);
00121         
00122         <span class="comment">// echo "\ncommand returned $return_value\n";   </span>
00123 }
00124 <span class="comment"></span>
00125 <span class="comment">/**</span>
00126 <span class="comment"> * Install the program and scripts needed to run it on a suitable place</span>
00127 <span class="comment"> *</span>
00128 <span class="comment"> *      This function installs the docking program GRAMM and the scripts</span>
00129 <span class="comment"> * needed to run it on a suitable local directory.</span>
00130 <span class="comment"> *</span>
00131 <span class="comment"> *      Since we may potentially be called many times in a short period</span>
00132 <span class="comment"> * we need a way to make sure their jobs don't clash with one another,</span>
00133 <span class="comment"> * most specially, that they don't overwrite each others' workspace.</span>
00134 <span class="comment"> *</span>
00135 <span class="comment"> *      For this reason, we use a separate working directory for each</span>
00136 <span class="comment"> * request. This function will install GRAMM on the specified working</span>
00137 <span class="comment"> * directory.</span>
00138 <span class="comment"> *</span>
00139 <span class="comment"> *      @param grid_path        local directory devoted to Grid work</span>
00140 <span class="comment"> *      @param random_value     a random value to generate a unique</span>
00141 <span class="comment"> *                              name for the working directory.</span>
00142 <span class="comment"> */</span>
<a name="l00143"></a><a class="code" href="functions_8php.html#a2">00143</a> function <a class="code" href="functions_8php.html#a2">install_gramm</a>($grid_path, $random_value)
00144 {       
00145         <span class="comment">// We copy the results.php to the working directory</span>
00146         <span class="keywordflow">if</span> (!copy( <span class="stringliteral">"./results.php"</span>, <span class="stringliteral">"$grid_path/$random_value/index.php"</span> ))     
00147         {
00148                 echo <span class="stringliteral">"Error, can't copy results.php to the working directory&lt;br /&gt;&lt;/body&gt;&lt;/html&gt;\n"</span>;
00149                 <a class="code" href="results_8php.html#a1">exit</a>;   
00150         } 
00151         
00152         <span class="comment">// We copy the functions.php to the working directory</span>
00153         <span class="keywordflow">if</span> (!copy( <span class="stringliteral">"./functions.php"</span>, <span class="stringliteral">"$grid_path/$random_value/functions.php"</span> ))       
00154         {
00155                 echo <span class="stringliteral">"Error, can't copy functions.php to the working directory&lt;br /&gt;&lt;/body&gt;&lt;/html&gt;\n"</span>;
00156                 <a class="code" href="results_8php.html#a1">exit</a>;   
00157         } 
00158         
00159         <span class="comment">// We copy the variables.php to the working directory</span>
00160         <span class="keywordflow">if</span> (!copy( <span class="stringliteral">"./variables.php"</span>, <span class="stringliteral">"$grid_path/$random_value/variables.php"</span> ))       
00161         {
00162                 echo <span class="stringliteral">"Error, can't copy variables.php to the working directory&lt;br /&gt;&lt;/body&gt;&lt;/html&gt;\n"</span>;
00163                 <a class="code" href="results_8php.html#a1">exit</a>;   
00164         } 
00165         
00166         <span class="comment">// We copy the egee logo</span>
00167         <span class="keywordflow">if</span> (!copy( <span class="stringliteral">"../interface/egee.jpg"</span>, <span class="stringliteral">"$grid_path/$random_value/egee.jpg"</span> ))      
00168         {
00169                 echo <span class="stringliteral">"Error, can't copy  egee.jpg to the working directory&lt;br /&gt;&lt;/body&gt;&lt;/html&gt;\n"</span>;
00170                 <a class="code" href="results_8php.html#a1">exit</a>;   
00171         } 
00172         <span class="comment">// We move the gramm files to the working directory</span>
00173         <span class="comment">// XXX JR XXX -- this should suffice</span>
00174         exec(<span class="stringliteral">"cp -f gramm/* $grid_path/$random_value/gramm/"</span>);
00175         <span class="comment">// otherwise use</span>
00176         <span class="comment">// - in variables.php</span>
00177         <span class="comment">// - $my_location="/data/www/EMBnet/cgi-src/Grid/GridGRAMM";</span>
00178         <span class="comment">// exec("cp -f $my_location/script/gramm/* $grid_path/$random_value/gramm/");</span>
00179 }
00180 <span class="comment"></span>
00181 <span class="comment">/**</span>
00182 <span class="comment"> * Start the Grid services</span>
00183 <span class="comment"> */</span>
<a name="l00184"></a><a class="code" href="functions_8php.html#a3">00184</a> function <a class="code" href="functions_8php.html#a3">enter_grid</a>($pipes, $grid_pass)
00185 {
00186         <span class="comment">// Remote EGEE middleware interaction</span>
00187         <span class="comment">// We run the Globus and Middelware commands in the User Interface, but the output goes to the local machine </span>
00188         <span class="comment">// in the mounted directory</span>
00189         fwrite($pipes[0], <span class="stringliteral">"grid-proxy-init  -pwstdin\n"</span>);
00190         sleep(2);     
00191         fwrite($pipes[0], <span class="stringliteral">"$grid_pass\n"</span>);
00192 }
00193 <span class="comment"></span>
00194 <span class="comment">/**</span>
00195 <span class="comment"> * Create working directory</span>
00196 <span class="comment"> */</span>
<a name="l00197"></a><a class="code" href="functions_8php.html#a4">00197</a> function <a class="code" href="functions_8php.html#a4">create_working_directory</a>($grid_path)
00198 {
00199         <span class="comment">// Random value for the directory</span>
00200         global $random_value;
00201         srand((<span class="keywordtype">double</span>)microtime()*10000);
00202         $random_value = rand();
00203         
00204         <span class="comment">// Working directory in the local machine</span>
00205         <span class="keywordflow">if</span> (!mkdir(<span class="stringliteral">"$grid_path/$random_value"</span>, 0777))
00206         {
00207                 echo <span class="stringliteral">"Error, can't generate the working directory&lt;br /&gt;&lt;/body&gt;&lt;/html&gt;\n"</span>;
00208                 <a class="code" href="results_8php.html#a1">exit</a>;   
00209         }
00210         <span class="comment">// Mkdir don't work properly with the permissions</span>
00211         chmod( <span class="stringliteral">"$grid_path/$random_value"</span>, 0777 );
00212         
00213         <span class="comment">// Gramm directory in the local machine</span>
00214         <span class="keywordflow">if</span> (!mkdir (<span class="stringliteral">"$grid_path/$random_value/gramm"</span>, 0777))
00215         {
00216                 echo <span class="stringliteral">"Error, can't generate the gramm directory&lt;br /&gt;&lt;/body&gt;&lt;/html&gt;\n"</span>;
00217                 <a class="code" href="results_8php.html#a1">exit</a>;   
00218         }
00219         <span class="comment">// Mkdir don't work properly with the permissions</span>
00220         chmod( <span class="stringliteral">"$grid_path/$random_value/gramm"</span>, 0777 );
00221 }
00222 <span class="comment"></span>
00223 <span class="comment">/**</span>
00224 <span class="comment"> * Get job identifier</span>
00225 <span class="comment"> */</span>
<a name="l00226"></a><a class="code" href="functions_8php.html#a5">00226</a> function <a class="code" href="functions_8php.html#a5">job_identifier</a>()
00227 {
00228         <span class="comment">// Each grid job has a unique identifier</span>
00229         global $identifier;
00230         $identifier=<span class="stringliteral">""</span>;
00231         $lines=file(<span class="stringliteral">"./gramm/identifier.txt"</span>);
00232         <span class="comment">// We retrieve the identifier</span>
00233         $identifier=$lines[1];
00234         $identifier=rtrim(<span class="stringliteral">"$identifier"</span>);
00235         
00236 }
00237 <span class="comment"></span>
00238 <span class="comment">/**</span>
00239 <span class="comment"> * Check job status</span>
00240 <span class="comment"> */</span>
<a name="l00241"></a><a class="code" href="functions_8php.html#a6">00241</a> function <a class="code" href="functions_8php.html#a6">check_status</a>()
00242 {
00243         <span class="comment">// array with all the text lines</span>
00244         <span class="keywordflow">if</span>( file_exists(<span class="stringliteral">"./gramm/status.txt"</span>) )
00245         {       
00246                 $lines=file(<span class="stringliteral">"./gramm/status.txt"</span>);
00247                 <span class="comment">//We retrieve the information</span>
00248                 $value=$lines[6];
00249                 <span class="comment">//Last character </span>
00250                 $value=rtrim(<span class="stringliteral">"$value"</span>);
00251                 <span class="keywordflow">return</span> $value;
00252         }
00253         
00254 }       
00255 <span class="comment"></span>
00256 <span class="comment">/**</span>
00257 <span class="comment"> * Upload user data</span>
00258 <span class="comment"> */</span>
<a name="l00259"></a><a class="code" href="functions_8php.html#a7">00259</a> function <a class="code" href="functions_8php.html#a7">upload_user_data</a>($grid_path, $random_value)
00260 {
00261 <span class="comment">// Two files to upload: Receptor file and Ligand file, for the gramm program</span>
00262         <span class="comment">// This loop is dirty trick to get Receptor and Ligand files</span>
00263         <span class="keywordflow">for</span> ($i=0; $i&lt;2; $i++) 
00264         {
00265    
00266                 <span class="keywordflow">if</span>($i==0)
00267                 {
00268                         $file_str=<span class="stringliteral">"Receptor"</span>; 
00269                         $upfile=<span class="stringliteral">"$grid_path/$random_value/gramm/receptor.pdb"</span>;
00270                 }<span class="keywordflow">else</span>
00271                 {
00272                         $file_str=<span class="stringliteral">"Ligand"</span>;
00273                         $upfile=<span class="stringliteral">"$grid_path/$random_value/gramm/ligand.pdb"</span>;
00274                 }
00275 
00276                 
00277                 $userfile = $_FILES['upload']['tmp_name'][$i];
00278                 $userfile_name = $_FILES['upload']['name'][$i];
00279                 $userfile_size = $_FILES['upload']['size'][$i];
00280 
00281                 <span class="comment">// We check if the files upload are correct  </span>
00282                 <span class="keywordflow">if</span> ($_FILES['upload']['tmp_name'][$i]==<span class="stringliteral">"none"</span> || $_FILES['upload']['tmp_name'][$i]==<span class="stringliteral">""</span>)
00283                 {
00284                         echo <span class="stringliteral">"&lt;h1&gt;Problem: no $file_str file uploaded&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;"</span>;
00285                         <a class="code" href="results_8php.html#a1">exit</a>;
00286                 }
00287   
00288                 <span class="keywordflow">if</span> ($_FILES['upload']['size'][$i]==0)
00289                 {
00290                         echo <span class="stringliteral">"&lt;h1&gt;Problem: uploaded $file_str file is zero length&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;"</span>;
00291                         <a class="code" href="results_8php.html#a1">exit</a>;
00292                 }
00293 
00294                 <span class="comment">// $upfile = "./$userfile_name";</span>
00295                 
00296                 <span class="comment">// move_uploaded_file this function checks to ensure that the file designated by filename is a valid upload file </span>
00297                 <span class="comment">// (meaning that it was uploaded via PHP's HTTP POST upload mechanism). If the file is valid, it will be moved to the </span>
00298                 <span class="comment">// filename given by destination.If filename is not a valid upload file, then no action will occur, and move_uploaded_file() </span>
00299                 <span class="comment">// will return FALSE. </span>
00300                 <span class="keywordflow">if</span> (!move_uploaded_file($userfile, $upfile)) 
00301                 {
00302                         echo <span class="stringliteral">"&lt;h1&gt;$userfile y $upfile Problem: Could not move file into directory&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;"</span>; 
00303                         <a class="code" href="results_8php.html#a1">exit</a>;
00304                 }
00305 
00306 
00307         }
00308         
00309 }
00310 <span class="comment"></span>
00311 <span class="comment">/**</span>
00312 <span class="comment"> * Create configuration files needed to run GRAMM</span>
00313 <span class="comment"> */</span>
<a name="l00314"></a><a class="code" href="functions_8php.html#a8">00314</a> function <a class="code" href="functions_8php.html#a8">create_gr_files</a>($grid_path, $random_value, $resolution)
00315 {
00316 <span class="comment">// We generate rmol.gr, rpar.gr and wlist.gr, requiered to run gramm</span>
00317 
00318 <span class="comment">// Writing rmol.gr</span>
00319 
00320 $rmol=<span class="stringliteral">"$grid_path/$random_value/gramm/rmol.gr"</span>;
00321 $receptor = <span class="stringliteral">"receptor"</span>;
00322 $ligand = <span class="stringliteral">"ligand"</span>;
00323 
00324 $fp = fopen( <span class="stringliteral">"$rmol"</span>, <span class="stringliteral">"w"</span> );
00325 
00326         fwrite( $fp, <span class="stringliteral">"# Filename  Fragment  ID      Filename  Fragment  ID     [paral/anti  max.ang]\n"</span>);
00327         fwrite( $fp, <span class="stringliteral">"# ----------------------------------------------------------------------------\n"</span>);
00328         fwrite( $fp, <span class="stringliteral">"\n"</span>);
00329         fwrite( $fp, <span class="stringliteral">"$receptor.pdb     *    receptor  $ligand.pdb       *     ligand\n"</span>);
00330 
00331 fclose( $fp );
00332 
00333 <span class="comment">// Writing rpar.gr</span>
00334 $rpar=<span class="stringliteral">"$grid_path/$random_value/gramm/rpar.gr"</span>;
00335 
00336 $fp1 = fopen( <span class="stringliteral">"$rpar"</span>, <span class="stringliteral">"w"</span> );
00337 
00338         <span class="keywordflow">if</span> (<a class="code" href="processor_8php.html#a0">$resolution</a>==<span class="stringliteral">"low"</span>)
00339         {       
00340                 fwrite( $fp1, <span class="stringliteral">"Matching mode (generic/helix) ....................... mmode= generic\n"</span> );
00341                 fwrite( $fp1, <span class="stringliteral">"Grid step ............................................. eta= 6.8\n"</span> );
00342                 fwrite( $fp1, <span class="stringliteral">"Repulsion (attraction is always -1) .................... ro= 6.5.\n"</span> );
00343                 fwrite( $fp1, <span class="stringliteral">"Attraction double range (fraction of single range) ..... fr= 0.\n"</span> );
00344                 fwrite( $fp1, <span class="stringliteral">"Potential range type (atom_radius, grid_step) ....... crang= grid_step\n"</span> );
00345                 fwrite( $fp1, <span class="stringliteral">"Projection (blackwhite, gray) ................ ....... ccti= gray\n"</span> );
00346                 fwrite( $fp1, <span class="stringliteral">"Representation (all, hydrophobic) .................... crep= all\n"</span> );
00347                 fwrite( $fp1, <span class="stringliteral">"Number of matches to output .......................... maxm= 1000\n"</span> );
00348                 fwrite( $fp1, <span class="stringliteral">"Angle for rotations, deg (10,12,15,18,20,30, 0-no rot.)  ai= 20\n"</span> );    
00349         }<span class="keywordflow">else</span>
00350         {
00351                 fwrite( $fp1, <span class="stringliteral">"Matching mode (generic/helix) ....................... mmode= generic\n"</span> );
00352                 fwrite( $fp1, <span class="stringliteral">"Grid step ............................................. eta= 1.7\n"</span> );
00353                 fwrite( $fp1, <span class="stringliteral">"Repulsion (attraction is always -1) .................... ro= 30.\n"</span> );
00354                 fwrite( $fp1, <span class="stringliteral">"Attraction double range (fraction of single range) ..... fr= 0.\n"</span> );
00355                 fwrite( $fp1, <span class="stringliteral">"Potential range type (atom_radius, grid_step) ....... crang= atom_radius\n"</span> );
00356                 fwrite( $fp1, <span class="stringliteral">"Projection (blackwhite, gray) ................ ....... ccti= gray\n"</span> );
00357                 fwrite( $fp1, <span class="stringliteral">"Representation (all, hydrophobic) .................... crep= all\n"</span> );
00358                 fwrite( $fp1, <span class="stringliteral">"Number of matches to output .......................... maxm= 1000\n"</span> );
00359                 fwrite( $fp1, <span class="stringliteral">"Angle for rotations, deg (10,12,15,18,20,30, 0-no rot.)  ai= 10\n"</span> );
00360          }
00361 
00362 fclose( $fp1 );
00363 
00364 <span class="comment">// Writing wlist.gr</span>
00365 $wlist=<span class="stringliteral">"$grid_path/$random_value/gramm/wlist.gr"</span>;
00366 
00367 $fp2 = fopen( <span class="stringliteral">"$wlist"</span>, <span class="stringliteral">"w"</span> );
00368 
00369         fwrite( $fp2, <span class="stringliteral">"# File_of_predictions   First_match   Last_match   separate/joint  +init_lig\n"</span> );
00370         fwrite( $fp2, <span class="stringliteral">"# ----------------------------------------------------------------------------\n"</span> );
00371         fwrite( $fp2, <span class="stringliteral">"$receptor-$ligand.res    1   10  separ   no\n"</span> );        
00372 
00373 fclose( $fp2 );
00374 }
00375 <span class="comment"></span>
00376 <span class="comment">/**</span>
00377 <span class="comment"> * Create JDL description of the job to be submitted to the Grid</span>
00378 <span class="comment"> */</span>
<a name="l00379"></a><a class="code" href="functions_8php.html#a9">00379</a> function <a class="code" href="functions_8php.html#a9">create_jdl_file</a>($grid_path, $random_value)
00380 {
00381 <span class="comment">// JDL file to run the middleware command edg-job-submit</span>
00382 $new_jdl=<span class="stringliteral">"$grid_path/$random_value/gramm/file.jdl"</span>;
00383 
00384 $fp = fopen( <span class="stringliteral">"$new_jdl"</span>, <span class="stringliteral">"w"</span> );
00385 
00386         fwrite( $fp, <span class="stringliteral">"Type = \"Job\";\n"</span>);
00387         fwrite( $fp, <span class="stringliteral">"JobType = \"normal\";\n"</span>);
00388         fwrite( $fp, <span class="stringliteral">"VirtualOrganisation= \"biomed\";\n"</span>);
00389         fwrite( $fp, <span class="stringliteral">"Executable = \"gramm.sh\";\n"</span>);
00390         fwrite( $fp, <span class="stringliteral">"StdOutput = \"gramm.out\";\n"</span>);
00391         fwrite( $fp, <span class="stringliteral">"StdError = \"gramm.err\";\n"</span>);
00392         fwrite( $fp, <span class="stringliteral">"InputSandbox = {\"$grid_path/$random_value/gramm/gramm.sh\",\"$grid_path/$random_value/gramm/gramm-go.tar.gz\"};\n"</span>);
00393         fwrite( $fp, <span class="stringliteral">"OutputSandbox = {\"gridgramm.out\",\"gridgramm.err\",\"gramm-come.tar.gz\"};\n"</span>);
00394 
00395 fclose( $fp );
00396 
00397 }
00398 <span class="comment"></span>
00399 <span class="comment">/**</span>
00400 <span class="comment"> * Extract results gathered from the Grid</span>
00401 <span class="comment"> */</span>
<a name="l00402"></a><a class="code" href="functions_8php.html#a10">00402</a> function <a class="code" href="functions_8php.html#a10">unpack_results</a>()
00403 {
00404 <span class="comment">// We search the directory with the user results!!!</span>
00405 
00406 <span class="comment">// The results directory generated by the grid middleware starts with the grid user name</span>
00407 $dir = dir(<span class="stringliteral">"."</span>);        
00408 $dir-&gt;rewind();
00409         <span class="keywordflow">while</span> ($file = $dir-&gt;read())
00410         {       
00411                 <span class="comment">// To change: $user</span>
00412                 <span class="keywordflow">if</span> ( substr($file, 0, 5)==<span class="stringliteral">"$server_user"</span> )
00413                 {
00414                         <span class="comment">// We extract the gramm results</span>
00415                         exec(<span class="stringliteral">"tar -zxvf $file/gramm-come.tar.gz -C ."</span>);
00416                         $aux=<span class="stringliteral">"OK"</span>;
00417                         <span class="keywordflow">return</span> $aux;
00418                 }
00419         }
00420 }
00421 <span class="comment"></span>
00422 <span class="comment">/**</span>
00423 <span class="comment"> * Show the results to the user</span>
00424 <span class="comment"> */</span>
<a name="l00425"></a><a class="code" href="functions_8php.html#a11">00425</a> function <a class="code" href="functions_8php.html#a11">show_results</a>()
00426 {
00427 echo <span class="stringliteral">"&lt;center&gt;&lt;h1&gt;GridGramm results:&lt;br&gt;&lt;/h1&gt;&lt;center&gt;"</span>;
00428         echo <span class="stringliteral">"&lt;hr&gt;"</span>;
00429 
00430         echo <span class="stringliteral">"&lt;center&gt;&lt;table border=2&gt;"</span>;
00431         
00432         $dir = dir(<span class="stringliteral">"."</span>);
00433         
00434         $dir-&gt;rewind();
00435         <span class="keywordflow">while</span> ($file = $dir-&gt;read())
00436         {       
00437                 <span class="keywordflow">if</span> ( $file==<span class="stringliteral">"receptor.pdb"</span> )
00438                 {
00439                         echo <span class="stringliteral">"&lt;tr&gt;"</span>;
00440                         echo <span class="stringliteral">"&lt;td&gt;Structure of your receptor molecule.&lt;/td&gt;"</span>; 
00441                         echo <span class="stringliteral">"&lt;td&gt;&lt;a href=./$file&gt;$file&lt;/a&gt;&lt;/td&gt;"</span>;
00442                         echo <span class="stringliteral">"&lt;/tr&gt;"</span>;   
00443                 }
00444         }
00445         
00446         $dir-&gt;rewind();
00447         <span class="keywordflow">while</span> ($file = $dir-&gt;read())
00448         {       
00449                 <span class="keywordflow">if</span> ( $file==<span class="stringliteral">"ligand.pdb"</span> )
00450                 {
00451                         echo <span class="stringliteral">"&lt;tr&gt;"</span>;
00452                         echo <span class="stringliteral">"&lt;td&gt;Structure of your ligand molecule.&lt;/td&gt;"</span>; 
00453                         echo <span class="stringliteral">"&lt;td&gt;&lt;a href=./$file&gt;$file&lt;/a&gt;&lt;/td&gt;"</span>;
00454                         echo <span class="stringliteral">"&lt;/tr&gt;"</span>;   
00455                 }
00456         }
00457         
00458 
00459         $dir-&gt;rewind();
00460         <span class="keywordflow">while</span> ($file = $dir-&gt;read())
00461         {
00462                 <span class="comment">// Regular expression to show the receptor-ligand files</span>
00463                 <span class="keywordflow">if</span> ( ereg(<span class="stringliteral">"^receptor-ligand+_[0-9]+.pdb$"</span>, $file))
00464                 {
00465                         $filename = basename($file, <span class="stringliteral">".pdb"</span>);
00466                         echo <span class="stringliteral">"&lt;tr&gt;"</span>;
00467                         echo <span class="stringliteral">"&lt;td&gt;Structure of the receptor-ligand complex&lt;/td&gt;"</span>; 
00468                         echo <span class="stringliteral">"&lt;td&gt;&lt;a href=\"$filename.pdb\"&gt;$filename&lt;/a&gt;&lt;/td&gt;"</span>;
00469                         echo <span class="stringliteral">"&lt;/tr&gt;"</span>;   
00470                 }
00471         }
00472         
00473         $dir-&gt;rewind();
00474         <span class="keywordflow">while</span> ($file = $dir-&gt;read())
00475         {
00476                 <span class="keywordflow">if</span> ( $file==<span class="stringliteral">"receptor-ligand.res"</span> )
00477                 {
00478                         echo <span class="stringliteral">"&lt;tr&gt;"</span>;
00479                         echo <span class="stringliteral">"&lt;td&gt;Listing of the 1000 best scoring docks&lt;/td&gt;"</span>; 
00480                         echo <span class="stringliteral">"&lt;td colspan=\"4\"&gt;&lt;a href=./$file&gt;$file&lt;/a&gt;&lt;/td&gt;"</span>;
00481                         echo <span class="stringliteral">"&lt;/tr&gt;"</span>;   
00482                 }
00483         }
00484         
00485         $dir-&gt;rewind();
00486         <span class="keywordflow">while</span> ($file = $dir-&gt;read())
00487         {
00488                 <span class="keywordflow">if</span> ( $file==<span class="stringliteral">"gramm.log"</span> )
00489                         {
00490                                 echo <span class="stringliteral">"&lt;tr&gt;"</span>;
00491                                 echo <span class="stringliteral">"&lt;td&gt;Log output produced by GRAMM&lt;/td&gt;"</span>; 
00492                                 echo <span class="stringliteral">"&lt;td colspan=\"4\"&gt;&lt;a href=./$file&gt;$file&lt;/a&gt;&lt;/td&gt;"</span>;
00493                                 echo <span class="stringliteral">"&lt;/tr&gt;"</span>;   
00494                         }
00495         }
00496         
00497         $dir-&gt;rewind();
00498         <span class="keywordflow">while</span> ($file = $dir-&gt;read())
00499         {
00500                 <span class="keywordflow">if</span> ( $file==<span class="stringliteral">"rpar.gr"</span> )
00501                         {
00502                                 echo <span class="stringliteral">"&lt;tr&gt;"</span>;
00503                                 echo <span class="stringliteral">"&lt;td&gt;Parameters used for the docking procedure&lt;/td&gt;"</span>; 
00504                                 echo <span class="stringliteral">"&lt;td colspan=\"4\"&gt;&lt;a href=./$file&gt;$file&lt;/a&gt;&lt;/td&gt;"</span>;
00505                                 echo <span class="stringliteral">"&lt;/tr&gt;"</span>;   
00506                         }
00507         }
00508         
00509         $dir-&gt;rewind();
00510         <span class="keywordflow">while</span> ($file = $dir-&gt;read())
00511         {
00512                 <span class="keywordflow">if</span> ( $file==<span class="stringliteral">"rmol.gr"</span> )
00513                         {
00514                                 echo <span class="stringliteral">"&lt;tr&gt;"</span>;
00515                                 echo <span class="stringliteral">"&lt;td&gt;Description of the molecules.&lt;/td&gt;"</span>; 
00516                                 echo <span class="stringliteral">"&lt;td colspan=\"4\"&gt;&lt;a href=./$file&gt;$file&lt;/a&gt;&lt;/td&gt;"</span>;
00517                                 echo <span class="stringliteral">"&lt;/tr&gt;"</span>;   
00518                         }
00519         }
00520         
00521         $dir-&gt;rewind();
00522         <span class="keywordflow">while</span> ($file = $dir-&gt;read())
00523         {
00524                 <span class="keywordflow">if</span> ( $file==<span class="stringliteral">"wlist.gr"</span> )
00525                         {
00526                                 echo <span class="stringliteral">"&lt;tr&gt;"</span>;
00527                                 echo <span class="stringliteral">"&lt;td&gt;Config file to set the results&lt;/td&gt;"</span>; 
00528                                 echo <span class="stringliteral">"&lt;td colspan=\"4\"&gt;&lt;a href=./$file&gt;$file&lt;/a&gt;&lt;/td&gt;"</span>;
00529                                 echo <span class="stringliteral">"&lt;/tr&gt;"</span>;   
00530                         }
00531         }
00532         
00533         $dir-&gt;close();
00534         echo <span class="stringliteral">"&lt;/table&gt;&lt;/center&gt;"</span>;       
00535         echo <span class="stringliteral">"&lt;hr&gt;"</span>;
00536 }
00537 
00538 ?&gt;
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Nov 17 12:24:37 2004 for GridGRAMM by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
