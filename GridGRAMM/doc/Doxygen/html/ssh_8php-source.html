<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GridGRAMM: ssh.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>ssh.php</h1><a href="ssh_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 &lt;?php
00002 
<a name="l00003"></a><a class="code" href="classSExec.html">00003</a> <span class="keyword">class </span><a class="code" href="classSExec.html">SExec</a> {
00004 
<a name="l00005"></a><a class="code" href="classSExec.html#o0">00005</a>     var <a class="code" href="classSExec.html#o0">$version</a>=<span class="stringliteral">"1.0"</span>;
<a name="l00006"></a><a class="code" href="classSExec.html#o1">00006</a>     var <a class="code" href="classSExec.html#o1">$remote</a>;
<a name="l00007"></a><a class="code" href="classSExec.html#o2">00007</a>     var <a class="code" href="classSExec.html#o2">$password</a>;
00008 
<a name="l00009"></a><a class="code" href="classSExec.html#o3">00009</a>     <a class="code" href="classSExec.html#o3">$ssh</a> = <span class="stringliteral">"/usr/bin/ssh"</span>;
<a name="l00010"></a><a class="code" href="classSExec.html#o4">00010</a>     <a class="code" href="classSExec.html#o4">$scp</a> = <span class="stringliteral">"/usr/bin/scp"</span>;
00011     
<a name="l00012"></a><a class="code" href="classSExec.html#a0">00012</a>     function <a class="code" href="classSExec.html#a0">SExec</a>($remote=<span class="stringliteral">"localhost"</span>, $password=<span class="stringliteral">"xxyzzy"</span>)
00013     {
00014         $this-&gt;remote = <a class="code" href="classSExec.html#o1">$remote</a>;
00015         $this-&gt;password = <span class="stringliteral">"$password"</span>;
00016     }
00017     
<a name="l00018"></a><a class="code" href="classSExec.html#a1">00018</a>     function <a class="code" href="classSExec.html#a1">set_remote_end</a>($remote, $password=<span class="stringliteral">"xxyzzy"</span>)
00019     {
00020         $this-&gt;remote = <a class="code" href="classSExec.html#o1">$remote</a>;
00021         $this-&gt;password = <a class="code" href="classSExec.html#o2">$password</a>;
00022     }
00023     
00024     <span class="comment"></span>
00025 <span class="comment">    /**</span>
00026 <span class="comment">     *  Execute a single command remotely using ssh and </span>
00027 <span class="comment">     * display its output, optionally returning its exit </span>
00028 <span class="comment">     * status (like passthru)</span>
00029 <span class="comment">     *</span>
00030 <span class="comment">     *  This function is intended to be used as a one-time</span>
00031 <span class="comment">     * all-at-once non-interactive execution mechanism which</span>
00032 <span class="comment">     * will run the command remotely and display its output.</span>
00033 <span class="comment">     *</span>
00034 <span class="comment">     *  If you try to issue an interactive command using this</span>
00035 <span class="comment">     * function, all you will get is unneccessary trouble. So</span>
00036 <span class="comment">     * don't!</span>
00037 <span class="comment">     *</span>
00038 <span class="comment">     *  This might be done as well using a pipe on /tmp and</span>
00039 <span class="comment">     * making the command 'cat' the pipe: when ssh runs, it</span>
00040 <span class="comment">     * runs the command 'cat' on the pipe and hangs on read.</span>
00041 <span class="comment">     *  Then we just need a thread to open the pipe, put the</span>
00042 <span class="comment">     * password and close the pipe.</span>
00043 <span class="comment">     *  This other way the password is never wirtten down.</span>
00044 <span class="comment">     * But, OTOH, the file life is so ephemeral that most</span>
00045 <span class="comment">     * of the time it will only exist in the internal system</span>
00046 <span class="comment">     * cache, so this approach is not that bad either.</span>
00047 <span class="comment">     *</span>
00048 <span class="comment">     *  @param remote   The remote end to run the command, in</span>
00049 <span class="comment">     *                      the form 'user@host:port' (you may</span>
00050 <span class="comment">     *                      omit the 'user@' or ':port' parts</span>
00051 <span class="comment">     *                      if the default values [i.e. same user</span>
00052 <span class="comment">     *                      or standard port] are OK).</span>
00053 <span class="comment">     *  @param password The remote password. Note that if direct</span>
00054 <span class="comment">     *                      RSA/DSA/.shosts/.rhosts login is enabled</span>
00055 <span class="comment">     *                      then the password should be ignored as</span>
00056 <span class="comment">     *                      SSH should not run the ASKPASS command).</span>
00057 <span class="comment">     *  @param command  The command to execute on the remote end</span>
00058 <span class="comment">     *                      NOTE: if you want to use redirection, the</span>
00059 <span class="comment">     *                      entire remote command line should be </span>
00060 <span class="comment">     *                      enclosed in additional quotes!</span>
00061 <span class="comment">     *  @param status   Optional, this will hold the termination</span>
00062 <span class="comment">     *                      status of SSH after invocation, which</span>
00063 <span class="comment">     *                      should be the exit status of the remote</span>
00064 <span class="comment">     *                      command or 255 if an error occurred</span>
00065 <span class="comment">     *  @return void</span>
00066 <span class="comment">     */</span>
<a name="l00067"></a><a class="code" href="classSExec.html#a2">00067</a>     function <a class="code" href="classSExec.html#a2">ssh_passthru</a>($remote, $password, $command, &amp;$status)
00068     {
00069         global <a class="code" href="grid__test_8php.html#a0">$debug</a>;
00070 
00071         <span class="comment">// Setup environment</span>
00072         umask(0077);
00073         $tmpfname = tempnam('/tmp', 'phpSsh-');
00074         chmod($tmpfname, 0700);
00075         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug</a>) echo $tmpfname.<span class="stringliteral">"\n"</span>;
00076         
00077         putenv(<span class="stringliteral">"DISPLAY=none:0."</span>);
00078         putenv(<span class="stringliteral">"SSH_ASKPASS=$tmpfname"</span>);
00079 
00080         <span class="comment">// make askpass command</span>
00081         $fp = fopen($tmpfname, <span class="stringliteral">"w"</span>);
00082         fputs($fp, <span class="stringliteral">"#!/bin/sh\necho $password\n"</span>);
00083         fputs($fp, <span class="stringliteral">"rm -f $tmpfname\n"</span>);
00084         fclose($fp);
00085         <span class="comment">// go</span>
00086         <span class="keywordflow">if</span> (isset($status))
00087             passthru(<span class="stringliteral">"$ssh -x -t -t $remote $command"</span>, $status);
00088         <span class="keywordflow">else</span>
00089             passthru(<span class="stringliteral">"$ssh -x -t -t $remote $command"</span>);
00090     }
00091     
00092     <span class="comment"></span>
00093 <span class="comment">    /**</span>
00094 <span class="comment">     *  Execute a remote command using SSH</span>
00095 <span class="comment">     *</span>
00096 <span class="comment">     *  This function sort of mimics rexec(3) using SSH as the transport</span>
00097 <span class="comment">     * protocol.</span>
00098 <span class="comment">     *</span>
00099 <span class="comment">     *  The function returns the exit status of the remote command, and</span>
00100 <span class="comment">     * appends the remote job output to an optional argument.</span>
00101 <span class="comment">     *</span>
00102 <span class="comment">     *  This function is intended to be used as a one-time</span>
00103 <span class="comment">     * all-at-once non-interactive execution mechanism which</span>
00104 <span class="comment">     * will run the command remotely and return its output.</span>
00105 <span class="comment">     *</span>
00106 <span class="comment">     *  If you try to issue an interactive command using this</span>
00107 <span class="comment">     * function, all you will get is unneccessary trouble. So</span>
00108 <span class="comment">     * don't!</span>
00109 <span class="comment">     *</span>
00110 <span class="comment">     *  @param remote   The remote end to run the command, in</span>
00111 <span class="comment">     *                      the form 'user@host:port' (you may</span>
00112 <span class="comment">     *                      omit the 'user@' or ':port' parts</span>
00113 <span class="comment">     *                      if the default values [i.e. same user</span>
00114 <span class="comment">     *                      or standard port] are OK).</span>
00115 <span class="comment">     *  @param password The remote password. Note that if direct</span>
00116 <span class="comment">     *                      RSA/DSA/.shosts/.rhosts login is enabled</span>
00117 <span class="comment">     *                      then the password should be ignored as</span>
00118 <span class="comment">     *                      SSH should not run the ASKPASS command).</span>
00119 <span class="comment">     *  @param command  The command to execute on the remote end</span>
00120 <span class="comment">     *                      NOTE: if you want to use redirection, the</span>
00121 <span class="comment">     *                      entire remote command line should be </span>
00122 <span class="comment">     *                      enclosed in additional quotes!</span>
00123 <span class="comment">     *  @param output   Optional, the collated (stdout+stderr) output </span>
00124 <span class="comment">     *                      of the remote command.</span>
00125 <span class="comment">     *  @return status  will hold the termination</span>
00126 <span class="comment">     *                      status of SSH after invocation, which</span>
00127 <span class="comment">     *                      should be the exit status of the remote</span>
00128 <span class="comment">     *                      command or 255 if an error occurred</span>
00129 <span class="comment">     */</span>
<a name="l00130"></a><a class="code" href="classSExec.html#a3">00130</a>     function <a class="code" href="classSExec.html#a3">ssh_exec</a>($remote, $password, $command, &amp;$out)
00131     {
00132         global <a class="code" href="grid__test_8php.html#a0">$debug</a>;
00133 
00134         umask(0077);
00135         $tmpfname = tempnam('/tmp', 'phpSsh');
00136         chmod($tmpfname, 0700);
00137         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug</a>) echo $tmpfname . <span class="stringliteral">"\n"</span>;
00138 
00139         putenv('DISPLAY=none:0.');
00140         putenv(<span class="stringliteral">"SSH_ASKPASS=$tmpfname"</span>);
00141         $fp = fopen($tmpfname, <span class="stringliteral">"w"</span>);
00142         fputs($fp, <span class="stringliteral">"#!/bin/sh\necho $password\n"</span>);
00143         fputs($fp, <span class="stringliteral">"rm -f $tmpfname\n"</span>);
00144         fclose($fp);
00145         exec(<span class="stringliteral">"$ssh -x -t -t $remote $command"</span>, $out, $retval);
00146         <span class="keywordflow">return</span> $retval;
00147 
00148     }
00149     <span class="comment"></span>
00150 <span class="comment">    /**</span>
00151 <span class="comment">     *  Copy a file or directory from one source to a destination</span>
00152 <span class="comment">     *</span>
00153 <span class="comment">     *  This function copies source to dest, where one of them is a</span>
00154 <span class="comment">     * local filespec and the other a remote filespec of the form</span>
00155 <span class="comment">     * [user@]host:path</span>
00156 <span class="comment">     *</span>
00157 <span class="comment">     *  If the original source is a directory, it will be copied</span>
00158 <span class="comment">     * recursively to destination (hence easing file transfers).</span>
00159 <span class="comment">     *</span>
00160 <span class="comment">     *  The function returns TRUE on success or FALSE on failure.</span>
00161 <span class="comment">     *</span>
00162 <span class="comment">     *  @param origin   The origin path, of the form</span>
00163 <span class="comment">     *                  [user@][host][:port]path</span>
00164 <span class="comment">     *                  You may omit the optional sections if</span>
00165 <span class="comment">     *                  the default values (local username, local</span>
00166 <span class="comment">     *                  host, standard SSH port) are OK</span>
00167 <span class="comment">     *</span>
00168 <span class="comment">     *  @param destination      The destination path, of the form</span>
00169 <span class="comment">     *                  [user@][host][:port:]path</span>
00170 <span class="comment">     *                  You may omit the optional sections if</span>
00171 <span class="comment">     *                  the default values (local username, local</span>
00172 <span class="comment">     *                  host, standard SSH port) are OK</span>
00173 <span class="comment">     *</span>
00174 <span class="comment">     *  @parm password  The password to use to connect to the remote</span>
00175 <span class="comment">     *                  end of the copy (be it the origin or the</span>
00176 <span class="comment">     *                  destination, it's all the same). If connection</span>
00177 <span class="comment">     *                  is automatic by some means (.shosts or RSA/DSA</span>
00178 <span class="comment">     *                  authentication) then it should be ignored and</span>
00179 <span class="comment">     *                  any password should do.</span>
00180 <span class="comment">     *</span>
00181 <span class="comment">     *  @return status  TRUE if all went well, or FALSE on failure.</span>
00182 <span class="comment">     */</span>
<a name="l00183"></a><a class="code" href="classSExec.html#a4">00183</a>     function <a class="code" href="classSExec.html#a4">ssh_copy</a>($origin, $destination, $password)
00184     {
00185         global <a class="code" href="grid__test_8php.html#a0">$debug</a>;
00186 
00187         umask(0077);
00188         $tmpfname = tempnam(<span class="stringliteral">"/tmp"</span>, <span class="stringliteral">"phpSsh"</span>);
00189         chmod($tmpfname, 0700);
00190         putenv(<span class="stringliteral">"DISPLAY=none:0."</span>);
00191         putenv(<span class="stringliteral">"SSH_ASKPASS=$tmpfname"</span>);
00192         $fp = fopen($tmpfname, <span class="stringliteral">"w"</span>);
00193         fputs($fp, <span class="stringliteral">"#!/bin/sh\necho $password\n"</span>);
00194         fputs($fp, <span class="stringliteral">"rm $tmpfname\n"</span>);
00195         fclose($fp);
00196         exec(<span class="stringliteral">"$scp -pqrC $origin $destination"</span>, $out, $status);
00197         <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a> == 0)
00198             <span class="keywordflow">return</span> TRUE;
00199         <span class="keywordflow">else</span>
00200             <span class="keywordflow">return</span> FALSE;
00201     }
00202 <span class="comment"></span>
00203 <span class="comment">    /**</span>
00204 <span class="comment">     *  Open an SSH connection to a remote site with a shell to run </span>
00205 <span class="comment">     * interactive commands</span>
00206 <span class="comment">     *</span>
00207 <span class="comment">     *  Connects to a remote host and opens an interactive shell session</span>
00208 <span class="comment">     * with NO controlling terminal.</span>
00209 <span class="comment">     *</span>
00210 <span class="comment">     *  Returns a process_control array which contains the process resource</span>
00211 <span class="comment">     * ID and an the standard file descriptors which the caller may use to</span>
00212 <span class="comment">     * interact with the remote shell.</span>
00213 <span class="comment">     *</span>
00214 <span class="comment">     *  @param remote   The remote end to run the shell, in</span>
00215 <span class="comment">     *                      the form 'user@host:port' (you may</span>
00216 <span class="comment">     *                      omit the 'user@' or ':port' parts</span>
00217 <span class="comment">     *                      if the default values [i.e. same user</span>
00218 <span class="comment">     *                      or standard port] are OK).</span>
00219 <span class="comment">     *  @param password The remote password. Note that if direct</span>
00220 <span class="comment">     *                      RSA/DSA/.shosts/.rhosts login is enabled</span>
00221 <span class="comment">     *                      then the password should be ignored as</span>
00222 <span class="comment">     *                      SSH should not run the ASKPASS command).</span>
00223 <span class="comment">     */</span>
<a name="l00224"></a><a class="code" href="classSExec.html#a5">00224</a>     function <a class="code" href="classSExec.html#a5">ssh_open_shell</a>($remote, $password)
00225     {   
00226         global <a class="code" href="grid__test_8php.html#a0">$debug</a>;
00227 
00228         <span class="comment">// Open a child process with the 'proc_open' function. </span>
00229         <span class="comment">//</span>
00230         <span class="comment">// Some tricks: we must open the connection using '-x' to disable</span>
00231         <span class="comment">// X11 forwarding, and use '-t -t' to avoid SSH generating an error</span>
00232         <span class="comment">// because we are not connected to any terminal.</span>
00233         <span class="comment">//</span>
00234         <span class="comment">// NOTE: if the web server is trusted remotely (i.e. it's SSH public </span>
00235         <span class="comment">// key is accepted in ~user@host:.ssh/authorized_keys) then any </span>
00236         <span class="comment">// password will do.</span>
00237 
00238         <span class="comment">// Prepare I/O</span>
00239         $descriptorspec = array(
00240             0 =&gt; array(<span class="stringliteral">"pipe"</span>, <span class="stringliteral">"r"</span>),  <span class="comment">// connect child's stdin to the read end of a pipe</span>
00241             1 =&gt; array(<span class="stringliteral">"pipe"</span>, <span class="stringliteral">"a"</span>),  <span class="comment">// connect child's stdout to the write end of a pipe</span>
00242             2 =&gt; array(<span class="stringliteral">"pipe"</span>, <span class="stringliteral">"a"</span>)   <span class="comment">// stderr is a pipe to read from</span>
00243         );
00244 
00245         <span class="comment">// prepare password</span>
00246         umask(0077);
00247         $tmpfname = tempnam(<span class="stringliteral">"/tmp"</span>, <span class="stringliteral">"phpSsh"</span>);
00248         chmod($tmpfname, 0700);
00249         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug</a>) echo $tmpfname . <span class="stringliteral">"\n"</span>;
00250 
00251         putenv(<span class="stringliteral">"DISPLAY=none:0."</span>);
00252         putenv(<span class="stringliteral">"SSH_ASKPASS=$tmpfname"</span>);
00253         $fp = fopen($tmpfname, <span class="stringliteral">"w"</span>);
00254         fputs($fp, <span class="stringliteral">"#!/bin/sh\necho $password\n"</span>);
00255         fputs($fp, <span class="stringliteral">"rm $tmpfname\n"</span>);
00256         fclose($fp);
00257 
00258         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug</a>) echo <span class="stringliteral">"$ssh -x -t -t $remote&lt;br /&gt;\n"</span>;
00259         $process = proc_open(<span class="stringliteral">"$ssh -x -t -t $remote"</span>, 
00260                          $descriptorspec,
00261                          $pipes);
00262         
00263         <span class="comment">// check status</span>
00264         <span class="keywordflow">if</span> (!is_resource($process)) 
00265         {
00266             letal(<span class="stringliteral">"SSH::connect"</span>, <span class="stringliteral">"cannot connect to the remote host"</span>);
00267             <span class="keywordflow">return</span>;
00268         }
00269         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug</a>) echo <span class="stringliteral">"proc_open done&lt;br /&gt;\n"</span>;
00270 
00271         <span class="comment">// $pipes now looks like this:</span>
00272         <span class="comment">//   0 =&gt; writeable handle connected to child stdin</span>
00273         <span class="comment">//   1 =&gt; readable handle connected to child stdout</span>
00274         <span class="comment">//   2 =&gt; readable handle connected to child stderr</span>
00275         
00276         <span class="comment">// Should we leave this to the user?</span>
00277         <span class="comment">// set to non-blocking and avoid having to call fflush</span>
00278         stream_set_blocking($pipes[0], FALSE);
00279         stream_set_blocking($pipes[1], FALSE);
00280         stream_set_blocking($pipes[2], FALSE);
00281         stream_set_write_buffer($pipes[0], 0);
00282         stream_set_write_buffer($pipes[1], 0);
00283         stream_set_write_buffer($pipes[2], 0);
00284 
00285         <span class="comment">// We now have a connection to the remote SSH</span>
00286         <span class="comment">// Server which we may use to send commands/receive output</span>
00287         $p = array('process' =&gt; $process
00288                     ,'std_in' =&gt; $pipes[0]
00289                     ,'std_out' =&gt; $pipes[1]
00290                     ,'std_err' =&gt; $pipes[2] 
00291                    );
00292         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug</a>)  {
00293             echo <span class="stringliteral">"process descriptor array is \n"</span>;
00294             print_r($p);
00295             <span class="comment">/*</span>
00296 <span class="comment">            fwrite($p['std_in'], "\n");</span>
00297 <span class="comment">            fwrite($p['std_in'], "touch touche\n");</span>
00298 <span class="comment">            fwrite($p['std_in'], "logout\n");</span>
00299 <span class="comment">            fflush($p['std_in']);</span>
00300 <span class="comment">            fclose($p['std_in']); fclose($p['std_out']); fclose($p['std_err']);</span>
00301 <span class="comment">            echo "pipes closed\n";</span>
00302 <span class="comment">            proc_close($p['process']);</span>
00303 <span class="comment">            echo "process closed\n";</span>
00304 <span class="comment">        } </span>
00305 <span class="comment">        if ($debug == "CHANGE ME") {</span>
00306 <span class="comment">            echo "process "; print_r($process); echo "\n";</span>
00307 <span class="comment">            echo "p-&gt;process "; print_r($p['process']); echo "\n";</span>
00308 <span class="comment">            fwrite($pipes[0], "touch touche\n");</span>
00309 <span class="comment">            fwrite($pipes[0], "logout\n");</span>
00310 <span class="comment">            fflush($pipes[0]);</span>
00311 <span class="comment">            fclose($pipes[0]); fclose($pipes[1]); fclose($pipes[2]);</span>
00312 <span class="comment">            proc_close($process);</span>
00313 <span class="comment">            */</span>
00314         }
00315         <span class="keywordflow">return</span> $p;
00316     }
00317     <span class="comment"></span>
00318 <span class="comment">    /**</span>
00319 <span class="comment">     *  Open an SSH connection to run an interactive command on a remote</span>
00320 <span class="comment">     * site</span>
00321 <span class="comment">     *</span>
00322 <span class="comment">     *  Connects to a remote host and runs an interactive command</span>
00323 <span class="comment">     * with NO controlling terminal.</span>
00324 <span class="comment">     *</span>
00325 <span class="comment">     *  Returns a process_control array which contains the process resource</span>
00326 <span class="comment">     * ID and an the standard file descriptors which the caller may use to</span>
00327 <span class="comment">     * interact with the remote shell.</span>
00328 <span class="comment">     */</span>
<a name="l00329"></a><a class="code" href="classSExec.html#a6">00329</a>     function <a class="code" href="classSExec.html#a6">ssh_open_command</a>($remote, $password, $command)
00330     {   
00331         global <a class="code" href="grid__test_8php.html#a0">$debug</a>;
00332 
00333         <span class="comment">// Open a child process with the 'proc_open' function. </span>
00334         <span class="comment">//</span>
00335         <span class="comment">// Some tricks: we must open the connection using '-x' to disable</span>
00336         <span class="comment">// X11 forwarding, and use '-t -t' to avoid SSH generating an error</span>
00337         <span class="comment">// because we are not connected to any terminal.</span>
00338         <span class="comment">//</span>
00339         <span class="comment">// NOTE: if the web server is trusted remotely (i.e. it's SSH public </span>
00340         <span class="comment">// key is accepted in ~user@host:.ssh/authorized_keys) then any </span>
00341         <span class="comment">// password will do.</span>
00342 
00343         <span class="comment">// Prepare I/O</span>
00344         umask(0077);
00345         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug</a>) {
00346             $child_stdout = tempnam(<span class="stringliteral">"/tmp"</span>, <span class="stringliteral">"phpSsh-"</span>.getmypid().<span class="stringliteral">"-1-"</span>);
00347             $child_stderr = tempnam(<span class="stringliteral">"/tmp"</span>, <span class="stringliteral">"phpSsh-"</span>.getmypid().<span class="stringliteral">"-2-"</span>);
00348         } <span class="keywordflow">else</span> {
00349             $child_stdout = tempnam(<span class="stringliteral">"/tmp"</span>, <span class="stringliteral">"phpSsh-"</span>);
00350             $child_stderr = tempnam(<span class="stringliteral">"/tmp"</span>, <span class="stringliteral">"phpSsh-"</span>);
00351         }
00352         $descriptorspec = array(
00353             0 =&gt; array(<span class="stringliteral">"pipe"</span>, <span class="stringliteral">"r"</span>),  <span class="comment">// connect child's stdin to the read end of a pipe</span>
00354             1 =&gt; array(<span class="stringliteral">"pipe"</span>, <span class="stringliteral">"a"</span>),  <span class="comment">// connect child's stdout to the write end of a pipe</span>
00355             2 =&gt; array(<span class="stringliteral">"pipe"</span>, <span class="stringliteral">"a"</span>)   <span class="comment">// stderr is a pipe to read from</span>
00356             #1 =&gt; array(<span class="stringliteral">"file"</span>, $child_stdout, <span class="stringliteral">"a"</span>),
00357             #2 =&gt; array(<span class="stringliteral">"file"</span>, $child_stderr, <span class="stringliteral">"a"</span>)
00358         );
00359 
00360         <span class="comment">// prepare password</span>
00361         umask(0077);
00362         $tmpfname = tempnam(<span class="stringliteral">"/tmp"</span>, <span class="stringliteral">"phpSsh-"</span>);
00363         chmod($tmpfname, 0700);
00364         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug</a>) echo $tmpfname . <span class="stringliteral">"\n"</span>;
00365 
00366         putenv(<span class="stringliteral">"DISPLAY=none:0."</span>);
00367         putenv(<span class="stringliteral">"SSH_ASKPASS=$tmpfname"</span>);
00368         $fp = fopen($tmpfname, <span class="stringliteral">"w"</span>);
00369         fputs($fp, <span class="stringliteral">"#!/bin/sh\necho $password\n"</span>);
00370         fputs($fp, <span class="stringliteral">"rm $tmpfname\n"</span>);
00371         fclose($fp);
00372 
00373         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug</a>) echo <span class="stringliteral">"$ssh -x -t -t $remote $command&lt;br /&gt;\n"</span>;
00374         $process = proc_open(<span class="stringliteral">"$ssh -x -t -t $remote $command"</span>, 
00375                          $descriptorspec,
00376                          $pipes);
00377         
00378         <span class="comment">// check status</span>
00379         <span class="keywordflow">if</span> (!is_resource($process)) 
00380         {
00381             letal(<span class="stringliteral">"SSH::connect"</span>, <span class="stringliteral">"cannot connect to the remote host"</span>);
00382             <span class="keywordflow">return</span>;
00383         }
00384         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug</a>) echo <span class="stringliteral">"proc_open done&lt;br /&gt;\n"</span>;
00385 
00386         <span class="comment">// $pipes now looks like this:</span>
00387         <span class="comment">//   0 =&gt; writeable handle connected to child stdin</span>
00388         <span class="comment">//   1 =&gt; readable handle connected to child stdout</span>
00389         <span class="comment">//   2 =&gt; readable handle connected to child stderr</span>
00390         
00391         <span class="comment">// Should we leave this to the user?</span>
00392         <span class="comment">// set to non-blocking and avoid having to call fflush</span>
00393         stream_set_blocking($pipes[0], FALSE);
00394         stream_set_blocking($pipes[1], FALSE);
00395 <span class="preprocessor">        #stream_set_blocking($pipes[2], FALSE);</span>
00396 <span class="preprocessor"></span>        stream_set_write_buffer($pipes[0], 0);
00397         stream_set_write_buffer($pipes[1], 0);
00398 <span class="preprocessor">        #stream_set_write_buffer($pipes[2], 0);</span>
00399 <span class="preprocessor"></span>
00400         <span class="comment">// We now have a connection to the remote SSH</span>
00401         <span class="comment">// Server which we may use to send commands/receive output</span>
00402         $p = array('process' =&gt; $process
00403                     ,'std_in' =&gt; $pipes[0]
00404                     ,'std_out' =&gt; $pipes[1]
00405                     ,'std_err' =&gt; $pipes[2] 
00406                    );
00407         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug</a>)  {
00408             echo <span class="stringliteral">"process descriptor array is \n"</span>;
00409             print_r($p);
00410         }
00411         <span class="keywordflow">return</span> $p;
00412     }
00413 <span class="comment"></span>
00414 <span class="comment">    /**</span>
00415 <span class="comment">     * Close an SSH interactive session</span>
00416 <span class="comment">     */</span>
<a name="l00417"></a><a class="code" href="classSExec.html#a7">00417</a>     function <a class="code" href="classSExec.html#a7">ssh_close</a>($p)
00418     {
00419         global <a class="code" href="grid__test_8php.html#a0">$debug</a>;
00420         
00421             fwrite($p['std_in'], <span class="stringliteral">"\n"</span>);
00422             fwrite($p['std_in'], <span class="stringliteral">"logout\n"</span>);
00423             fflush($p['std_in']);
00424             fclose($p['std_in']); fclose($p['std_out']); fclose($p['std_err']);
00425             <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug</a>) echo <span class="stringliteral">"pipes closed\n"</span>;
00426             <span class="keywordflow">return</span> proc_close($p['process']);
00427             <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug</a>) echo <span class="stringliteral">"process closed\n"</span>;
00428     }
00429     
00430     <span class="keywordflow">if</span> ($php_version &gt;= 5)
00431     {<span class="comment"></span>
00432 <span class="comment">        /**</span>
00433 <span class="comment">         * send a signal to a running ssh_open_* process</span>
00434 <span class="comment">         */</span>
00435         function ssh_signal($p, $signal)
00436         {
00437             <span class="keywordflow">return</span> proc_terminate($p['process'], $signal);
00438         }<span class="comment"></span>
00439 <span class="comment">        /**</span>
00440 <span class="comment">         * get info about a running ssh_open_* process</span>
00441 <span class="comment">         */</span>
<a name="l00442"></a><a class="code" href="classSExec.html#a8">00442</a>         function <a class="code" href="classSExec.html#a8">ssh_get_status</a>($p)
00443         {
00444             <span class="keywordflow">return</span> proc_get_status($p['process']);
00445         }
00446     }
00447     <span class="comment"></span>
00448 <span class="comment">    /**</span>
00449 <span class="comment">     *  Execute a remore command and keep an unidirectional stream</span>
00450 <span class="comment">     * contact with it.</span>
00451 <span class="comment">     *</span>
00452 <span class="comment">     *  This routine mimics 'popen()' but uses ssh to connect to</span>
00453 <span class="comment">     * a remote host and run the requested command.</span>
00454 <span class="comment">     */</span>
<a name="l00455"></a><a class="code" href="classSExec.html#a9">00455</a>     function <a class="code" href="classSExec.html#a9">ssh_popen</a>($remote, $password, $command, $mode)
00456     {
00457         global <a class="code" href="grid__test_8php.html#a0">$debug</a>;
00458 
00459         <span class="comment">// Setup environment</span>
00460         umask(0077);
00461         $tmpfname = tempnam('/tmp', 'phpSsh-');
00462         chmod($tmpfname, 0700);
00463         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug</a>) echo $tmpfname.<span class="stringliteral">"\n"</span>;
00464         
00465         putenv(<span class="stringliteral">"DISPLAY=none:0."</span>);
00466         putenv(<span class="stringliteral">"SSH_ASKPASS=$tmpfname"</span>);
00467 
00468         <span class="comment">// make askpass command</span>
00469         $fp = fopen($tmpfname, <span class="stringliteral">"w"</span>);
00470         fputs($fp, <span class="stringliteral">"#!/bin/sh\necho $password\n"</span>);
00471         fputs($fp, <span class="stringliteral">"rm -f $tmpfname\n"</span>);
00472         fclose($fp);
00473         <span class="comment">// go</span>
00474         <span class="keywordflow">return</span> popen(<span class="stringliteral">"$ssh -x -t -t $remote $command"</span>, $mode);
00475     }
00476     
<a name="l00477"></a><a class="code" href="classSExec.html#a10">00477</a>     function <a class="code" href="classSExec.html#a10">ssh_pclose</a>($f)
00478     {
00479         <span class="keywordflow">return</span> pclose($f);
00480     }
00481 
00482 }
00483 
00484 ?&gt;
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue May 24 12:14:31 2005 for GridGRAMM by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6 </small></address>
</body>
</html>
