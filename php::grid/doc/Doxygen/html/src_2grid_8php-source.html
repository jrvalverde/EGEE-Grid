<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>php::Grid: grid.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>grid.php</h1><a href="src_2grid_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 &lt;?php<span class="comment"></span>
00002 <span class="comment">/**</span>
00003 <span class="comment"> * Submit jobs to the Grid through a UI-node</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * @author José R. Valverde &lt;jrvalverde@acm.org&gt;</span>
00006 <span class="comment"> * @version 2.6</span>
00007 <span class="comment"> * @copyright José R. Valverde &lt;jrvalverde@acm.org&gt;</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> * This library is free software; you can redistribute it and/or</span>
00010 <span class="comment"> * modify it under the terms of the GNU Lesser General Public</span>
00011 <span class="comment"> * License as published by the Free Software Foundation; either</span>
00012 <span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span>
00013 <span class="comment"> * </span>
00014 <span class="comment"> * This library is distributed in the hope that it will be useful,</span>
00015 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00016 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00017 <span class="comment"> * Lesser General Public License for more details.</span>
00018 <span class="comment"> * </span>
00019 <span class="comment"> * You should have received a copy of the GNU Lesser General Public</span>
00020 <span class="comment"> * License along with this library; if not, write to the Free Software</span>
00021 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> * @category    Net</span>
00024 <span class="comment"> * @package     Grid</span>
00025 <span class="comment"> * @author      José R. Valverde &lt;jrvalverde@acm.org&gt;</span>
00026 <span class="comment"> * @copyright   José R. Valverde &lt;jrvalverde@acm.org&gt;</span>
00027 <span class="comment"> * @license     ../doc/c/lgpl.txt</span>
00028 <span class="comment"> * @version     CVS: $Id: grid.php,v 1.4 2005/10/06 09:35:59 netadmin Exp $</span>
00029 <span class="comment"> * @link        http://savannah.cern.ch/projects/GridGRAMM</span>
00030 <span class="comment"> * @see         ssh.php</span>
00031 <span class="comment"> * @see         ../test/grid_test.php</span>
00032 <span class="comment"> * @since       File available since Release 1.0</span>
00033 <span class="comment"> */</span>
00034 <span class="comment"></span>
00035 <span class="comment">/** definition of default values */</span>
00036 include_once(<span class="stringliteral">"grid_config.php"</span>);<span class="comment"></span>
00037 <span class="comment">/** SExec class */</span>
00038 require_once(<span class="stringliteral">"ssh.php"</span>);<span class="comment"></span>
00039 <span class="comment">/** utility routines */</span>
00040 include_once(<span class="stringliteral">"util.php"</span>);
00041 <span class="comment"></span>
00042 <span class="comment">/**</span>
00043 <span class="comment"> *  Grid access class</span>
00044 <span class="comment"> *</span>
00045 <span class="comment"> *  This class allows you to connect to a remote Grid UI server and</span>
00046 <span class="comment"> *  launch and monitor jobs on it.</span>
00047 <span class="comment"> *</span>
00048 <span class="comment"> *  The reason for this class is mostly one of resilience: if you </span>
00049 <span class="comment"> *  put all your services directly on a GrUI host, then whenever </span>
00050 <span class="comment"> *  that host if offline, your services will be as well.</span>
00051 <span class="comment"> *</span>
00052 <span class="comment"> *  An alternative is to replicate the services on various GrUI nodes.</span>
00053 <span class="comment"> *</span>
00054 <span class="comment"> *  Or better yet: use this class and set up your services wherever</span>
00055 <span class="comment"> *  you want. You may put them on an HA system and ensure this way </span>
00056 <span class="comment"> *  their continuous availability. Your service will be always up</span>
00057 <span class="comment"> *  and running, ready to accept jobs.</span>
00058 <span class="comment"> *</span>
00059 <span class="comment"> *  Your next problem is dealing with the Grid UI. You still need</span>
00060 <span class="comment"> *  to log-in on a Grid access point to submit your jobs. But once</span>
00061 <span class="comment"> *  you have detached from a specific GrUI node, you are free to</span>
00062 <span class="comment"> *  attempt a connection to a given remote access point, and if it</span>
00063 <span class="comment"> *  is available (and while it is) submit jobs as needed. If at any</span>
00064 <span class="comment"> *  time it is not available, nothing is lost: just look for another</span>
00065 <span class="comment"> *  one and use this to continue working. You may thus enter the</span>
00066 <span class="comment"> *  grid through any door.</span>
00067 <span class="comment"> *</span>
00068 <span class="comment"> *  There is a side advantage too: with your services on a GrUI node</span>
00069 <span class="comment"> *  you can only launch jobs from it. With your services detached from</span>
00070 <span class="comment"> *  any given Grid door, you may use _any_ AND _as many_ as you want:</span>
00071 <span class="comment"> *  this means you may launch jobs using various GrUI nodes simultaneously</span>
00072 <span class="comment"> *  if you so wish. And even split the jobs througho various, separate </span>
00073 <span class="comment"> *  Grids if you feel like it, hence potentially increasing your </span>
00074 <span class="comment"> *  throughput and computing power, harnessing even more resources.</span>
00075 <span class="comment"> *</span>
00076 <span class="comment"> *  Detaching your jobs from the GrUI has one serious drawback though:</span>
00077 <span class="comment"> *  all your job information must travel from your service user interface</span>
00078 <span class="comment"> *  to the grid user interface through the Internet, which may be</span>
00079 <span class="comment"> *  potentially dangerous. We deal with this security issue using SSH</span>
00080 <span class="comment"> *  to handle all communications and provide encryption. As long as </span>
00081 <span class="comment"> *  you use strong passwords you may feel secure. Actually, it is as</span>
00082 <span class="comment"> *  weak (or strong) as working directly on the GrUI node: access to</span>
00083 <span class="comment"> *  it is still managed by standard password mechanisms and subject to</span>
00084 <span class="comment"> *  the same types of attacks. However, remember you now have an extra</span>
00085 <span class="comment"> *  system (the front-end) to maintain and secure. Please, be always</span>
00086 <span class="comment"> *  cautious with any server you use.</span>
00087 <span class="comment"> *</span>
00088 <span class="comment"> *  Sounds convincing? Then read ahead to learn how to use this class.</span>
00089 <span class="comment"> *</span>
00090 <span class="comment"> *  &lt;b&gt;PERSISTENT vs. DISCONNECTED MODE&lt;/b&gt;</span>
00091 <span class="comment"> *</span>
00092 <span class="comment"> *  As of release 2.0, this distinction is no longer meaningful. We now</span>
00093 <span class="comment"> * use a new SExec class that multiplexes disconnected commands over a</span>
00094 <span class="comment"> * single sahred channel, thus providing all the advantages of both,</span>
00095 <span class="comment"> * connected and disconnected modes. We now provide a single set of</span>
00096 <span class="comment"> * methods.</span>
00097 <span class="comment"> *</span>
00098 <span class="comment"> *  &lt;b&gt;JOB MANAGEMENT&lt;/b&gt;</span>
00099 <span class="comment"> *</span>
00100 <span class="comment"> *  In order to submit your jobs to the grid you need to understand how</span>
00101 <span class="comment"> *  job management has been defined for this class. On the command line</span>
00102 <span class="comment"> *  you would have a lot more versatility, but to make this class more</span>
00103 <span class="comment"> *  useful some compromises had to be reached. We have defined a strict</span>
00104 <span class="comment"> *  protocol to generate/prepare your jobs before submitting them to</span>
00105 <span class="comment"> *  the grid, and you must stick to it if you want to avoid problems.</span>
00106 <span class="comment"> *</span>
00107 <span class="comment"> *  To understand why this has been designed the way it is, you should</span>
00108 <span class="comment"> *  keep in mind that you will be preparing your jobs on one (or many)</span>
00109 <span class="comment"> *  front-end and submitting them from it to one (or many) GrUI nodes.</span>
00110 <span class="comment"> *  Further to it, this has been designed to make it easy to deploy</span>
00111 <span class="comment"> *  web-based services for users. Therefore many similar jobs might</span>
00112 <span class="comment"> *  be launched simultaneously and we need some way to avoid collusion</span>
00113 <span class="comment"> *  among them. To avoid one job stepping over other we must isolate</span>
00114 <span class="comment"> *  every one from each other. This means providing an isolated environment</span>
00115 <span class="comment"> *  for every job.</span>
00116 <span class="comment"> *</span>
00117 <span class="comment"> *  The easiest way to achieve our goal is to have every job submitted</span>
00118 <span class="comment"> *  placed on an independent directory (which we pair to the job name). </span>
00119 <span class="comment"> *  For single jobs, this means that you should make sure that no two </span>
00120 <span class="comment"> *  potentially simultaneous/overlapping jobs have the same name (i.e. </span>
00121 <span class="comment"> *  are stored in the same directory so there is no risk one overwrites</span>
00122 <span class="comment"> *  files of the other).</span>
00123 <span class="comment"> *</span>
00124 <span class="comment"> *  Sometimes this may result inconvenient to you. E.g. if your whole job</span>
00125 <span class="comment"> *  is submitted split into many separate sub-jobs (which each is a separate</span>
00126 <span class="comment"> *  job from the point of view of the grid) you may want to follow some</span>
00127 <span class="comment"> *  naming convention for your sub-jobs that makes it easier to identify</span>
00128 <span class="comment"> *  and keep track of them. In this case, if you had two simultaneous</span>
00129 <span class="comment"> *  runs, then the names would collide.</span>
00130 <span class="comment"> *</span>
00131 <span class="comment"> *  For example, let's say you are rendering frames of a movie and want</span>
00132 <span class="comment"> *  to identify each job by frame number: 0000, 0001, 0002, 0003... If</span>
00133 <span class="comment"> *  you now try to generate a second movie while the first is being</span>
00134 <span class="comment"> *  processed, then the frames of the second movie (named as well 0000,</span>
00135 <span class="comment"> *  0001, etc...) would overwrite the frames of the first one.</span>
00136 <span class="comment"> *  Generating random names for each frame would be an option, but too</span>
00137 <span class="comment"> *  cumbersome and expensive as you would need to keep track of the</span>
00138 <span class="comment"> *  association of the random names with the actual frames.</span>
00139 <span class="comment"> *</span>
00140 <span class="comment"> *  To deal with this scenario we define 'sessions'. A session is identified</span>
00141 <span class="comment"> *  by a unique identifier, and guarantees that all jobs belonging to this</span>
00142 <span class="comment"> *  session are kept separate from similarly named jobs from other sessions.</span>
00143 <span class="comment"> *</span>
00144 <span class="comment"> *  Actually when you create a session, what we actually do is create</span>
00145 <span class="comment"> *  a subdirectory in the GrUI and direct all further jobs to this </span>
00146 <span class="comment"> *  subdirectory. This way, jobs of two sessions may have the same name</span>
00147 <span class="comment"> *  and not step into each other.</span>
00148 <span class="comment"> *</span>
00149 <span class="comment"> *  &lt;b&gt;PREPARING JOBS FOR THE GRID&lt;/b&gt;</span>
00150 <span class="comment"> *</span>
00151 <span class="comment"> *  To prepare a job for the grid you must assign it a name. The same</span>
00152 <span class="comment"> *  preacutions that apply to any local job hold for your grid work too:</span>
00153 <span class="comment"> *  if various simultaneous jobs of the same kind may be run, then each</span>
00154 <span class="comment"> *  must be kept separate from the others by using a different name.</span>
00155 <span class="comment"> *</span>
00156 <span class="comment"> *  Once you have decided the name, you must create a directory locally</span>
00157 <span class="comment"> *  with the same name as your job. In this directory you must install</span>
00158 <span class="comment"> *  everything needed to run your job: executables, libraries, input</span>
00159 <span class="comment"> *  data and a JDL file.</span>
00160 <span class="comment"> *</span>
00161 <span class="comment"> *  The JDL file defines the work that we will ask the grid to carry</span>
00162 <span class="comment"> *  out. Since each single job gets its own directory, you will only</span>
00163 <span class="comment"> *  submit one JDL file for each, and to make processing easier, we</span>
00164 <span class="comment"> *  request that this JDL file have a fixed name: "job.jdl".</span>
00165 <span class="comment"> *</span>
00166 <span class="comment"> *  The grid processing will generate various auxiliary files, for internal</span>
00167 <span class="comment"> *  housekeeping. Again, for simplicity, we have chosen to call each of</span>
00168 <span class="comment"> *  them 'job.*', i.e. 'job.' something. This means that other than 'job.jdl'</span>
00169 <span class="comment"> *  you should NOT create any file named job.anything on your job directory</span>
00170 <span class="comment"> *  to avoid collusion with possible temporary files.</span>
00171 <span class="comment"> *</span>
00172 <span class="comment"> *  In brief, to prepare a job:</span>
00173 <span class="comment"> *  - select a name</span>
00174 <span class="comment"> *  - create a directory named after the job</span>
00175 <span class="comment"> *  - populate this directory with all files needed to run your job</span>
00176 <span class="comment"> *  - generate the file 'job.jdl' with the description of the work to</span>
00177 <span class="comment"> *    be carried out by the grid</span>
00178 <span class="comment"> *  - avoid having files named 'job.*' (starting with 'job.')</span>
00179 <span class="comment"> *</span>
00180 <span class="comment"> *  &lt;b&gt;SUBMITTING JOBS TO THE GRID&lt;/b&gt;</span>
00181 <span class="comment"> *</span>
00182 <span class="comment"> *  First consider whether you will be using unique job names or if</span>
00183 <span class="comment"> *  you will follow a convenient naming convention that may cause name</span>
00184 <span class="comment"> *  collisions with other jobs.</span>
00185 <span class="comment"> *</span>
00186 <span class="comment"> *  If you feel pretty safe that the job name is unique (e.g. has been</span>
00187 <span class="comment"> *  generated using one or more random strings), then simply call the</span>
00188 <span class="comment"> *  appropriate *job_submit() function.</span>
00189 <span class="comment"> *</span>
00190 <span class="comment"> *  If you are using names that have low entropy or reusing names for</span>
00191 <span class="comment"> *  similar jobs then it is advisable that you first call one of the</span>
00192 <span class="comment"> *  *session_new() routines to ensure all your jobs will be kept isolated</span>
00193 <span class="comment"> *  from other similarly named jobs, and then use the *job_submit()</span>
00194 <span class="comment"> *  routines to send your jobs.</span>
00195 <span class="comment"> *</span>
00196 <span class="comment"> *  For the curious: when you submit your job, the directory and all</span>
00197 <span class="comment"> *  of its contents will be sent to the remote Grid UI selected and</span>
00198 <span class="comment"> *  then the 'job.jdl' will be submitted to the grid. In the process,</span>
00199 <span class="comment"> *  several files will be generated holding information about your</span>
00200 <span class="comment"> *  job identity in the grid context that will be kept for housekeeping</span>
00201 <span class="comment"> *  and future reference.</span>
00202 <span class="comment"> *</span>
00203 <span class="comment"> *  The above is to be kept in mind when submitting light or numerous</span>
00204 <span class="comment"> *  jobs: the transfer time may become sensibly relevant. Please do </span>
00205 <span class="comment"> *  take it into consideration in your equations when designing jobs</span>
00206 <span class="comment"> *  for the grid using this class. You may find it interesting to first</span>
00207 <span class="comment"> *  store all or some of your job data/execs on the grid and keep them</span>
00208 <span class="comment"> *  already there instead of having to copy them.</span>
00209 <span class="comment"> *</span>
00210 <span class="comment"> *  Grid file management routines are not included yet, but are intended</span>
00211 <span class="comment"> *  for a future release of this class.</span>
00212 <span class="comment"> *</span>
00213 <span class="comment"> * @package Grid</span>
00214 <span class="comment"> *</span>
00215 <span class="comment"> * @pre ssh.php</span>
00216 <span class="comment"> *</span>
00217 <span class="comment"> * @see ssh.php (PHP SSH class)</span>
00218 <span class="comment"> *</span>
00219 <span class="comment"> * @author José R. Valverde &lt;jrvalverde@acm.org&gt;</span>
00220 <span class="comment"> * @version 2.1</span>
00221 <span class="comment"> * @copyright José R. Valverde &lt;jrvalverde@acm.org&gt;</span>
00222 <span class="comment"> *</span>
00223 <span class="comment"> * This library is free software; you can redistribute it and/or</span>
00224 <span class="comment"> * modify it under the terms of the GNU Lesser General Public</span>
00225 <span class="comment"> * License as published by the Free Software Foundation; either</span>
00226 <span class="comment"> * version 2.1 of the License, or (at your option) any later version.</span>
00227 <span class="comment"> * </span>
00228 <span class="comment"> * This library is distributed in the hope that it will be useful,</span>
00229 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00230 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00231 <span class="comment"> * Lesser General Public License for more details.</span>
00232 <span class="comment"> * </span>
00233 <span class="comment"> * You should have received a copy of the GNU Lesser General Public</span>
00234 <span class="comment"> * License along with this library; if not, write to the Free Software</span>
00235 <span class="comment"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
00236 <span class="comment"> * </span>
00237 <span class="comment"> */</span>
00238  
<a name="l00239"></a><a class="code" href="classGrid.html">00239</a> <span class="keyword">class </span><a class="code" href="classGrid.html">Grid</a> {
00240     <span class="comment">/*</span>
00241 <span class="comment">     * Notes: preparing for 3.0</span>
00242 <span class="comment">     *</span>
00243 <span class="comment">     *  Change entry_point, etc... to array of alternate UI nodes.</span>
00244 <span class="comment">     *  These should be provided by the user on the Web form.</span>
00245 <span class="comment">     *</span>
00246 <span class="comment">     *  Load balance among user interfaces (start with one and round-robin)</span>
00247 <span class="comment">     *</span>
00248 <span class="comment">     *  Detect connection failures to a UI and remove it from the list of</span>
00249 <span class="comment">     *  active UI (put it on a list of inactive UI just in case we have to</span>
00250 <span class="comment">     *  resort to retrying).</span>
00251 <span class="comment">     *</span>
00252 <span class="comment">     *  Recover failed jobs:</span>
00253 <span class="comment">     *  Difficult -- we need some way to detect them (perhaps spawn a monitor</span>
00254 <span class="comment">     *  process) or be notified of their status, and restart as needed. Most</span>
00255 <span class="comment">     *  probably we will need to spawn a monitor subprocess, and have this</span>
00256 <span class="comment">     *  poll a listing of jobs on the grid and check their status... If so,</span>
00257 <span class="comment">     *  then we might as well cache results for finished jobs locally...</span>
00258 <span class="comment">     *</span>
00259 <span class="comment">     *  Mmmmph...</span>
00260 <span class="comment">     */</span>
00261 <span class="comment"></span>
00262 <span class="comment">    /**#@+</span>
00263 <span class="comment">     * @access private</span>
00264 <span class="comment">     * @var string </span>
00265 <span class="comment">     */</span><span class="comment"></span>
00266 <span class="comment">    /** the grid entry point, should not be needed */</span>
00267     var <a class="code" href="classGrid.html#o0">$entry_point</a>;   <span class="comment"></span>
00268 <span class="comment">    /** user name to use to connect to the grid */</span>
00269     var <a class="code" href="classGrid.html#o1">$username</a>;<span class="comment"></span>
00270 <span class="comment">    /** name of host that provides access to the grid */</span>
00271     var <a class="code" href="classGrid.html#o2">$hostname</a>;      <span class="comment"></span>
00272 <span class="comment">    /** password to login on the UI node */</span>
00273     var <a class="code" href="classGrid.html#o3">$password</a>;      <span class="comment"></span>
00274 <span class="comment">    /** key to unlock the grid access certificate */</span>
00275     var <a class="code" href="classGrid.html#o4">$passphrase</a>;<span class="comment"></span>
00276 <span class="comment">    /** a GrUI directory where we can work */</span>
00277     var <a class="code" href="classGrid.html#o5">$work_dir</a>;      <span class="comment"></span>
00278 <span class="comment">    /** a local file to store the error log */</span>
00279     var <a class="code" href="classGrid.html#o6">$error_log</a>;     <span class="comment"></span>
00280 <span class="comment">    /**#@-*/</span>
00281     <span class="comment"></span>
00282 <span class="comment">    /**#@+</span>
00283 <span class="comment">     * @access private</span>
00284 <span class="comment">     * @var resource</span>
00285 <span class="comment">     */</span><span class="comment"></span>
00286 <span class="comment">    /** Standard input of the grid entry */</span>
00287     var <a class="code" href="classGrid.html#o7">$std_in</a>;        <span class="comment"></span>
00288 <span class="comment">    /** Standard output of the grid entry */</span>
00289     var <a class="code" href="classGrid.html#o8">$std_out</a>;       <span class="comment"></span>
00290 <span class="comment">    /** Standard error of the grid entry */</span>
00291     var <a class="code" href="classGrid.html#o9">$std_err</a>;       
00292     <span class="comment">// !!! IMPORTANT !!! either:</span>
00293     <span class="comment">//  a. set files to not hang on wait or</span>
00294     <span class="comment">//  b. remember to set them to no-hang when needed</span><span class="comment"></span>
00295 <span class="comment">    /**#@-*/</span>
00296 <span class="comment"></span>
00297 <span class="comment">    /**</span>
00298 <span class="comment">     * Have we already connected?</span>
00299 <span class="comment">     *</span>
00300 <span class="comment">     * @access private</span>
00301 <span class="comment">     * @var bool</span>
00302 <span class="comment">     */</span>
00303     var <a class="code" href="classGrid.html#o10">$connected</a>;<span class="comment"></span>
00304 <span class="comment">    /**</span>
00305 <span class="comment">     * Have we already identified ourselves?</span>
00306 <span class="comment">     *</span>
00307 <span class="comment">     * @access private</span>
00308 <span class="comment">     * @var bool</span>
00309 <span class="comment">     */</span>
00310     var <a class="code" href="classGrid.html#o11">$initialized</a>;<span class="comment"></span>
00311 <span class="comment">    /**</span>
00312 <span class="comment">     *  A unique identifier for this session</span>
00313 <span class="comment">     *</span>
00314 <span class="comment">     * @access private</span>
00315 <span class="comment">     * @var array</span>
00316 <span class="comment">     */</span>
00317     var <a class="code" href="classGrid.html#o12">$sessions</a>;<span class="comment"></span>
00318 <span class="comment">    /**</span>
00319 <span class="comment">     *  The secure transfer communications line to use</span>
00320 <span class="comment">     *</span>
00321 <span class="comment">     * @access private</span>
00322 <span class="comment">     * @var SExec</span>
00323 <span class="comment">     */</span>
00324     var <a class="code" href="classGrid.html#o13">$sx</a>;<span class="comment"></span>
00325 <span class="comment">    /**</span>
00326 <span class="comment">     *  Submit timeout</span>
00327 <span class="comment">     *  XXX JR XXX HACK</span>
00328 <span class="comment">     *  This variable used for a hack (?) to ensure job submission does</span>
00329 <span class="comment">     * not hang. Currently job submission using edg-job-submit may hang</span>
00330 <span class="comment">     * occassinally. This is rare, maybe one out of 4-5 thousand jobs,</span>
00331 <span class="comment">     * but for such large datasets it becomes an issue.</span>
00332 <span class="comment">     *</span>
00333 <span class="comment">     *  My impression is that it hangs on copying the job to the remote</span>
00334 <span class="comment">     * resource broker. This may happen if the RB becomes unavaliable:</span>
00335 <span class="comment">     * by TCP semantics the line remains open until connectivity is</span>
00336 <span class="comment">     * restored, but if this takes too long, or if some error conditions</span>
00337 <span class="comment">     * are met your connection may stall.</span>
00338 <span class="comment">     *</span>
00339 <span class="comment">     *  This is very difficult to spot unless it is done at a very low</span>
00340 <span class="comment">     * level in the copy connection protocol. Higher up, one can not know</span>
00341 <span class="comment">     * if the copy takes too long because of connection problems or if it</span>
00342 <span class="comment">     * simply is a huge dataset or a very slow connection.</span>
00343 <span class="comment">     *</span>
00344 <span class="comment">     *  For the same reason, edg-job-submit has no way to know if the</span>
00345 <span class="comment">     * connection is stalled unless it has some way to measure the amount</span>
00346 <span class="comment">     * of data transferred (which is done lower in the protocol stack). So</span>
00347 <span class="comment">     * from edg-job-submit point of view, most probably it is not a bug,</span>
00348 <span class="comment">     * but a feature: it aims for a most optimistic situation and a most</span>
00349 <span class="comment">     * safe transfer, i.e. keep trying to use the connection as long as it</span>
00350 <span class="comment">     * is not broken, and try to ensure the data gets fully transferred</span>
00351 <span class="comment">     * in the presence of trouble for as long as the connection may be</span>
00352 <span class="comment">     * recovered, and do not make any assumption about the size of the</span>
00353 <span class="comment">     * dataset or the speed of the line.</span>
00354 <span class="comment">     *</span>
00355 <span class="comment">     *  Now, for an automated submission system with deadline (proxy</span>
00356 <span class="comment">     * validity) this is a potential disaster: I have witnessed job submissions</span>
00357 <span class="comment">     * hang for as long as a couple of days (and then I killed them manually).</span>
00358 <span class="comment">     *</span>
00359 <span class="comment">     *  So, what can we do?</span>
00360 <span class="comment">     *</span>
00361 <span class="comment">     *  If you know the bounds of your job sizes (exec + datasets) then you</span>
00362 <span class="comment">     * may have an estimate of how long you want to allow a transfer to </span>
00363 <span class="comment">     * take, and kill any submission taking longer. Then with appropriate</span>
00364 <span class="comment">     * code the submission may be retaken (in my experience, hang submissions</span>
00365 <span class="comment">     * usually succeed after bein manually killed and retried) or the job</span>
00366 <span class="comment">     * resubmitted at a later time if you have recovery code on your app.</span>
00367 <span class="comment">     *</span>
00368 <span class="comment">     *  This variable holds the maximum time in seconds you guesstimate a </span>
00369 <span class="comment">     * job submission should be allowed to take. If this timeout is </span>
00370 <span class="comment">     * exceeded the submission will be unpiteously killed. Since this is</span>
00371 <span class="comment">     * a rare condition you may be generous.</span>
00372 <span class="comment">     *</span>
00373 <span class="comment">     * @access private</span>
00374 <span class="comment">     * @var integer</span>
00375 <span class="comment">     */</span>
00376     var <a class="code" href="classGrid.html#o14">$submit_timeout</a>;
00377     <span class="comment"></span>
00378 <span class="comment">    /**</span>
00379 <span class="comment">     * Constructor for the class</span>
00380 <span class="comment">     *</span>
00381 <span class="comment">     * Set the values for the class variables using defaults provided in</span>
00382 <span class="comment">     * 'config.php'</span>
00383 <span class="comment">     *</span>
00384 <span class="comment">     * These defaults can be overridden using the functions provided below.</span>
00385 <span class="comment">     *</span>
00386 <span class="comment">     * Sample usage:</span>
00387 <span class="comment">     * &lt;code&gt;</span>
00388 <span class="comment">     * require_once './grid_config.php';</span>
00389 <span class="comment">     * require_once './ssh.php';</span>
00390 <span class="comment">     * require_once './grid.php';</span>
00391 <span class="comment">     * </span>
00392 <span class="comment">     * $eg = new Grid;</span>
00393 <span class="comment">     * if ($eg == FALSE)</span>
00394 <span class="comment">     *     echo "Couldn't instantiate a new Grid!\n";</span>
00395 <span class="comment">     * &lt;/code&gt;</span>
00396 <span class="comment">     *</span>
00397 <span class="comment">     * @return Grid a new instance of a Grid class object</span>
00398 <span class="comment">     */</span>
<a name="l00399"></a><a class="code" href="classGrid.html#a0">00399</a>     function <a class="code" href="classGrid.html#a0">Grid</a>() {
00400         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
00401         
00402         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::Grid()\n"</span>;
00403 
00404         $this-&gt;entry_point = $GLOBALS['grid_server'];
00405         $this-&gt;username    = $GLOBALS['grid_user'];
00406         $this-&gt;hostname    = $GLOBALS['grid_host'];
00407         $this-&gt;password    = $GLOBALS['grid_password'];
00408         $this-&gt;passphrase  = $GLOBALS['grid_passphrase'];
00409         $this-&gt;work_dir    = $GLOBALS['grid_wd_path'];
00410         $this-&gt;error_log   = $GLOBALS['grid_error_log'];
00411         $this-&gt;connected   = FALSE;
00412         $this-&gt;sessions['<span class="keywordflow">default</span>'] = '<span class="keywordflow">default</span>';
00413         <span class="keywordflow">return</span> $this;
00414     }
00415     
<a name="l00416"></a><a class="code" href="classGrid.html#a1">00416</a>     function <a class="code" href="classGrid.html#a1">destruct</a>() {
00417         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
00418         
00419         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::destruct()\n"</span>;
00420         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) print_r($<span class="keyword">this</span>);
00421         <span class="comment">// remove remote files (should we?)</span>
00422         <span class="comment">// $this-&gt;destroy_all_sessions();</span>
00423         <span class="comment">// free sessions array</span>
00424         <span class="comment">// unset($this-&gt;sessions);</span>
00425         <span class="comment">// remove local files if any (should we?)</span>
00426         
00427         <span class="comment">// with a shared connection we now must ensure some</span>
00428         <span class="comment">// cleanup is done...</span>
00429         <span class="comment">// THIS SHOULD BE AUTOMATIC ON CLASS SExec! REVIEW</span>
00430         $this-&gt;sx-&gt;destruct();
00431     }
00432     
00433     <span class="comment">// A C C E S S    V A R I A B L E    V A L U E S</span>
00434     <span class="comment">// Note: do we also need "get_XX" routines?</span>
00435 <span class="comment"></span>
00436 <span class="comment">    /**</span>
00437 <span class="comment">     * set the Grid user name</span>
00438 <span class="comment">     *</span>
00439 <span class="comment">     *  In order to connect to the Grid and be able to submit</span>
00440 <span class="comment">     * jobs we need a tuple (host/user/password/passphrase),</span>
00441 <span class="comment">     * i.e. an entry point to log in, and a passphrase to unlock</span>
00442 <span class="comment">     * the grid certificate.</span>
00443 <span class="comment">     *</span>
00444 <span class="comment">     *  This method allows us to define the username which will</span>
00445 <span class="comment">     * be used to log in on the grid, i.e. how do we identify </span>
00446 <span class="comment">     * ourselves to the Grid UI host.</span>
00447 <span class="comment">     *</span>
00448 <span class="comment">     * Sample usage:</span>
00449 <span class="comment">     * &lt;code&gt;</span>
00450 <span class="comment">     * require_once './grid_config.php';</span>
00451 <span class="comment">     * require_once './ssh.php';</span>
00452 <span class="comment">     * require_once './grid.php';</span>
00453 <span class="comment">     *</span>
00454 <span class="comment">     * $user="user";</span>
00455 <span class="comment">     *</span>
00456 <span class="comment">     * $eg = new Grid;</span>
00457 <span class="comment">     * if ($eg == FALSE)</span>
00458 <span class="comment">     *     echo "Couldn't instantiate a new Grid!\n";</span>
00459 <span class="comment">     * $eg-&gt;set_user($user);</span>
00460 <span class="comment">     * &lt;/code&gt;</span>
00461 <span class="comment">     *</span>
00462 <span class="comment">     * @param string user identity to use in the Grid UI host</span>
00463 <span class="comment">     */</span>
<a name="l00464"></a><a class="code" href="classGrid.html#a2">00464</a>     function <a class="code" href="classGrid.html#a2">set_user</a>($user)
00465     {
00466         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
00467         
00468         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::set_user($user)\n"</span>;
00469 
00470         $this-&gt;username = $user;
00471         $this-&gt;entry_point=$user.<span class="stringliteral">"</span><span class="stringliteral">@".$this-&gt;hostname;
    }
    </span><span class="comment"></span>
00472 <span class="comment">    /**</span>
00473 <span class="comment">     * set the name of the Grid access host</span>
00474 <span class="comment">     *</span>
00475 <span class="comment">     *  In order to connect to the Grid and be able to submit</span>
00476 <span class="comment">     * jobs we need a tuple (host/user/password/passphrase),</span>
00477 <span class="comment">     * i.e. an entry point to log in, and a passphrase to unlock</span>
00478 <span class="comment">     * the grid certificate.</span>
00479 <span class="comment">     *</span>
00480 <span class="comment">     *  This method allows us to define the entry point to use</span>
00481 <span class="comment">     * to gain access to the Grid.</span>
00482 <span class="comment">     *</span>
00483 <span class="comment">     * Sample usage:</span>
00484 <span class="comment">     * &lt;code&gt;</span>
00485 <span class="comment">     * require_once './grid_config.php';</span>
00486 <span class="comment">     * require_once './ssh.php';</span>
00487 <span class="comment">     * require_once './grid.php';</span>
00488 <span class="comment">     *</span>
00489 <span class="comment">     * $host="gridui.example.com";</span>
00490 <span class="comment">     *</span>
00491 <span class="comment">     * $eg = new Grid;</span>
00492 <span class="comment">     * if ($eg == FALSE)</span>
00493 <span class="comment">     *     echo "Couldn't instantiate a new Grid!\n";</span>
00494 <span class="comment">     * $eg-&gt;set_host($host);</span>
00495 <span class="comment">     * &lt;/code&gt;</span>
00496 <span class="comment">     *</span>
00497 <span class="comment">     * @param string host name of the remote UI host</span>
00498 <span class="comment">     */</span>
    function set_host($host)
    {
        global $debug_grid;
        
        if ($debug_grid) echo "Grid::set_host($host)\n";
00499 
00500         $this-&gt;hostname = $host;
<a name="l00501"></a><a class="code" href="classGrid.html#a3">00501</a>         $this-&gt;entry_point = $this-&gt;username.<span class="stringliteral">"</span><span class="stringliteral">@".$host;
    }
    </span><span class="comment"></span>
00502 <span class="comment">    /**</span>
00503 <span class="comment">     * set the password for the remote grid user/server</span>
00504 <span class="comment">     *</span>
00505 <span class="comment">     *  In order to connect to the Grid and be able to submit</span>
00506 <span class="comment">     * jobs we need a tuple (host/user/password/passphrase),</span>
00507 <span class="comment">     * i.e. an entry point to log in, and a passphrase to unlock</span>
00508 <span class="comment">     * the grid certificate.</span>
00509 <span class="comment">     *</span>
00510 <span class="comment">     *  This method allows us to specify the password to</span>
00511 <span class="comment">     * clear access to the Grid UI host.</span>
00512 <span class="comment">     *</span>
00513 <span class="comment">     *  Note that this is specific to the remote UI server </span>
00514 <span class="comment">     * selected.</span>
00515 <span class="comment">     *</span>
00516 <span class="comment">     *  Further note that gaining access to a user account on</span>
00517 <span class="comment">     * a given host does not give us rights to submit jobs:</span>
00518 <span class="comment">     * we still need to unlock our ID certificate with the</span>
00519 <span class="comment">     * appropriate passphrase. Anybody with root access to an</span>
00520 <span class="comment">     * UI host can add accounts. Further, the UI host might</span>
00521 <span class="comment">     * have other roles and host other accounts for different</span>
00522 <span class="comment">     * purposes which should not access the grid. Bottomline is</span>
00523 <span class="comment">     * that we can not trust an account on a user-controlled</span>
00524 <span class="comment">     * host to identify Grid users. For this we need to recurse</span>
00525 <span class="comment">     * to a central authority to grant final access.</span>
00526 <span class="comment">     *</span>
00527 <span class="comment">     * Sample usage:</span>
00528 <span class="comment">     * &lt;code&gt;</span>
00529 <span class="comment">     * require_once './grid_config.php';</span>
00530 <span class="comment">     * require_once './ssh.php';</span>
00531 <span class="comment">     * require_once './grid.php';</span>
00532 <span class="comment">     *</span>
00533 <span class="comment">     * $password="password";</span>
00534 <span class="comment">     *</span>
00535 <span class="comment">     * $eg = new Grid;</span>
00536 <span class="comment">     * if ($eg == FALSE)</span>
00537 <span class="comment">     *     echo "Couldn't instantiate a new Grid!\n";</span>
00538 <span class="comment">     * $eg-&gt;set_password($password);</span>
00539 <span class="comment">     * &lt;/code&gt;</span>
00540 <span class="comment">     *</span>
00541 <span class="comment">     * @param string password needed to login on to the grid UI server</span>
00542 <span class="comment">     */</span>
    function set_password($pass)
    {
        global $debug_grid;
        
        if ($debug_grid) echo "Grid::set_password($pass)\n";
00543 
00544         $this-&gt;password = $pass;
00545     }
00546 <span class="comment"></span>
00547 <span class="comment">    /**</span>
00548 <span class="comment">     * set the passphrase for the remote grid user</span>
00549 <span class="comment">     *</span>
00550 <span class="comment">     *</span>
00551 <span class="comment">     *  In order to connect to the Grid and be able to submit</span>
<a name="l00552"></a><a class="code" href="classGrid.html#a4">00552</a> <span class="comment">     * jobs we need a tuple (host/user/password/passphrase),</span>
00553 <span class="comment">     * i.e. an entry point to log in, and a passphrase to unlock</span>
00554 <span class="comment">     * the grid certificate.</span>
00555 <span class="comment">     *</span>
00556 <span class="comment">     *  After we gain access to the UI host, we must unlock our</span>
00557 <span class="comment">     * certificate which identifies ourselves as 'bona-fide'</span>
00558 <span class="comment">     * grid users.</span>
00559 <span class="comment">     *</span>
00560 <span class="comment">     *  People might have an account on any UI node for a variety</span>
00561 <span class="comment">     * of reasons, but that does not qualify them to use Grid</span>
00562 <span class="comment">     * resources. Only a central Grid authority can grant this</span>
00563 <span class="comment">     * kind of access and this is done by issuing a Certificate.</span>
00564 <span class="comment">     *</span>
00565 <span class="comment">     *  Users then must store this certificate in their account</span>
00566 <span class="comment">     * on a UI host and protect it with a suitably long passphrase.</span>
00567 <span class="comment">     * This last one is the value we provide here.</span>
00568 <span class="comment">     *</span>
00569 <span class="comment">     * Sample usage:</span>
00570 <span class="comment">     * &lt;code&gt;</span>
00571 <span class="comment">     * require_once './grid_config.php';</span>
00572 <span class="comment">     * require_once './ssh.php';</span>
00573 <span class="comment">     * require_once './grid.php';</span>
00574 <span class="comment">     *</span>
00575 <span class="comment">     * $passphrase="pass phrase to unlock certificate";</span>
00576 <span class="comment">     *</span>
00577 <span class="comment">     * $eg = new Grid;</span>
00578 <span class="comment">     * if ($eg == FALSE)</span>
00579 <span class="comment">     *     echo "Couldn't instantiate a new Grid!\n";</span>
00580 <span class="comment">     * $eg-&gt;set_passphrase($passphrase);</span>
00581 <span class="comment">     * &lt;/code&gt;</span>
00582 <span class="comment">     *</span>
00583 <span class="comment">     * @param string passphrase needed to unlock the grid certificate</span>
00584 <span class="comment">     */</span>
00585     function <a class="code" href="classGrid.html#a5">set_passphrase</a>($pass)
00586     {
00587         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
00588         
00589         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::set_passphrase($pass)\n"</span>;
00590 
00591         $this-&gt;passphrase = $pass;
00592     }
00593     <span class="comment"></span>
00594 <span class="comment">    /**</span>
00595 <span class="comment">     * set working directory on the Grid server</span>
00596 <span class="comment">     *</span>
00597 <span class="comment">     * This is a directory located on the grid server where all jobs</span>
00598 <span class="comment">     * and job related information will be created. It may be a path</span>
<a name="l00599"></a><a class="code" href="classGrid.html#a5">00599</a> <span class="comment">     * local to the user home or a global path (usually on /tmp or </span>
00600 <span class="comment">     * /var/tmp).</span>
00601 <span class="comment">     *</span>
00602 <span class="comment">     * Sample usage:</span>
00603 <span class="comment">     * &lt;code&gt;</span>
00604 <span class="comment">     * require_once './grid_config.php';</span>
00605 <span class="comment">     * require_once './ssh.php';</span>
00606 <span class="comment">     * require_once './grid.php';</span>
00607 <span class="comment">     *</span>
00608 <span class="comment">     * $eg = new Grid;</span>
00609 <span class="comment">     * if ($eg == FALSE)</span>
00610 <span class="comment">     *     echo "Couldn't instantiate a new Grid!\n";</span>
00611 <span class="comment">     * $eg-&gt;set_work_dir("./grid-services");</span>
00612 <span class="comment">     * &lt;/code&gt;</span>
00613 <span class="comment">     *</span>
00614 <span class="comment">     * @param string the remote path of the working directory</span>
00615 <span class="comment">     */</span>
00616     function <a class="code" href="classGrid.html#a6">set_work_dir</a>($wd)
00617     {
00618         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
00619         
00620         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::set_work_dir($wd)\n"</span>;
00621 
00622         $this-&gt;work_dir=$wd;
00623     }
00624     <span class="comment"></span>
00625 <span class="comment">    /**</span>
00626 <span class="comment">     * set error log</span>
00627 <span class="comment">     *</span>
00628 <span class="comment">     * Sample usage:</span>
00629 <span class="comment">     * &lt;code&gt;</span>
<a name="l00630"></a><a class="code" href="classGrid.html#a6">00630</a> <span class="comment">     * require_once './grid_config.php';</span>
00631 <span class="comment">     * require_once './ssh.php';</span>
00632 <span class="comment">     * require_once './grid.php';</span>
00633 <span class="comment">     *</span>
00634 <span class="comment">     * $eg = new Grid;</span>
00635 <span class="comment">     * if ($eg == FALSE)</span>
00636 <span class="comment">     *     echo "Couldn't instantiate a new Grid!\n";</span>
00637 <span class="comment">     * $eg-&gt;set_error_log("./grid-services/error.log");</span>
00638 <span class="comment">     * &lt;/code&gt;</span>
00639 <span class="comment">     *</span>
00640 <span class="comment">     * @param string path to a local file where we will store the error log</span>
00641 <span class="comment">     *               (i.e. stderr of the grid connection)</span>
00642 <span class="comment">     */</span>
00643     function <a class="code" href="classGrid.html#a7">set_error_log</a>($errlog)
00644     {
00645         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
00646         
00647         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::set_error_log($errlog)\n"</span>;
00648 
00649         $this-&gt;error_log = $errlog;
00650     }
00651     <span class="comment"></span>
00652 <span class="comment">    /**</span>
00653 <span class="comment">     * get grid connection status</span>
00654 <span class="comment">     *</span>
00655 <span class="comment">     * This method allows you to know if the connection with the remote</span>
00656 <span class="comment">     * grid entry point has been successfully established or not. Note</span>
<a name="l00657"></a><a class="code" href="classGrid.html#a7">00657</a> <span class="comment">     * that this does not mean you may launch jobs to the grid: you</span>
00658 <span class="comment">     * still need to initialize the grid first.</span>
00659 <span class="comment">     *</span>
00660 <span class="comment">     * Sample usage:</span>
00661 <span class="comment">     * &lt;code&gt;</span>
00662 <span class="comment">     * require_once './grid_config.php';</span>
00663 <span class="comment">     * require_once './ssh.php';</span>
00664 <span class="comment">     * require_once './grid.php';</span>
00665 <span class="comment">     * </span>
00666 <span class="comment">     * $eg = new Grid;</span>
00667 <span class="comment">     * </span>
00668 <span class="comment">     * $eg-&gt;pconnect();</span>
00669 <span class="comment">     * if ($eg-&gt;get_connection_status() == FALSE)</span>
00670 <span class="comment">     *     echo "Couldn't connect to the Grid entry point!\n";</span>
00671 <span class="comment">     * &lt;/code&gt;</span>
00672 <span class="comment">     *</span>
00673 <span class="comment">     * @return bool TRUE if the connection has been established, FALSE</span>
00674 <span class="comment">     *              otherwise.</span>
00675 <span class="comment">     */</span>
00676     function <a class="code" href="classGrid.html#a8">get_connection_status</a>()
00677     {
00678         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
00679         
00680         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::get_connection_status()\n"</span>;
00681 
00682         <span class="keywordflow">return</span> $this-&gt;connected;
00683     }
00684 <span class="comment"></span>
00685 <span class="comment">    /**</span>
00686 <span class="comment">     * get grid initialization status</span>
00687 <span class="comment">     *</span>
00688 <span class="comment">     * This method allows you to learn whether the Grid has been</span>
00689 <span class="comment">     * successfully initialized and is ready to accept jobs. This</span>
<a name="l00690"></a><a class="code" href="classGrid.html#a8">00690</a> <span class="comment">     * entails both, login in as a specific user on the Grid connection</span>
00691 <span class="comment">     * point, and activating the proxy with your passphrase.</span>
00692 <span class="comment">     *</span>
00693 <span class="comment">     * The reason for the two step process is that in order to activate</span>
00694 <span class="comment">     * the grid you need to identify yourself using a grid certificate</span>
00695 <span class="comment">     * emitted by a CA. But to activate it you need an account on a grid</span>
00696 <span class="comment">     * access machine, which is open by any local administrator. Since</span>
00697 <span class="comment">     * this account is not under the central CA control, we can't trust </span>
00698 <span class="comment">     * it to submit jobs and require a proxy-initialization with an</span>
00699 <span class="comment">     * appropriate passphrase.</span>
00700 <span class="comment">     *</span>
00701 <span class="comment">     * Sample usage:</span>
00702 <span class="comment">     * &lt;code&gt;</span>
00703 <span class="comment">     * require_once './grid_config.php';</span>
00704 <span class="comment">     * require_once './ssh.php';</span>
00705 <span class="comment">     * require_once './grid.php';</span>
00706 <span class="comment">     * </span>
00707 <span class="comment">     * $eg = new Grid;</span>
00708 <span class="comment">     * </span>
00709 <span class="comment">     * $eg-&gt;initialize();</span>
00710 <span class="comment">     * if ($eg-&gt;get_init_status() == FALSE)</span>
00711 <span class="comment">     *     echo "Couldn't initialize the Grid!\n";</span>
00712 <span class="comment">     * &lt;/code&gt;</span>
00713 <span class="comment">     *</span>
00714 <span class="comment">     * @return bool TRUE if the grid has been initialized, FALSE</span>
00715 <span class="comment">     *              otherwise.</span>
00716 <span class="comment">     */</span>
00717     function <a class="code" href="classGrid.html#a9">get_init_status</a>()
00718     {
00719         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
00720         
00721         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::get_init_status()\n"</span>;
00722 
00723         <span class="keywordflow">return</span> $this-&gt;initialized;
00724     }
00725 
00726 
00727     <span class="comment">//</span>
00728     <span class="comment">// C O N N E C T    T O    T H E    U S E R    I N T E R F A C E   H O S T</span>
00729     <span class="comment">//</span>
00730     <span class="comment"></span>
<a name="l00731"></a><a class="code" href="classGrid.html#a9">00731</a> <span class="comment">    /**</span>
00732 <span class="comment">     * open a persistent connection to the Grid UI server</span>
00733 <span class="comment">     * </span>
00734 <span class="comment">     *  The Grid User Interface Server is the entry point to the Grid</span>
00735 <span class="comment">     *  for users and user applications. This is where jobs are launched from.</span>
00736 <span class="comment">     * </span>
00737 <span class="comment">     *  This package has been designed to be able to be installed in any</span>
00738 <span class="comment">     *  host, independent of whether it is an UI or not. Thus, to be able to</span>
00739 <span class="comment">     *  submit jobs to the Grid, the server hosting the Web UI must connect to</span>
00740 <span class="comment">     *  a Grid UI host to do the work.</span>
00741 <span class="comment">     * </span>
00742 <span class="comment">     *  This routine opens a connection to a Grid UI host using an specified</span>
00743 <span class="comment">     *  username (i.e. all jobs will be run under said username).</span>
00744 <span class="comment">     * </span>
00745 <span class="comment">     *  The panorama therefore will look like this:</span>
00746 <span class="comment">     * </span>
00747 <span class="comment">     *  HTML front-end --&gt; processor.php &lt;--&gt; SSH &lt;--&gt; remote host &lt;--&gt; Grid</span>
00748 <span class="comment">     *</span>
00749 <span class="comment">     *  This allows for better resilience: should a GridUI host be </span>
00750 <span class="comment">     * unavailable, we can detect the error condition and try another </span>
00751 <span class="comment">     * one. If the GridUI runs the front-end, then we have a single</span>
00752 <span class="comment">     * point of failure, which is a no-no.</span>
00753 <span class="comment">     *</span>
00754 <span class="comment">     * Sample usage:</span>
00755 <span class="comment">     * &lt;code&gt;</span>
00756 <span class="comment">     * require_once './grid_config.php';</span>
00757 <span class="comment">     * require_once './ssh.php';</span>
00758 <span class="comment">     * require_once './grid.php';</span>
00759 <span class="comment">     * </span>
00760 <span class="comment">     * $eg = new Grid;</span>
00761 <span class="comment">     * </span>
00762 <span class="comment">     * $eg-&gt;pconnect();</span>
00763 <span class="comment">     * if ($eg-&gt;get_connection_status() == FALSE)</span>
00764 <span class="comment">     *     echo "Couldn't instantiate a new Grid!\n";</span>
00765 <span class="comment">     * &lt;/code&gt;</span>
00766 <span class="comment">     *</span>
00767 <span class="comment">     *  @note   Use files instead of pipes and open them after securing</span>
00768 <span class="comment">     * thew connection: this should do with deadlocks and leave a trace</span>
00769 <span class="comment">     * log.</span>
00770 <span class="comment">     *</span>
00771 <span class="comment">     *  @return TRUE on success, FALSE otherwise.</span>
00772 <span class="comment">     */</span>
00773 
00774     function <a class="code" href="classGrid.html#a10">connect</a>()
00775     {   
00776         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
00777         
00778         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"\nGrid::connect()\n"</span>;
00779         
00780         <span class="comment">// Using the new SExec class (Rel2) instantiating an SExec</span>
00781         <span class="comment">// object creates a master channel to the remote end point</span>
00782         <span class="comment">// The master channel will be hitchhicked by all other</span>
00783         <span class="comment">// SExec commands.</span>
00784         
00785         $this-&gt;sx = <span class="keyword">new</span> SExec($this-&gt;entry_point, $this-&gt;password);
00786         
00787         <span class="keywordflow">if</span> ($this-&gt;sx == FALSE)
<a name="l00788"></a><a class="code" href="classGrid.html#a10">00788</a>             <span class="comment">// couldn't stablish connection with the remote end</span>
00789             <span class="keywordflow">return</span> FALSE;
00790         $this-&gt;connected = TRUE;
00791         <span class="keywordflow">return</span> TRUE;
00792     }
00793 
00794 <span class="comment"></span>
00795 <span class="comment">    /**</span>
00796 <span class="comment">     * Start the Grid services</span>
00797 <span class="comment">     *</span>
00798 <span class="comment">     *  This function starts the grid services on the remote UI server host.</span>
00799 <span class="comment">     *  This is done by unlocking the certificate that we are going to use </span>
00800 <span class="comment">     *  to run our jobs on the grid using the passphrase provided.</span>
00801 <span class="comment">     *</span>
00802 <span class="comment">     *  Grid services have a lifetime of their own. By default they are</span>
00803 <span class="comment">     *  available for 12:00 hours (that's the default value of</span>
00804 <span class="comment">     *  grid-proxy-init itself), but their duration may be fine tuned</span>
00805 <span class="comment">     *  if we have some knowledge about the time required to run our</span>
00806 <span class="comment">     *  job.</span>
00807 <span class="comment">     *</span>
00808 <span class="comment">     *  Grid opening time is specified in hours+minutes. If the number of</span>
00809 <span class="comment">     *  minutes is negative, the specified minutes are substracted from</span>
00810 <span class="comment">     *  the specified hours (e.g: 1, -15 is fifteen minutes to one hour,</span>
00811 <span class="comment">     *  i.e. 45 minutes). If the total time specified is negative then</span>
00812 <span class="comment">     *  the default of 12:00 is used.</span>
00813 <span class="comment">     *</span>
00814 <span class="comment">     *  Grid::initialize() enables the grid for a specified amount of time</span>
00815 <span class="comment">     * (by default 12:00h). This means that during the validity period, </span>
00816 <span class="comment">     * the user on the Grid-UI host may access the grid, in the same or</span>
00817 <span class="comment">     * different logins. The validity period SURVIVES after we close </span>
00818 <span class="comment">     * all communications with the remote grid entry point for as long</span>
00819 <span class="comment">     * as we have specified (so our jobs may continue running).</span>
00820 <span class="comment">     *</span>
00821 <span class="comment">     *  If Grid access was already available (by a previous call to </span>
00822 <span class="comment">     * Grid::initialize()) when we issue the call, then it is reused</span>
00823 <span class="comment">     * and extended to acommodate the newly requested validity period.</span>
00824 <span class="comment">     * In other words, the Grid access is shared among all logins</span>
00825 <span class="comment">     * during its lifetime.</span>
00826 <span class="comment">     *</span>
00827 <span class="comment">     *  This also means that if a valid certificate has been issued and</span>
00828 <span class="comment">     * not expired yet (another call to Grid::initialize() is still</span>
00829 <span class="comment">     * valid), then we may submit jobs to the Grid without any need</span>
00830 <span class="comment">     * to call Grid::initialize() ourselves.</span>
00831 <span class="comment">     *</span>
00832 <span class="comment">     *  E.g., say you have a web-based service that runs a long job</span>
00833 <span class="comment">     * and you want to have the grid enabled 12h (the default). You</span>
00834 <span class="comment">     * just call Grid::initialize() and then submit the job.</span>
00835 <span class="comment">     *</span>
00836 <span class="comment">     *  Now say that before it expires, someone logs in on your account </span>
00837 <span class="comment">     * but shouldn't have access to the Grid (i.e. they don't know</span>
00838 <span class="comment">     * the Grid-activation passphrase). Since the grid is already</span>
00839 <span class="comment">     * activated, they CAN submit jobs on your behalf even if they</span>
00840 <span class="comment">     * should not.</span>
00841 <span class="comment">     *</span>
00842 <span class="comment">     *  Therefore, &lt;b&gt;DO NOT SHARE YOUR ACCOUNT ON THE GRID-UI</span>
00843 <span class="comment">     * WITH ANYBODY&lt;/b&gt;. Protect it as dearly as your Grid certificate.</span>
00844 <span class="comment">     *</span>
00845 <span class="comment">     *  It also means that debugging may be somewhat convoluted, as</span>
00846 <span class="comment">     * a call to Grid::initialize() may fail and jobs could still</span>
00847 <span class="comment">     * be accepted if another call from some other process is still</span>
00848 <span class="comment">     * valid. While debugging, it is better if you review the </span>
00849 <span class="comment">     * command output and make sure it shows how the call fared.</span>
00850 <span class="comment">     *</span>
00851 <span class="comment">     *  So, what happens if we destroy a session? See Grid::destroy()</span>
00852 <span class="comment">     * for more details.</span>
00853 <span class="comment">     *</span>
00854 <span class="comment">     * Sample usage:</span>
00855 <span class="comment">     * &lt;code&gt;</span>
00856 <span class="comment">     *     $eg = new Grid;</span>
00857 <span class="comment">     *     $eg-&gt;set_user($user);</span>
00858 <span class="comment">     *     $eg-&gt;set_host($host);</span>
00859 <span class="comment">     *     $eg-&gt;set_password($passwd);</span>
00860 <span class="comment">     *     $eg-&gt;set_passphrase($passphrase);</span>
00861 <span class="comment">     *     $eg-&gt;set_work_dir("/tmp/grid/test/cless");</span>
00862 <span class="comment">     *     $eg-&gt;set_error_log("/tmp/grid/test/cless/connection.err");</span>
00863 <span class="comment">     *     $eg-&gt;connect();</span>
00864 <span class="comment">     *     if (!$eg-&gt;initialize())</span>
00865 <span class="comment">     *          echo "error: couldn't init the grid\n";</span>
00866 <span class="comment">     *     else</span>
00867 <span class="comment">     *          echo "OK\n";</span>
00868 <span class="comment">     *     $eg-&gt;destroy();</span>
00869 <span class="comment">     *     $eg-&gt;disconnect();</span>
00870 <span class="comment">     * &lt;/code&gt;</span>
00871 <span class="comment">     *</span>
00872 <span class="comment">     *  @note the output of the grid initialization command will go to</span>
00873 <span class="comment">     *        &lt;b&gt;our&lt;/b&gt; standard output (i.e. the web server)!</span>
00874 <span class="comment">     *</span>
00875 <span class="comment">     *  @bug: XXX JR XXX grid-proxy-init will use the time from the last</span>
00876 <span class="comment">     *        issued command. To avoid setting a time shorter than one</span>
00877 <span class="comment">     *        already existing we should first issue a grid-proxy-info,</span>
00878 <span class="comment">     *        check if there is a running proxy, its time left, see if</span>
00879 <span class="comment">     *        it is longer than what we want to set and if it is, then</span>
00880 <span class="comment">     *        do NOTHING to avoid setting it shorter.</span>
00881 <span class="comment">     *</span>
00882 <span class="comment">     *  @param  integer     Estimated duration in hours of the session</span>
00883 <span class="comment">     *</span>
00884 <span class="comment">     *  @param  integer     Estimated duration in minutes of the session</span>
00885 <span class="comment">     *</span>
00886 <span class="comment">     *  @return bool TRUE on success, FALSE otherwise</span>
00887 <span class="comment">     */</span>
00888      
00889     function <a class="code" href="classGrid.html#a11">initialize</a>($hours=12, $minutes=0)
00890     {
00891         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
00892         
00893         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::initialize($hours, $minutes)\n"</span>;
00894         
00895         <span class="comment">// connect if not connected</span>
00896         <span class="keywordflow">if</span> ($this-&gt;connected == FALSE)
00897             <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classGrid.html#a10">connect</a>() == FALSE)
00898                 <span class="keywordflow">return</span> FALSE;
00899         
00900         <span class="comment">// validate and compute activation time to use</span>
00901         $total_minutes = ($hours * 60) + ($minutes);
00902         <span class="keywordflow">if</span> ($total_minutes &lt; 0) {
<a name="l00903"></a><a class="code" href="classGrid.html#a11">00903</a>             <span class="comment">//use default</span>
00904             $hours = 12;
00905             $minutes = 0;
00906         } <span class="keywordflow">else</span> {
00907             $hours = floor($total_minutes / 60);
00908             $minutes = $total_minutes % 60;
00909         }
00910         
00911         $out = <span class="stringliteral">""</span>;
00912         <span class="comment">// Create remote working dir</span>
00913         $status = $this-&gt;sx-&gt;ssh_exec(
00914             <span class="stringliteral">"mkdir -p $this-&gt;work_dir/default"</span>,
00915             $out);
00916         <span class="keywordflow">if</span> ($status != 0) {
00917             <span class="comment">// something went airy</span>
00918             <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) {
00919                 echo <span class="stringliteral">"--&gt; mkdir -p $this-&gt;work_dir/default\n"</span>;
00920                 echo <span class="stringliteral">"--&gt; exit: $status\n"</span>;
00921                 echo <span class="stringliteral">"--&gt; output:\n"</span>.$out . <span class="stringliteral">"\n\n"</span>;
00922             }
00923             <span class="keywordflow">return</span> FALSE;
00924         }
00925         $this-&gt;sessions[] = '<span class="keywordflow">default</span>';      <span class="comment">// enter on sessions list</span>
00926         
00927         <span class="comment">// NOTE: XXX JR XXX</span>
00928         <span class="comment">//  Using popen here has one major drawback: the command output</span>
00929         <span class="comment">//  will go directly to the web page!</span>
00930         <span class="comment">//  We should consider instead getting stdin/stdout handles or</span>
00931         <span class="comment">//  dismissing remote command output.</span>
00932         $rin = $this-&gt;sx-&gt;ssh_popen(
00933             <span class="stringliteral">". /etc/bashrc ; "</span> .
00934             <span class="comment">// XXX DAVID XXX the problem was in the initialize of</span>
00935             <span class="comment">// grock_lib.php script</span>
00936             <span class="comment">//"/opt/globus/bin/grid-proxy-init -pwstdin -valid 300:00", </span>
00937             <span class="stringliteral">"/opt/globus/bin/grid-proxy-init -pwstdin -valid $hours:$minutes"</span>, 
00938 # XXX JR XXX test <span class="keyword">this</span>      <span class="stringliteral">"/opt/globus/bin/grid-proxy-init -pwstdin -valid $hours:$minutes 2&gt;&amp;1/dev/null"</span>, 
00939             <span class="stringliteral">"w"</span>
00940             );
00941         sleep(1);   <span class="comment">// leave some time for the prompt (and preceding flush)</span>
00942         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Remote Input = $rin\n"</span>;
00943         fputs($rin, $this-&gt;passphrase.<span class="stringliteral">"\n"</span>); fflush($rin);
00944         $status = $this-&gt;sx-&gt;ssh_pclose($rin);
00945         
00946         <span class="keywordflow">if</span> ($status == 0) {
00947             <span class="keywordflow">return</span> $this-&gt;initialized = TRUE;
00948         } <span class="keywordflow">else</span> {
00949             <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"PCLOSE STATUS = $status\n"</span>;
00950             <span class="keywordflow">return</span> $this-&gt;initialized = FALSE;
00951         }
00952         
00953     }
00954 <span class="comment"></span>
00955 <span class="comment">    /**</span>
00956 <span class="comment">     *  Destroy remote grid identity</span>
00957 <span class="comment">     *</span>
00958 <span class="comment">     *  Destroy the certification we initialized so that no more jobs</span>
00959 <span class="comment">     *  can be launched under our identity.</span>
00960 <span class="comment">     *</span>
00961 <span class="comment">     *  This may be called even if we haven't called 'Grid::initialize()'</span>
00962 <span class="comment">     * because there may exits a previous activation that is still </span>
00963 <span class="comment">     * valid and we want to destroy it.</span>
00964 <span class="comment">     *</span>
00965 <span class="comment">     *  To make things clear:</span>
00966 <span class="comment">     *</span>
00967 <span class="comment">     *  Grid::initialize() "opens" the "door" to the Grid for &lt;i&gt;the user&lt;/i&gt;</span>
00968 <span class="comment">     * during a given time. New calls from the same user in this or any</span>
00969 <span class="comment">     * other login session, from this or any other site, while the "door" </span>
00970 <span class="comment">     * is open, share the same "door" and simply extend its validity</span>
00971 <span class="comment">     * period.</span>
00972 <span class="comment">     *</span>
00973 <span class="comment">     *  Grid::destroy() "closes" the currently open door. If the door</span>
00974 <span class="comment">     * was being shared by more login sessions, it is closed for &lt;i&gt;all&lt;/i&gt;</span>
00975 <span class="comment">     * of them, not just the caller, and hence nor the caller, nor</span>
00976 <span class="comment">     * &lt;i&gt;any process&lt;/i&gt; under the same user will be able to use the</span>
00977 <span class="comment">     * grid any longer unless Grid::initialize() is called again to</span>
00978 <span class="comment">     * open the door again (issue a new certificate).</span>
00979 <span class="comment">     *</span>
00980 <span class="comment">     *  In other words, you don't close &lt;i&gt;a&lt;/i&gt; Grid "door", you close </span>
00981 <span class="comment">     * &lt;i&gt;the&lt;/i&gt; Grid "door", and if it casually is being shared with other </span>
00982 <span class="comment">     * work sessions, then ALL of them will be destroyed (meaning that </span>
00983 <span class="comment">     * other active work sessions will fail).</span>
00984 <span class="comment">     *</span>
00985 <span class="comment">     *  Thus: be careful when using this method. Be &lt;b&gt;very careful&lt;/b&gt;.</span>
00986 <span class="comment">     *</span>
00987 <span class="comment">     *  Sessions should be initiated using a validity length that you</span>
00988 <span class="comment">     * guesstimate will be comfortably enough for running all your work</span>
00989 <span class="comment">     * and left to expire by themselves.</span>
00990 <span class="comment">     *</span>
00991 <span class="comment">     *  Grid::destroy() should only be called when you are sure that</span>
00992 <span class="comment">     * you don't want &lt;i&gt;any&lt;/i&gt; work on the Grid to be accepted on</span>
00993 <span class="comment">     * your behalf, neither from this not other work sessions.</span>
00994 <span class="comment">     *</span>
00995 <span class="comment">     *  So, in general, it is better to make good estimations of the</span>
00996 <span class="comment">     * time needed by your jobs and specify it to Grid::initialize()</span>
00997 <span class="comment">     * and not use Grid::destroy() unless there are good reasons.</span>
00998 <span class="comment">     *</span>
00999 <span class="comment">     * Sample usage:</span>
01000 <span class="comment">     * &lt;code&gt;</span>
01001 <span class="comment">     *     $eg = new Grid;</span>
01002 <span class="comment">     *     $eg-&gt;set_user($user);</span>
01003 <span class="comment">     *     $eg-&gt;set_host($host);</span>
01004 <span class="comment">     *     $eg-&gt;set_password($passwd);</span>
01005 <span class="comment">     *     $eg-&gt;set_passphrase($passphrase);</span>
01006 <span class="comment">     *     $eg-&gt;set_work_dir("/tmp/grid/test/cless");</span>
01007 <span class="comment">     *     $eg-&gt;set_error_log("/tmp/grid/test/cless/connection.err");</span>
01008 <span class="comment">     *     if (!$eg-&gt;initialize())</span>
01009 <span class="comment">     *          echo "error: couldn't init the grid\n";</span>
01010 <span class="comment">     *     else</span>
01011 <span class="comment">     *          echo "OK";</span>
01012 <span class="comment">     *     $eg-&gt;destroy();</span>
01013 <span class="comment">     *     $eg-&gt;disconnect();</span>
01014 <span class="comment">     * &lt;/code&gt;</span>
01015 <span class="comment">     *</span>
01016 <span class="comment">     *  @note   Be careful when using this function: as it destroys our</span>
01017 <span class="comment">     *          Grid-ID, no more work will be able to be executed on the</span>
01018 <span class="comment">     *          grid on our behalf. In other words, please, make sure there</span>
01019 <span class="comment">     *          is no work pending and that all your work has terminated</span>
01020 <span class="comment">     *          before destroying your Grid-ID.</span>
01021 <span class="comment">     *</span>
01022 <span class="comment">     *  @return bool TRUE on success, FALSE on failure</span>
01023 <span class="comment">     */</span>
01024     function <a class="code" href="classGrid.html#a12">destroy</a>()
01025     {
01026         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
01027         
01028         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::destroy()\n"</span>;
01029         
01030         <span class="keywordflow">if</span> (! $this-&gt;connected)
01031             <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="classGrid.html#a10">connect</a>() == FALSE)
01032                 <span class="keywordflow">return</span> FALSE;
01033 
01034         $out = <span class="stringliteral">""</span>;
01035         $ret = $this-&gt;sx-&gt;ssh_exec(
01036             <span class="stringliteral">". /etc/bashrc ; grid-proxy-destroy"</span>,
01037             $out);
<a name="l01038"></a><a class="code" href="classGrid.html#a12">01038</a>         <span class="keywordflow">if</span> ($ret == 0)
01039             <span class="keywordflow">return</span> TRUE;    <span class="comment">// OK</span>
01040         <span class="keywordflow">else</span> {
01041             <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) {
01042                 echo <span class="stringliteral">"--&gt; exit: $ret\n"</span>;
01043                 echo <span class="stringliteral">"--&gt; output:\n"</span>.$out . <span class="stringliteral">"\n\n"</span>;
01044             }
01045             <span class="keywordflow">return</span> FALSE;
01046         }
01047     }
01048 <span class="comment"></span>
01049 <span class="comment">    /**</span>
01050 <span class="comment">     *  Create a new session</span>
01051 <span class="comment">     *</span>
01052 <span class="comment">     *  We take control of the session system: in a previous incarnation</span>
01053 <span class="comment">     * we got the session name from the user. This is dangerous since we</span>
01054 <span class="comment">     * can not avoid clashes even with random session names provided by</span>
01055 <span class="comment">     * a user: a randomly generated name may be guaranteed unique within</span>
01056 <span class="comment">     * the user's local host namespace, but should various calls come from</span>
01057 <span class="comment">     * different hosts (e.g. HA front-ends in a cluster), it is conceivable</span>
01058 <span class="comment">     * (although improbable) that both come up with the same random number</span>
01059 <span class="comment">     * and generate a clash on the shared remote grid access point. Hence </span>
01060 <span class="comment">     * the new approach: to be true, users do not need to generate a session </span>
01061 <span class="comment">     * name themselves: they just need a way to refer to them.</span>
01062 <span class="comment">     *</span>
01063 <span class="comment">     *  This routine will generate a new session: under a given session,</span>
01064 <span class="comment">     * we guarantee that processes will be run under an isolated sandbox</span>
01065 <span class="comment">     * where non name clashes from other concurrent users will occur.</span>
01066 <span class="comment">     * Name clashes within a given session induced by the user are still</span>
01067 <span class="comment">     * the responsability of the user.</span>
01068 <span class="comment">     *</span>
01069 <span class="comment">     * SESSIONS</span>
01070 <span class="comment">     *</span>
01071 <span class="comment">     *  The basic idea is as follows: if you are developing a service that</span>
01072 <span class="comment">     * may be called concurrently by various users, your problem at the GrUI</span>
01073 <span class="comment">     * is the same as on your local server: avoiding name clashes for jobs.</span>
01074 <span class="comment">     * As long as you manage that locally using unique names, the same will</span>
01075 <span class="comment">     * work on the UI server.</span>
01076 <span class="comment">     *</span>
01077 <span class="comment">     *  This however may be inconvenient at times. It is usually the case</span>
01078 <span class="comment">     * when your service is not composed by a single job, but by many</span>
01079 <span class="comment">     * independent jobs that may be run concurrently as well. You still </span>
01080 <span class="comment">     * need to generate unique names for each sub-job, but if they are</span>
01081 <span class="comment">     * produced within a local uniquely named service-instance, then you</span>
01082 <span class="comment">     * may reuse the sub-job names for each instance.</span>
01083 <span class="comment">     *</span>
01084 <span class="comment">     *  This comes handy in the case of many sub-jobs: as long as the main</span>
01085 <span class="comment">     * service instance is uniquely identified, contained sub-jobs may have</span>
01086 <span class="comment">     * significant names that are easier to identify than randomly-generated</span>
01087 <span class="comment">     * ones: e.g.</span>
01088 <span class="comment">     * &lt;pre&gt;</span>
01089 <span class="comment">     *    user A -&gt; service-instance-A -+-&gt; sub-job-1</span>
01090 <span class="comment">     *                                  |</span>
01091 <span class="comment">     *                                  +-&gt; sub-job-2</span>
01092 <span class="comment">     *                                  |</span>
01093 <span class="comment">     *                                  etc...</span>
01094 <span class="comment">     *</span>
01095 <span class="comment">     *    user B -&gt; service-instance-B -+-&gt; sub-job-1</span>
01096 <span class="comment">     *                                  |</span>
01097 <span class="comment">     *                                  +-&gt; sub-job-2</span>
01098 <span class="comment">     *                                  |</span>
01099 <span class="comment">     *                                  etc...</span>
01100 <span class="comment">     * &lt;/pre&gt;</span>
01101 <span class="comment">     *  In this case, since the service-instances have unique names (A, B)</span>
01102 <span class="comment">     * we may use the same naming strategy in both cases for naming sub-jobs</span>
01103 <span class="comment">     * (1, 2,...) which makes bookkeeping a lot easier.</span>
01104 <span class="comment">     *</span>
01105 <span class="comment">     *  To reproduce a similar behaviour remotely we provide 'sessions'.</span>
01106 <span class="comment">     *</span>
01107 <span class="comment">     *  Basically, what you are doing in the local case is isolating all the</span>
01108 <span class="comment">     * equally named jobs of each service-instance within an unique sandbox.</span>
01109 <span class="comment">     * In the grid you get the same result using 'sessions': whenever you</span>
01110 <span class="comment">     * want to submit a series of non-randomly-named jobs (or even a single</span>
01111 <span class="comment">     * one) you first allocate a session, and then attach those jobs to the</span>
01112 <span class="comment">     * session. Job names within a session are guaranteed not to clash with</span>
01113 <span class="comment">     * equal job names from another session.</span>
01114 <span class="comment">     *</span>
01115 <span class="comment">     *  Note the 'non-randomly-named' tag above: you want to use sessions</span>
01116 <span class="comment">     * ALWAYS that you use any non-random job name unless you can guarantee</span>
01117 <span class="comment">     * it will be the only job with that name ON THE GRID.</span>
01118 <span class="comment">     *</span>
01119 <span class="comment">     *  This is an important notice: your job may have a non-random, but</span>
01120 <span class="comment">     * guaranteed unique name on your local host. And as long as the job</span>
01121 <span class="comment">     * will only be submitted from your local host it is OK. But if you</span>
01122 <span class="comment">     * are going to share your tools with other fellows, then they will</span>
01123 <span class="comment">     * install them locally and submit a similarly named job as well. The</span>
01124 <span class="comment">     * job name will be unique within each one's local machine, but when</span>
01125 <span class="comment">     * jobs are collected at the GrUI, they will all have the same name,</span>
01126 <span class="comment">     * which is a no-no.</span>
01127 <span class="comment">     *</span>
01128 <span class="comment">     * USING SESSIONS</span>
01129 <span class="comment">     *</span>
01130 <span class="comment">     *  Once you see the need for using sessions, using them is quite </span>
01131 <span class="comment">     * simple: you call this function asking for a new session to be</span>
01132 <span class="comment">     * created on the remote grid access point on your behalf. The routine</span>
01133 <span class="comment">     * will return a unique session identifier which you later use to </span>
01134 <span class="comment">     * tag jobs that are to be run within that session's sandbox.</span>
01135 <span class="comment">     *</span>
01136 <span class="comment">     * Sample usage:</span>
01137 <span class="comment">     * &lt;code&gt;</span>
01138 <span class="comment">     *  $eg = new Grid;</span>
01139 <span class="comment">     *  $eg-&gt;set_user($user);</span>
01140 <span class="comment">     *  $eg-&gt;set_host($host);</span>
01141 <span class="comment">     *  $eg-&gt;set_password($passwd);</span>
01142 <span class="comment">     *  $eg-&gt;set_passphrase($passphrase);</span>
01143 <span class="comment">     *  $eg-&gt;set_work_dir("/tmp/grid/debug");</span>
01144 <span class="comment">     *  $eg-&gt;set_error_log("/tmp/grid/debug/connection.err");</span>
01145 <span class="comment">     *  echo "initializing grid... ";</span>
01146 <span class="comment">     *  if (!$eg-&gt;initialize()) {</span>
01147 <span class="comment">     *      echo "error: couldn't init the grid\n";</span>
01148 <span class="comment">     *      exit;</span>
01149 <span class="comment">     *  }</span>
01150 <span class="comment">     *  else</span>
01151 <span class="comment">     *      echo "OK\n";</span>
01152 <span class="comment">     *  echo "Submitting tst-job to default session...\n";</span>
01153 <span class="comment">     *  $out = array("");</span>
01154 <span class="comment">     *  if (! $eg-&gt;job_submit("tst-job", $out)) {</span>
01155 <span class="comment">     *      echo "error: coudn't start the job\n";</span>
01156 <span class="comment">     *      exit;</span>
01157 <span class="comment">     *  }</span>
01158 <span class="comment">     *  else </span>
01159 <span class="comment">     *     echo "OK\n";</span>
01160 <span class="comment">     *  print_r($out);</span>
01161 <span class="comment">     *  echo "Submitting tst-job to a new session...\n";</span>
01162 <span class="comment">     *  $sess = $eg-&gt;session_new();</span>
01163 <span class="comment">     *  echo "sess = "; print_r($sess); echo "\n";</span>
01164 <span class="comment">     *  if ($sess != FALSE) {</span>
01165 <span class="comment">     *      $out = array("");</span>
01166 <span class="comment">     *      if (! $eg-&gt;job_submit("tst-job", $out, $sess))</span>
01167 <span class="comment">     *         echo "error: coudn't start the job\n";</span>
01168 <span class="comment">     *      else {</span>
01169 <span class="comment">     *         echo "OK\n";</span>
01170 <span class="comment">     *      }</span>
01171 <span class="comment">     *      $eg-&gt;session_destroy($sess);</span>
01172 <span class="comment">     *  }</span>
01173 <span class="comment">     *  $eg-&gt;destruct();</span>
01174 <span class="comment">     * &lt;/code&gt;</span>
01175 <span class="comment">     *</span>
01176 <span class="comment">     * @param string $hint an optional string to be used for the session name</span>
01177 <span class="comment">     *</span>
01178 <span class="comment">     * @return string|false session ID of the newly generated session.</span>
01179 <span class="comment">     */</span>
01180     function <a class="code" href="classGrid.html#a13">session_new</a>($hint=<span class="stringliteral">"sess"</span>)
01181     {
01182         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
01183         
01184         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::session_new()\n"</span>;
01185         
01186         <span class="comment">// we need a valid connection, no need for initialization.</span>
01187         <span class="keywordflow">if</span> (! $this-&gt;connected)
01188             <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classGrid.html#a10">connect</a>())
01189                 <span class="keywordflow">return</span> FALSE;
01190         
01191         $out=array(<span class="stringliteral">""</span>);
01192         $status = $this-&gt;sx-&gt;ssh_exec( 
01193             <span class="stringliteral">"mktemp -d $this-&gt;work_dir/$hint.XXXXXX"</span>,
<a name="l01194"></a><a class="code" href="classGrid.html#a13">01194</a>             $out);
01195         <span class="keywordflow">if</span> ($status == 0) {
01196             <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) print_r($out);
01197             <span class="comment">// find out the generated session directory name</span>
01198             $sess = basename($out[1]);
01199             <span class="comment">//if we got no suggested session name</span>
01200             <span class="keywordflow">if</span> (strcmp($hint, 'sess') == 0)
01201                 <span class="comment">// use the generated one</span>
01202                 $hint = $sess;
01203             <span class="comment">// keep a mapping of session names to directories</span>
01204             $this-&gt;sessions[$hint] = $sess;
01205             <span class="keywordflow">return</span> $hint;
01206         } <span class="keywordflow">else</span> {
01207             <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) print_r($out);
01208             <span class="keywordflow">return</span> FALSE;
01209         }
01210 
01211 <span class="comment">/* Alternate implementation:    </span>
01212 <span class="comment">        list($usec, $sec) = explode(' ', microtime());</span>
01213 <span class="comment">        $seed = (float) $sec + ((float) $usec * 100000);</span>
01214 <span class="comment">        srand($seed);</span>
01215 <span class="comment">        $rand1 = rand(); $rand2 = rand();</span>
01216 <span class="comment">        $session = "session-$rand1-$rand2";</span>
01217 <span class="comment">        if ($debug_grid) echo "--&gt; creating session $session\n";</span>
01218 <span class="comment">        if ($debug_grid) echo "--&gt; mkdir -p ".$this-&gt;work_dir."/".$session."\n";</span>
01219 <span class="comment">        $out = array("");</span>
01220 <span class="comment">        $status = $this-&gt;sx-&gt;ssh_exec( </span>
01221 <span class="comment">            "mkdir -p ".$this-&gt;work_dir."/".$session,</span>
01222 <span class="comment">            $out);</span>
01223 <span class="comment">        if ($status == 0) {</span>
01224 <span class="comment">            if ($debug_grid) print_r($out);</span>
01225 <span class="comment">            $this-&gt;sessions[] = $session;</span>
01226 <span class="comment">            return $session;</span>
01227 <span class="comment">        } else {</span>
01228 <span class="comment">            if ($debug_grid) print_r($out);</span>
01229 <span class="comment">            return FALSE;</span>
01230 <span class="comment">        }</span>
01231 <span class="comment">*/</span>
01232     }
01233     <span class="comment"></span>
01234 <span class="comment">    /**</span>
01235 <span class="comment">     *  Define an already existing session</span>
01236 <span class="comment">     *</span>
01237 <span class="comment">     *  This is useful if the session already exists and</span>
01238 <span class="comment">     * we want to access it: we already know its</span>
01239 <span class="comment">     * directory name, and just want to associate a</span>
01240 <span class="comment">     * new name with the existing directory name.</span>
01241 <span class="comment">     *</span>
01242 <span class="comment">     *  Use e.g. when you are to submit a job from</span>
01243 <span class="comment">     * a WWW page and access the results from a different</span>
01244 <span class="comment">     * one: as the new page has no access to the status of</span>
01245 <span class="comment">     * the previous one, we need to rebuild it ourselves.</span>
01246 <span class="comment">     *</span>
01247 <span class="comment">     *  @param string session name</span>
01248 <span class="comment">     *  @param string subdirectory of $work_dir to be associated to that name</span>
01249 <span class="comment">     */</span>
01250     function <a class="code" href="classGrid.html#a14">session_define</a>($session, $directory)
01251     {
01252         $this-&gt;sessions[$session] = $directory;
01253     }
01254 <span class="comment"></span>
01255 <span class="comment">    /**</span>
01256 <span class="comment">     * check if supplied argument is a valid (existing and active) </span>
01257 <span class="comment">     * session.</span>
01258 <span class="comment">     *</span>
01259 <span class="comment">     * @param string a session name</span>
01260 <span class="comment">     * @return bool TRUE if the session could be found among the list of</span>
01261 <span class="comment">     *              valid sessions, FALSE otherwise</span>
01262 <span class="comment">     *</span>
01263 <span class="comment">     * @access private</span>
<a name="l01264"></a><a class="code" href="classGrid.html#a14">01264</a> <span class="comment">     */</span>
01265     function <a class="code" href="classGrid.html#a15">session_is_valid</a>($session='<span class="keywordflow">default</span>')
01266     {
01267         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
01268         
01269         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::is_valid_session($session)\n"</span>;
01270         foreach ($this-&gt;sessions as $i =&gt; $value)
01271             <span class="keywordflow">if</span> (strcmp($i, $session) == 0)
01272                 <span class="keywordflow">return</span> TRUE;
01273         <span class="keywordflow">return</span> FALSE;
01274     }
01275 <span class="comment"></span>
01276 <span class="comment">    /**</span>
01277 <span class="comment">     * return the directory associated to a session</span>
01278 <span class="comment">     *</span>
<a name="l01279"></a><a class="code" href="classGrid.html#a15">01279</a> <span class="comment">     *  DOES NO ERROR CHECKING FOR VALID SESSION</span>
01280 <span class="comment">     *</span>
01281 <span class="comment">     *  @param string a session name</span>
01282 <span class="comment">     *  @return string the associated directory name</span>
01283 <span class="comment">     *</span>
01284 <span class="comment">     *  @access private</span>
01285 <span class="comment">     */</span>
01286     function <a class="code" href="classGrid.html#a16">session_directory</a>($session='<span class="keywordflow">default</span>')
01287     {
01288         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
01289         <span class="keywordflow">return</span> $this-&gt;sessions[$session];
01290     }
01291 <span class="comment"></span>
01292 <span class="comment">    /**</span>
01293 <span class="comment">     * list all existing sessions</span>
01294 <span class="comment">     * (debugging only)</span>
01295 <span class="comment">     *</span>
01296 <span class="comment">     * @access private</span>
01297 <span class="comment">     */</span>
01298     function <a class="code" href="classGrid.html#a17">session_list_all</a>()
01299     {
<a name="l01300"></a><a class="code" href="classGrid.html#a16">01300</a>         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
01301         
01302         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::list_sessions()\n"</span>;
01303         print_r($this-&gt;sessions);
01304         foreach ($this-&gt;sessions as $i =&gt; $value)
01305             echo <span class="stringliteral">"Session $i is stored on $value\n"</span>;
01306     }
01307     <span class="comment"></span>
01308 <span class="comment">    /**</span>
01309 <span class="comment">     * destroy the specified session</span>
01310 <span class="comment">     *</span>
01311 <span class="comment">     *  This method destroys all data associated with the specified</span>
<a name="l01312"></a><a class="code" href="classGrid.html#a17">01312</a> <span class="comment">     * session. Currently it does not kill its associated jobs, but</span>
01313 <span class="comment">     * deleted all their underlying data nevertheless.</span>
01314 <span class="comment">     *</span>
01315 <span class="comment">     * Warning: passing an empty string or no argument will destroy</span>
01316 <span class="comment">     * the default session.</span>
01317 <span class="comment">     *</span>
01318 <span class="comment">     * return bool TRUE if success, FALSE otherwise</span>
01319 <span class="comment">     */</span>
01320     function <a class="code" href="classGrid.html#a18">session_destroy</a>($session='<span class="keywordflow">default</span>')
01321     {
01322         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
01323         
01324         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::session_destroy($session)\n"</span>;
01325         
01326         <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classGrid.html#a15">session_is_valid</a>($session))
01327             <span class="keywordflow">return</span> FALSE;
01328         
01329         <span class="comment">// we need at least a valid remote connection</span>
01330         <span class="keywordflow">if</span> (! $this-&gt;connected)
01331             <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classGrid.html#a10">connect</a>())
01332                 <span class="keywordflow">return</span> FAIL;
01333         
<a name="l01334"></a><a class="code" href="classGrid.html#a18">01334</a>         <span class="comment">// XXX JR XXX we should loop first over every job and kill it.</span>
01335         <span class="comment">// delete all data for this session</span>
01336         $sess_dir = $this-&gt;sessions[$session];
01337         $status = $this-&gt;sx-&gt;ssh_exec(
01338             <span class="stringliteral">"rm -rf $this-&gt;work_dir/$sess_dir"</span>,
01339             $out);
01340         <span class="keywordflow">if</span> ($status == 0) {
01341             unset($this-&gt;sessions[$session]);
01342             <span class="keywordflow">return</span> TRUE;
01343         }
01344         <span class="keywordflow">else</span>
01345             <span class="keywordflow">return</span> FALSE;
01346     }
01347     <span class="comment"></span>
01348 <span class="comment">    /**</span>
01349 <span class="comment">     *  Destroy all existing sessions</span>
01350 <span class="comment">     *</span>
01351 <span class="comment">     *  @access private</span>
01352 <span class="comment">     */</span>
01353     function <a class="code" href="classGrid.html#a19">session_destroy_all</a>()
01354     {
01355         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
01356         
01357         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::destroy_all_sessions()\n"</span>;
01358         
01359         <span class="comment">// we need at least a valid remote connection</span>
01360         <span class="keywordflow">if</span> (! $this-&gt;connected)
01361             <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classGrid.html#a10">connect</a>())
01362                 <span class="keywordflow">return</span> FAIL;
01363         
01364         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) print_r($this-&gt;sessions);
01365         foreach ($this-&gt;sessions as $i =&gt; $value) {
01366             <span class="comment">// XXX JR XXX we should loop first over every job and kill it.</span>
<a name="l01367"></a><a class="code" href="classGrid.html#a19">01367</a>             <span class="comment">// delete all data for this session</span>
01368             $status = $this-&gt;sx-&gt;ssh_exec(
01369                 <span class="stringliteral">"rm -rf $this-&gt;work_dir/$value"</span>,
01370                 $out);
01371             <span class="keywordflow">if</span> ($status == 0)
01372                 unset($this-&gt;sessions[$i]);
01373             <span class="keywordflow">else</span>
01374                 <span class="keywordflow">return</span> FALSE;
01375         }
01376         <span class="keywordflow">return</span> TRUE;
01377     }
01378     <span class="comment"></span>
01379 <span class="comment">    /**</span>
01380 <span class="comment">     *  Set maximum (guesstimated) allowed time for a job submission to</span>
01381 <span class="comment">     * succeed.</span>
01382 <span class="comment">     *</span>
01383 <span class="comment">     *  This value is application and dataset dependent, will be of</span>
01384 <span class="comment">     * relevance in rare occasions (1/4000) and hence may as well be</span>
01385 <span class="comment">     * generous.</span>
01386 <span class="comment">     *</span>
01387 <span class="comment">     *  The default is 0 seconds (no timeout). You should make measures</span>
01388 <span class="comment">     * to ensure it is reasonable. If set to 0, no timeout will be used.</span>
01389 <span class="comment">     * </span>
01390 <span class="comment">     *  Unless set to 0, you will need to code some resubmission policy</span>
01391 <span class="comment">     * in your application.</span>
01392 <span class="comment">     *</span>
01393 <span class="comment">     *  @param integer $seconds timeout in seconds for job submission</span>
01394 <span class="comment">     *      (defaults to 0, no timeout).</span>
01395 <span class="comment">     */</span>
01396     function <a class="code" href="classGrid.html#a20">job_submit_set_timeout</a>($seconds=0)
01397     {
01398         $this-&gt;submit_timeout=$seconds;
01399     }
01400     <span class="comment"></span>
01401 <span class="comment">    /**</span>
01402 <span class="comment">     * submit a job to the grid</span>
01403 <span class="comment">     *</span>
01404 <span class="comment">     *  This procedure submits a job to the Grid, optionally tagging it</span>
01405 <span class="comment">     * as part of a specific session.</span>
01406 <span class="comment">     *</span>
01407 <span class="comment">     *  A job must be stored in a single directory (whose name you</span>
01408 <span class="comment">     * provide in the call to this function). The directory must contain</span>
01409 <span class="comment">     * any executables, libraries, configuration files/scripts, and input</span>
<a name="l01410"></a><a class="code" href="classGrid.html#a20">01410</a> <span class="comment">     * data needed to run your job.</span>
01411 <span class="comment">     *</span>
01412 <span class="comment">     *  In addition, there must be a JDL file called 'job.jdl' and describing</span>
01413 <span class="comment">     * the job to the grid using the JDL language.</span>
01414 <span class="comment">     *</span>
01415 <span class="comment">     *  Please note that only the job-directory name is used. If you provide</span>
01416 <span class="comment">     * a longer path, only the last component (the job directory name) will</span>
01417 <span class="comment">     * be used to identify your job remotely.</span>
01418 <span class="comment">     *</span>
01419 <span class="comment">     * Sample usage:</span>
01420 <span class="comment">     * &lt;code&gt;</span>
01421 <span class="comment">     *     $eg = new Grid;</span>
01422 <span class="comment">     *     $eg-&gt;set_user($user);</span>
01423 <span class="comment">     *     $eg-&gt;set_host($host);</span>
01424 <span class="comment">     *     $eg-&gt;set_password($passwd);</span>
01425 <span class="comment">     *     $eg-&gt;set_passphrase($passphrase);</span>
01426 <span class="comment">     *     $eg-&gt;set_work_dir("/tmp/grid/test/cless");</span>
01427 <span class="comment">     *     $eg-&gt;set_error_log("/tmp/grid/test/cless/connection.err");</span>
01428 <span class="comment">     *     echo "initializing grid... ";</span>
01429 <span class="comment">     *     if (!$eg-&gt;initialize())</span>
01430 <span class="comment">     *          echo "error: couldn't init the grid\n";</span>
01431 <span class="comment">     *     else</span>
01432 <span class="comment">     *          echo "OK\n";</span>
01433 <span class="comment">     *     echo "Submitting tst-job... ";</span>
01434 <span class="comment">     *     if (! $eg-&gt;job_submit("tst-job", $out))</span>
01435 <span class="comment">     *          echo "error: coudn't start the job\n";</span>
01436 <span class="comment">     *     else </span>
01437 <span class="comment">     *          echo "OK\n";</span>
01438 <span class="comment">     *     print_r($out);</span>
01439 <span class="comment">     *     $eg-&gt;destroy();</span>
01440 <span class="comment">     *     $eg-&gt;disconnect();</span>
01441 <span class="comment">     * &lt;/code&gt;</span>
01442 <span class="comment">     *</span>
01443 <span class="comment">     *  @note in future instances we may provide routines to generate the </span>
01444 <span class="comment">     *      JDL, possibly within a GridJob class of its own.</span>
01445 <span class="comment">     *</span>
01446 <span class="comment">     *  @param  string  The name of the job (same as the subdirectory it is in)</span>
01447 <span class="comment">     *  @param array    A variable to hold any messages spitted by the submission</span>
01448 <span class="comment">     *                  procedure. Messages will be stored as an array of</span>
01449 <span class="comment">     *                  strings (one per line) without ending newlines.</span>
01450 <span class="comment">     *  @param  string Optional name of the session to which this job belongs</span>
01451 <span class="comment">     *                  (obtained from a previous call to session_new).</span>
01452 <span class="comment">     *  @return bool TRUE if success, FALSE otherwise</span>
01453 <span class="comment">     */</span>
01454     function <a class="code" href="classGrid.html#a21">job_submit</a>($job, &amp;$out, $session='<span class="keywordflow">default</span>')
01455     {
01456         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
01457         
01458         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) {
01459             echo <span class="stringliteral">"Grid::job_submit($job, $out, $session)\n"</span>;
01460             echo <span class="stringliteral">"Copying job $job to remote end "</span>.
01461                 <span class="stringliteral">"$this-&gt;entry_point:$this-&gt;work_dir/$session\n"</span>;
01462         }
01463         
01464         <span class="comment">// check this first as it is cheaper</span>
01465         <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classGrid.html#a15">session_is_valid</a>($session))
01466             <span class="keywordflow">return</span> FALSE;
01467         $sd = $this-&gt;sessions[$session];
<a name="l01468"></a><a class="code" href="classGrid.html#a21">01468</a>         
01469         <span class="comment">// we need an initialized grid</span>
01470         <span class="keywordflow">if</span> (! $this-&gt;initialized)
01471             <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classGrid.html#a11">initialize</a>())
01472                 <span class="keywordflow">return</span> FALSE;
01473         
01474         <span class="comment">// We should check for $job validity (i.e., $job/job.jdl exists)</span>
01475         
01476         <span class="comment">// Copy job details over to remote end</span>
01477         $status = $this-&gt;sx-&gt;ssh_copy_to(
01478             $job, <span class="stringliteral">"$this-&gt;work_dir/$sd"</span>, $out);
01479         <span class="keywordflow">if</span> ($status == FALSE) {
01480             <span class="comment">// copy failed</span>
01481             <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) {
01482                 echo <span class="stringliteral">"--&gt; copy: failed\n"</span>;
01483                 print_r($out);
01484             }
01485             <span class="keywordflow">return</span> FALSE;
01486         }
01487         <span class="comment">// XXX JR XXX</span>
01488         <span class="comment">// Remove any existing 'identifier.txt' file</span>
01489         <span class="comment">//  This is 'cos otherwise, if we are re-invoked to re-submit</span>
01490         <span class="comment">// the job, the new ID will be appended and job_get_id will</span>
01491         <span class="comment">// return the old, failed one.</span>
01492         <span class="comment">//  Ideally we should have a job_resubmit() routine that takes</span>
01493         <span class="comment">// care of it AND keeps track of the number of resubmissions...</span>
01494         $this-&gt;sx-&gt;ssh_exec(<span class="stringliteral">"rm -f $this-&gt;work_dir/$sd/$job/identifier.txt"</span>,
01495             $out);
01496         unset($out);    <span class="comment">// we ignore output and exit code!</span>
01497         
01498         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>)
01499             echo <span class="stringliteral">"Submitting with a timeout of $this-&gt;submit_timeout:\n\t"</span>
01500             . (($this-&gt;submit_timeout != 0)? 
01501                  <span class="stringliteral">"(sleep 10; pkill -P \$\$ ) &amp; "</span> :
01502                  <span class="stringliteral">" "</span>)
01503             . <span class="stringliteral">"/opt/edg/bin/edg-job-submit"</span>
01504             . <span class="stringliteral">"  -o $this-&gt;work_dir/$sd/$job/identifier.txt"</span>
01505             . <span class="stringliteral">"  $this-&gt;work_dir/$sd/$job/job.jdl"</span>
01506             . <span class="stringliteral">"  | tee $this-&gt;work_dir/$sd/$job/submit.txt\n"</span>;
01507 
01508         <span class="comment">// NOTE: with direct execution we don't go through the login</span>
01509         <span class="comment">// process, hence needed environment variables must be set.</span>
01510         <span class="comment">// XXX JR XXX</span>
01511         <span class="comment">//      There is an alternate solution: use the remote</span>
01512         <span class="comment">//      command "sh --login -c $command"</span>
01513         <span class="comment">//      This tells sh to behave as a login shell, and read</span>
01514         <span class="comment">//      commands from the string $command.</span>
01515         $status = $this-&gt;sx-&gt;ssh_exec(
01516             <span class="stringliteral">"("</span>
01517             . <span class="stringliteral">". /etc/bashrc ;"</span>
01518             . <span class="stringliteral">"export EDG_WL_LOCATION=/opt/edg ;"</span>
01519             . <span class="stringliteral">"export EDG_WL_LIBRARY_PATH=/opt/globus/lib:/opt/edg/lib ;"</span>
01520             . <span class="stringliteral">"cd $this-&gt;work_dir/$sd/$job; "</span>
01521             . (($this-&gt;submit_timeout != 0) ?
01522                  <span class="stringliteral">"(sleep $this-&gt;submit_timeout; pkill -P \$\$ ) &amp; "</span> :
01523                  <span class="stringliteral">" "</span>)
01524             . <span class="stringliteral">"/opt/edg/bin/edg-job-submit"</span>
01525             . <span class="stringliteral">"  -o $this-&gt;work_dir/$sd/$job/identifier.txt"</span>
01526             . <span class="stringliteral">"  $this-&gt;work_dir/$sd/$job/job.jdl"</span>
01527             . <span class="stringliteral">"  | tee $this-&gt;work_dir/$sd/$job/submit.txt"</span>
01528             . <span class="stringliteral">")"</span>,
01529             $out);
01530         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"$session::$job ($sd/$job) submit status was $status\n"</span>;
01531         <span class="keywordflow">if</span> ($status == 0) {
01532             <span class="comment">// at this point we may as well copy identifier.txt and submit.txt</span>
01533             <span class="comment">// to the local directory and have them cached here.</span>
01534             $this-&gt;sx-&gt;ssh_copy_from(<span class="stringliteral">"$this-&gt;work_dir/$sd/$job/submit.txt"</span>,
01535                 $job, $out);
01536             <span class="comment">// note that identifier.txt may not exist (it SHOULD though!)</span>
01537             $this-&gt;sx-&gt;ssh_copy_from(<span class="stringliteral">"$this-&gt;work_dir/$sd/$job/identifier.txt"</span>,
01538                 $job, $out);
01539             <span class="keywordflow">return</span> TRUE;
01540         }
01541         <span class="keywordflow">else</span>
01542             <span class="keywordflow">return</span> FALSE;
01543     }
01544     <span class="comment"></span>
01545 <span class="comment">    /**</span>
01546 <span class="comment">     *  Get Grid ID of a submitted job.</span>
01547 <span class="comment">     *</span>
01548 <span class="comment">     *  You should not need this function normally. The job and session</span>
01549 <span class="comment">     * names you already have should actually be enough for all your needs.</span>
01550 <span class="comment">     * The function is needed internally by the class, but otherwise it should</span>
01551 <span class="comment">     * be of little interest.</span>
01552 <span class="comment">     *</span>
01553 <span class="comment">     *  Nevertheless, you may want to have access to this knowledge, either</span>
01554 <span class="comment">     * out of curiosity or for other reasons (e.g. re-routing access to a</span>
01555 <span class="comment">     * job through other access points after a crash of the original access</span>
01556 <span class="comment">     * point you used to submit it).</span>
01557 <span class="comment">     *</span>
01558 <span class="comment">     *  Indeed, this will come handy for newer releases of this class when</span>
01559 <span class="comment">     * disaster recovery is added. Meanwhile, as already said, it is of little</span>
01560 <span class="comment">     * use.</span>
01561 <span class="comment">     *</span>
01562 <span class="comment">     * Sample usage:</span>
01563 <span class="comment">     * &lt;code&gt;</span>
01564 <span class="comment">     *     $eg = new Grid;</span>
01565 <span class="comment">     *     $eg-&gt;set_user($user);</span>
01566 <span class="comment">     *     $eg-&gt;set_host($host);</span>
01567 <span class="comment">     *     $eg-&gt;set_password($passwd);</span>
01568 <span class="comment">     *     $eg-&gt;set_passphrase($passphrase);</span>
01569 <span class="comment">     *     $eg-&gt;set_work_dir("/tmp/grid/test/cless");</span>
01570 <span class="comment">     *     $eg-&gt;set_error_log("/tmp/grid/test/cless/connection.err");</span>
01571 <span class="comment">     *     echo "initializing grid... ";</span>
01572 <span class="comment">     *     if (!$eg-&gt;initialize())</span>
01573 <span class="comment">     *          echo "error: couldn't init the grid\n";</span>
01574 <span class="comment">     *     else</span>
01575 <span class="comment">     *          echo "OK\n";</span>
01576 <span class="comment">     *     echo "Submitting tst-job... ";</span>
01577 <span class="comment">     *     if (! $eg-&gt;job_submit("tst-job", $out))</span>
01578 <span class="comment">     *          echo "error: coudn't start the job\n";</span>
01579 <span class="comment">     *     else </span>
01580 <span class="comment">     *          echo "OK\n";</span>
01581 <span class="comment">     *     print_r($out);</span>
01582 <span class="comment">     *     print_r($eg-&gt;job_get_id("tst-job"));</span>
01583 <span class="comment">     * &lt;/code&gt;</span>
01584 <span class="comment">     *</span>
01585 <span class="comment">     *  @param  string  The name of the job you submitted to the grid</span>
01586 <span class="comment">     *  @param  string Optionally identifies the session to which the job</span>
01587 <span class="comment">     *                  belongs (if it was submitted within one).</span>
01588 <span class="comment">     *</span>
01589 <span class="comment">     *  @return array|false with the known job-id's submitted from this</span>
01590 <span class="comment">     *          'job'. That looks as an oxymoron: there should only be</span>
01591 <span class="comment">     *          one. Ergo, you may use it to detect job name clashes or</span>
01592 <span class="comment">     *          job re-submissions.</span>
01593 <span class="comment">     *</span>
01594 <span class="comment">     *  @note this is nasty and should be enhanced on a future version.</span>
01595 <span class="comment">     */</span>
01596     function <a class="code" href="classGrid.html#a22">job_get_id</a>($job, $session='<span class="keywordflow">default</span>')
01597     {
01598         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
01599         <a class="code" href="grid__test_8php.html#a0">$debug_grid</a> = TRUE;
01600         
01601         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::job_get_id($job, $session)\n"</span>;
01602             
01603         <span class="comment">// check this first as it is cheaper</span>
01604         <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classGrid.html#a15">session_is_valid</a>($session))
01605         {       
01606             <span class="keywordflow">return</span> FALSE;
01607         }
01608             
01609         $sd = $this-&gt;sessions[$session];
<a name="l01610"></a><a class="code" href="classGrid.html#a22">01610</a>         
01611         <span class="comment">// if we have been called successfully previously, then</span>
01612         <span class="comment">//  we have a cached copy of the 'identifier.txt' file locally.</span>
01613         <span class="comment">//  Use it instead and save bandwidth.</span>
01614         <span class="comment">// identifier.txt is of the form</span>
01615         <span class="comment">//      ###Submitted Job Ids###</span>
01616         <span class="comment">//      https://rb1.egee.fr.cgg.com:9000/entEU8ZO4LlP6ZMVcpryog</span>
01617         <span class="keywordflow">if</span> (file_exists(<span class="stringliteral">"$job/identifier.txt"</span>))
01618             <span class="keywordflow">return</span> preg_grep(<span class="stringliteral">"/^https:/"</span>, file(<span class="stringliteral">"$job/identifier.txt"</span>));
01619         
01620         <span class="comment">// identifier.txt is not cached locally, grab it from remote entry point</span>
01621         <span class="comment">// as it should have been created during submission</span>
01622         <span class="comment">// we just need a valid connection</span>
01623         <span class="keywordflow">if</span> (! $this-&gt;connected)
01624             <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classGrid.html#a10">connect</a>())
01625             {   
01626                    <span class="keywordflow">return</span> FALSE;
01627             }
01628         <span class="comment">// we may have received a long pathname, but only care about</span>
01629         <span class="comment">// its last component remotely</span>
01630         $remote_dir = basename($job);
01631         
01632         <span class="comment">/* </span>
01633 <span class="comment">                $tatus is all the times != 0</span>
01634 <span class="comment">                CHANGE THIS</span>
01635 <span class="comment">                </span>
01636 <span class="comment">        // check if the remote file exists</span>
01637 <span class="comment">        $status = $this-&gt;sx-&gt;ssh_exec(</span>
01638 <span class="comment">            "test -f $this-&gt;work_dir/$sd/$remote_dir/identifier.txt 2&gt;&amp;1", $out);</span>
01639 <span class="comment">            </span>
01640 <span class="comment">        if ($status != 0) {</span>
01641 <span class="comment">            // destination does not exists or is not a file</span>
01642 <span class="comment">            if ($debug_grid) echo "*** $sd/$job/identifier.txt does not exist\n";</span>
01643 <span class="comment">            warning("Get job ID: remote grid job ID does not exist");</span>
01644 <span class="comment">            return FALSE;</span>
01645 <span class="comment">        }</span>
01646 <span class="comment">        */</span>
01647         
01648         $this-&gt;sx-&gt;ssh_exec(<span class="stringliteral">"test -f $this-&gt;work_dir/$sd/$remote_dir/identifier.txt 2&gt;&amp;1"</span>, $out);
01649         
01650         $status = $this-&gt;sx-&gt;ssh_copy_from(<span class="stringliteral">"$this-&gt;work_dir/$sd/$remote_dir/identifier.txt"</span>, $job, $out);
01651             
01652         <span class="keywordflow">if</span> ($status == FALSE) {
01653             <a class="code" href="test_2util_8php.html#a2">warning</a>(<span class="stringliteral">"Get job ID: could not retrieve grid job ID"</span>);
01654             <span class="keywordflow">return</span> FALSE;
01655         }
01656         <span class="keywordflow">else</span> {
01657             <span class="comment">//$id = preg_grep("/^https:/", file("$job/identifier.txt");</span>
01658             <span class="comment">// return $id;</span>
01659             <span class="keywordflow">return</span> preg_grep(<span class="stringliteral">"/^https:/"</span>, file(<span class="stringliteral">"$job/identifier.txt"</span>));
01660         }
01661         <span class="comment">// NOTE: this returns an array of \n terminated strings, which is</span>
01662         <span class="comment">// highly inconvenient. REVIEW</span>
01663     }
01664 <span class="comment"></span>
01665 <span class="comment">    /**</span>
01666 <span class="comment">     * check job status</span>
01667 <span class="comment">     *</span>
01668 <span class="comment">     *  This routine retrieves the job status report from the remote</span>
01669 <span class="comment">     * grid entry point into your local job directory, and returns the</span>
01670 <span class="comment">     * status of your specified job/session.</span>
01671 <span class="comment">     *</span>
01672 <span class="comment">     * Sample usage:</span>
01673 <span class="comment">     * &lt;code&gt;</span>
01674 <span class="comment">     *     $eg = new Grid;</span>
01675 <span class="comment">     *     $eg-&gt;set_user($user);</span>
01676 <span class="comment">     *     $eg-&gt;set_host($host);</span>
01677 <span class="comment">     *     $eg-&gt;set_password($passwd);</span>
01678 <span class="comment">     *     $eg-&gt;set_passphrase($passphrase);</span>
01679 <span class="comment">     *     $eg-&gt;set_work_dir("/tmp/grid/test/cless");</span>
01680 <span class="comment">     *     $eg-&gt;set_error_log("/tmp/grid/test/cless/connection.err");</span>
01681 <span class="comment">     *     echo "initializing grid... ";</span>
01682 <span class="comment">     *     if (!$eg-&gt;initialize())</span>
01683 <span class="comment">     *          echo "error: couldn't init the grid\n";</span>
01684 <span class="comment">     *     else</span>
01685 <span class="comment">     *          echo "OK\n";</span>
01686 <span class="comment">     *     echo "Submitting tst-job... ";</span>
01687 <span class="comment">     *     if (! $eg-&gt;job_submit("tst-job", $out))</span>
01688 <span class="comment">     *          echo "error: coudn't start the job\n";</span>
01689 <span class="comment">     *     else </span>
01690 <span class="comment">     *          echo "OK\n";</span>
01691 <span class="comment">     *     print_r($out);</span>
01692 <span class="comment">     *     echo "\nGetting job ID... \n";</span>
01693 <span class="comment">     *     print_r($eg-&gt;job_get_id("tst-job"));</span>
01694 <span class="comment">     *     echo "\nGetting job status... \n";</span>
01695 <span class="comment">     *     print_r($eg-&gt;job_status("tst-job", $out));</span>
01696 <span class="comment">     * &lt;/code&gt;</span>
01697 <span class="comment">     * </span>
01698 <span class="comment">     *  @param  string  The name of the job you submitted to the grid</span>
01699 <span class="comment">     *  @param  string  Output of the status request program. Useful for</span>
01700 <span class="comment">     *                  debugging.</span>
01701 <span class="comment">     *  @param  string Optionally identifies the session to which the job</span>
01702 <span class="comment">     *                  belongs (if it was submitted within one).</span>
01703 <span class="comment">     *</span>
01704 <span class="comment">     *  @return array|false an array containing the job status or FALSE on</span>
01705 <span class="comment">     *                  failure.</span>
01706 <span class="comment">     */</span>
01707     function <a class="code" href="classGrid.html#a23">job_status</a>($job, &amp;$out, $session='<span class="keywordflow">default</span>')
01708     {
01709         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
01710         <a class="code" href="grid__test_8php.html#a0">$debug_grid</a> = TRUE;
01711         
01712         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::job_status($job, $out, $session)\n"</span>;
01713         
01714         <span class="comment">// check this first as it is cheaper</span>
01715         <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classGrid.html#a15">session_is_valid</a>($session))
01716         {
01717             <span class="keywordflow">return</span> FALSE;
01718         }
01719         $sd = $this-&gt;sessions[$session];
01720             
<a name="l01721"></a><a class="code" href="classGrid.html#a23">01721</a>         <span class="comment">// we need an initialized grid</span>
01722         <span class="keywordflow">if</span> (! $this-&gt;initialized)
01723             <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classGrid.html#a11">initialize</a>())
01724             {
01725                  <span class="keywordflow">return</span> FALSE;
01726             }
01727         
01728         $rjob = basename($job);
01729         $job_id = $this-&gt;<a class="code" href="classGrid.html#a22">job_get_id</a>($rjob, $session);
01730         
01731         <span class="keywordflow">if</span> ($job_id == FALSE)
01732             <span class="keywordflow">return</span> FALSE;
01733         
01734         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>)
01735             echo <span class="stringliteral">"Sending\n\t"</span> .
01736                 <span class="stringliteral">"(export EDG_WL_LOCATION=/opt/edg ; "</span> .
01737                 <span class="stringliteral">"/opt/edg/bin/edg-job-status "</span>. $job_id .<span class="stringliteral">")"</span>;
01738         <span class="comment">/*      </span>
01739 <span class="comment">        $status = $this-&gt;sx-&gt;ssh_exec(</span>
01740 <span class="comment">            "(" .</span>
01741 <span class="comment">            ". /etc/bashrc ; " .</span>
01742 <span class="comment">            "export EDG_WL_LOCATION=/opt/edg ; " .</span>
01743 <span class="comment">            "/opt/edg/bin/edg-job-status ". $job_id[1] . </span>
01744 <span class="comment">            //"/opt/edg/bin/edg-job-status ". $job_id .</span>
01745 <span class="comment">            ")",</span>
01746 <span class="comment">            $out);</span>
01747 <span class="comment">            </span>
01748 <span class="comment">        if ($status != 0)</span>
01749 <span class="comment">            return FALSE;</span>
01750 <span class="comment">        else</span>
01751 <span class="comment">            return $out;</span>
01752 <span class="comment">        */</span>
01753         
01754         $this-&gt;sx-&gt;ssh_exec(
01755             <span class="stringliteral">"("</span> .
01756             <span class="stringliteral">". /etc/bashrc ; "</span> .
01757             <span class="stringliteral">"export EDG_WL_LOCATION=/opt/edg ; "</span> .
01758             <span class="stringliteral">"/opt/edg/bin/edg-job-status "</span>. $job_id[1] . 
01759             <span class="stringliteral">")"</span>,
01760             $out);
01761         <span class="keywordflow">return</span> $out;
01762         
01763         <span class="comment">/* </span>
01764 <span class="comment">            NOTE: Format of the output array:</span>
01765 <span class="comment">            [0]</span>
01766 <span class="comment">            [1]</span>
01767 <span class="comment">            [2]*************************************************************</span>
01768 <span class="comment">            [3]BOOKKEEPING INFORMATION:</span>
01769 <span class="comment">            [4]</span>
01770 <span class="comment">            [5]Status info for the Job : https://rb1.egee.fr.cgg.com:9000/entEU8ZO4LlP6ZMVcpryog</span>
01771 <span class="comment">            [6]Current Status:     Scheduled </span>
01772 <span class="comment">            [7]Status Reason:      Job successfully submitted to Globus</span>
01773 <span class="comment">            [8]Destination:        ce00.inta.es:2119/jobmanager-lcgpbs-biomed</span>
01774 <span class="comment">            [9]reached on:         Mon Aug 29 12:37:05 2005</span>
01775 <span class="comment">            [10]*************************************************************</span>
01776 <span class="comment">            [11]</span>
01777 <span class="comment">        */</span>
01778     }
01779     <span class="comment"></span>
01780 <span class="comment">    /**</span>
01781 <span class="comment">     * retrieve results</span>
01782 <span class="comment">     *</span>
01783 <span class="comment">     *  Retrieve the results of a job from the Grid. This function will</span>
01784 <span class="comment">     * attempt to retrieve the results of a job. This relies on the results</span>
01785 <span class="comment">     * being already available, i.e. you better check the job status first</span>
01786 <span class="comment">     * and make sure it has completed.</span>
01787 <span class="comment">     *</span>
01788 <span class="comment">     *  If you don't, and the job hasn't completed yet, don't worry: nothing</span>
01789 <span class="comment">     * will be retrieved. So, no harm done. But you should check stdout to</span>
01790 <span class="comment">     * verify the condition.</span>
01791 <span class="comment">     *</span>
01792 <span class="comment">     *  All results will be stored remotely on the job directory, under a</span>
01793 <span class="comment">     * subdirectory with a unique name of the form $grid_user_name_XXXXX...</span>
01794 <span class="comment">     * where the X's mean a random string. Locally you will see them as</span>
01795 <span class="comment">     *  $job/job_output so that they have an easy name to identify them.</span>
01796 <span class="comment">     *</span>
01797 <span class="comment">     *  To access your job output, just open this $job/output directory</span>
01798 <span class="comment">     * and look inside.</span>
01799 <span class="comment">     *</span>
01800 <span class="comment">     *  The rationale for this is to avoid overwriting your job information</span>
01801 <span class="comment">     * with its output. If that was intended, nothing is lost, just pick-up</span>
01802 <span class="comment">     * the newly generated file. This way you always have continued access </span>
01803 <span class="comment">     * to your old, submitted data for checking.</span>
01804 <span class="comment">     *</span>
01805 <span class="comment">     * Sample usage:</span>
01806 <span class="comment">     * &lt;code&gt;</span>
01807 <span class="comment">     *     $eg = new Grid;</span>
01808 <span class="comment">     *     $eg-&gt;set_user($user);</span>
01809 <span class="comment">     *     $eg-&gt;set_host($host);</span>
01810 <span class="comment">     *     $eg-&gt;set_password($passwd);</span>
01811 <span class="comment">     *     $eg-&gt;set_passphrase($passphrase);</span>
01812 <span class="comment">     *     $eg-&gt;set_work_dir("/tmp/grid/test/cless");</span>
01813 <span class="comment">     *     $eg-&gt;set_error_log("/tmp/grid/test/cless/connection.err");</span>
01814 <span class="comment">     *     echo "initializing grid... ";</span>
01815 <span class="comment">     *     if (!$eg-&gt;initialize())</span>
01816 <span class="comment">     *          echo "error: couldn't init the grid\n";</span>
01817 <span class="comment">     *     else</span>
01818 <span class="comment">     *          echo "OK\n";</span>
01819 <span class="comment">     *     echo "Submitting tst-job... ";</span>
01820 <span class="comment">     *     if (! $eg-&gt;job_submit("tst-job", $out))</span>
01821 <span class="comment">     *        echo "error: coudn't start the job\n";</span>
01822 <span class="comment">     *     else </span>
01823 <span class="comment">     *        echo "OK\n";</span>
01824 <span class="comment">     *     print_r($out);</span>
01825 <span class="comment">     *     echo "\nGetting job ID... \n";</span>
01826 <span class="comment">     *     print_r($eg-&gt;job_get_id("tst-job"));</span>
01827 <span class="comment">     *     echo "\nGetting job status... \n";</span>
01828 <span class="comment">     *     print_r($eg-&gt;job_status("tst-job", $out));</span>
01829 <span class="comment">     *     echo "\nGetting job output... ";</span>
01830 <span class="comment">     *     if (! $eg-&gt;job_get_output("tst-job", $out))</span>
01831 <span class="comment">     *          echo "error: couldn't get job output\n";</span>
01832 <span class="comment">     *     else</span>
01833 <span class="comment">     *          echo "OK\n";</span>
01834 <span class="comment">     *     print_r($out);</span>
01835 <span class="comment">     * &lt;/code&gt;</span>
01836 <span class="comment">     *</span>
01837 <span class="comment">     *  @param  string  The name of the job you submitted to the grid</span>
01838 <span class="comment">     *  @param  string Optionally identifies the session to which the job</span>
01839 <span class="comment">     *                  belongs (if it was submitted within one). If this</span>
01840 <span class="comment">     *                  is not specified, then the default session is used.</span>
01841 <span class="comment">     *  @return bool TRUE on success, FALSE on failure.</span>
01842 <span class="comment">     */</span>
01843     function <a class="code" href="classGrid.html#a24">job_get_output</a>($job, &amp;$out, $session='<span class="keywordflow">default</span>')
01844     {
01845         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
01846         
01847         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::job_get_output($job, $out, $session)\n"</span>;
01848         
01849         <span class="comment">// check this first as it is cheaper</span>
01850         <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classGrid.html#a15">session_is_valid</a>($session))
01851             <span class="keywordflow">return</span> FALSE;
01852         $sd = $this-&gt;sessions[$session];
01853             
01854         <span class="comment">// we need an initialized grid</span>
01855         <span class="keywordflow">if</span> (! $this-&gt;initialized)
01856             <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classGrid.html#a11">initialize</a>())
<a name="l01857"></a><a class="code" href="classGrid.html#a24">01857</a>                 <span class="keywordflow">return</span> FALSE;
01858         
01859         $rjob = basename($job);
01860         $job_id = $this-&gt;<a class="code" href="classGrid.html#a22">job_get_id</a>($rjob, $session);
01861         
01862         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) print_r($job_id);
01863 
01864         <span class="comment">// check if output has already been retrieved from the grid</span>
01865         $status = $this-&gt;sx-&gt;ssh_exec(
01866             <span class="stringliteral">"test -d "</span>.$this-&gt;work_dir.<span class="stringliteral">"/$sd/$rjob/"</span>.$this-&gt;username.<span class="stringliteral">"_* 2&gt;&amp;1"</span>, $out);
01867         unset($out);
01868         <span class="keywordflow">if</span> ($status != 0) {
01869             <span class="comment">// results have not been recovered yet, retrieve them</span>
01870             $status = $this-&gt;sx-&gt;ssh_exec(
01871                     <span class="stringliteral">"("</span> .
01872                     <span class="stringliteral">" . /etc/bashrc ; "</span> .
01873                     <span class="stringliteral">"export EDG_WL_LOCATION=/opt/edg ; "</span> .
01874                     <span class="stringliteral">"export PATH=/opt/globus/bin:/opt/edg/bin:\$PATH ;"</span> .
01875                     <span class="stringliteral">"/opt/edg/bin/edg-job-get-output "</span> .
01876                     <span class="stringliteral">"--dir "</span>.$this-&gt;work_dir.<span class="stringliteral">"/$sd/$rjob "</span>.
01877                     $job_id[1]. 
01878                     <span class="comment">//$job_id</span>
01879                     <span class="stringliteral">")"</span>,
01880                     $out);
01881             <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) {
01882                 print_r($out);
01883             }
01884             <span class="keywordflow">if</span> ($status != 0)
01885                 <span class="keywordflow">return</span> FALSE;
01886         }
01887 
01888         <span class="comment">// copy over to local 'output' directory</span>
01889         <span class="comment">//  We want to provide a well known name</span>
01890         $status = $this-&gt;sx-&gt;ssh_copy_from(
01891             <span class="stringliteral">"$this-&gt;work_dir/$sd/$rjob/"</span>.
01892               $this-&gt;username.<span class="stringliteral">"_*"</span>,
01893             <span class="stringliteral">"$job/job_output"</span>, $out);
01894         <span class="keywordflow">return</span> $status;
01895 
01896 <span class="comment">/* Alternate implementation for jobs submitted many times       </span>
01897 <span class="comment">        $all_done = TRUE;</span>
01898 <span class="comment">        foreach ($job_id as $i =&gt; $id) {</span>
01899 <span class="comment">            if ($debug_grid) echo "--&gt; retrieving job #$i ($id)\n";</span>
01900 <span class="comment">            $status = $this-&gt;sx-&gt;ssh_exec(</span>
01901 <span class="comment">                "(export EDG_WL_LOCATION=/opt/edg ; " .</span>
01902 <span class="comment">                " export PATH=/opt/globus/bin:/opt/edg/bin:\$PATH ;" .</span>
01903 <span class="comment">                "/opt/edg/bin/edg-job-get-output " .</span>
01904 <span class="comment">                "--dir $this-&gt;work_dir/$session/$rjob/ $id)",</span>
01905 <span class="comment">                $out);</span>
01906 <span class="comment">            if ($status == 0)</span>
01907 <span class="comment">                $status = $this-&gt;sx-&gt;ssh_copy_from(</span>
01908 <span class="comment">                    "'$this-&gt;work_dir/$this-&gt;session/$session/$rjob/".</span>
01909 <span class="comment">                      $this-&gt;username."_*'",</span>
01910 <span class="comment">                    $job);</span>
01911 <span class="comment">                if ($status = FALSE)</span>
01912 <span class="comment">                    $all_done = FALSE;</span>
01913 <span class="comment">            else</span>
01914 <span class="comment">                $all_done = FALSE;</span>
01915 <span class="comment">        }</span>
01916 <span class="comment">        return $all_done;</span>
01917 <span class="comment">*/</span>
01918     }
01919     <span class="comment"></span>
01920 <span class="comment">    /**</span>
01921 <span class="comment">     *  Cancel a job previously submitted to the grid</span>
01922 <span class="comment">     *</span>
01923 <span class="comment">     * Note: If the job has not reached the CE yet (i.e.: its status is WAITING </span>
01924 <span class="comment">     * or READY states), the cancellation request may be ignored, and the job </span>
01925 <span class="comment">     * may continue running, although a message of successful cancellation is </span>
01926 <span class="comment">     * returned to the user. In such cases, just cancel the job again when its </span>
01927 <span class="comment">     * status is SCHEDULED or RUNNING</span>
01928 <span class="comment">     *</span>
01929 <span class="comment">     *  @param  string  The name of the job you submitted to the grid</span>
01930 <span class="comment">     *  @param  string Optionally identifies the session to which the job</span>
01931 <span class="comment">     *                  belongs (if it was submitted within one). If this</span>
01932 <span class="comment">     *                  is not specified, then the default session is used.</span>
01933 <span class="comment">     *  @return bool TRUE on success, FALSE on failure.</span>
01934 <span class="comment">     */</span>
01935     function <a class="code" href="classGrid.html#a25">job_cancel</a>($job, &amp;$out, $session='<span class="keywordflow">default</span>')
01936     {
01937         global <a class="code" href="grid__test_8php.html#a0">$debug_grid</a>;
01938 
01939         <span class="keywordflow">if</span> (<a class="code" href="grid__test_8php.html#a0">$debug_grid</a>) echo <span class="stringliteral">"Grid::job_cancel($job, $out, $session)\n"</span>;
01940         
01941         <span class="comment">// check this first as it is cheaper</span>
01942         <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classGrid.html#a15">session_is_valid</a>($session))
01943             <span class="keywordflow">return</span> FALSE;
01944         $sd = $this-&gt;sessions[$session];
01945             
01946         <span class="comment">// we need an initialized grid</span>
01947         <span class="keywordflow">if</span> (! $this-&gt;initialized)
01948             <span class="keywordflow">if</span> (! $this-&gt;<a class="code" href="classGrid.html#a11">initialize</a>())
<a name="l01949"></a><a class="code" href="classGrid.html#a25">01949</a>                 <span class="keywordflow">return</span> FALSE;
01950         
01951         $rjob = basename($job);
01952         $job_id = $this-&gt;<a class="code" href="classGrid.html#a22">job_get_id</a>($rjob, $session);
01953         $out = array(<span class="stringliteral">""</span>);
01954         <span class="keywordflow">return</span> $this-&gt;sx-&gt;ssh_exec(
01955             <span class="stringliteral">"("</span>.
01956             <span class="stringliteral">". /etc/bashrc ;"</span> .
01957             <span class="stringliteral">"export EDG_WL_LOCATION=/opt/edg ; "</span> .
01958             <span class="stringliteral">"export PATH=/opt/globus/bin:/opt/edg/bin:\$PATH ;"</span> .
01959             <span class="stringliteral">"yes | /opt/edg/bin/edg-job-cancel "</span>.
01960             $job_id[1].
01961             <span class="stringliteral">")"</span>,
01962             $out);
01963     }
01964 }
01965 ?&gt;
01966 </pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Jun 22 10:01:09 2006 for php::Grid by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6 </small></address>
</body>
</html>
