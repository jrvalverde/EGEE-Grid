<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>egTinker: grid.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>grid.php</h1><a href="grid_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 &lt;?
00002 
00003 require_once(<span class="stringliteral">"./config.php"</span>);
00004 require_once(<span class="stringliteral">"./util.php"</span>);
00005 <span class="comment"></span>
00006 <span class="comment">/**</span>
00007 <span class="comment"> *  Grid access class</span>
00008 <span class="comment"> *</span>
00009 <span class="comment"> *  CAUTION: THIS CLASS IS UNDERGOING A GENERAL OVERHAUL. DO NOT USE</span>
00010 <span class="comment"> *  NOW.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> *  This class allows you to connect to a remote Grid UI server and</span>
00013 <span class="comment"> *  launch and monitor jobs on it.</span>
00014 <span class="comment"> *</span>
00015 <span class="comment"> *  The reason for this class is mostly one of resilience: if you </span>
00016 <span class="comment"> *  put all your services directly on a GrUI host, then whenever </span>
00017 <span class="comment"> *  that host if offline, your services will be as well.</span>
00018 <span class="comment"> *</span>
00019 <span class="comment"> *  An alternative is to replicate the services on various GrUI nodes.</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> *  Or better yet: use this class and set up your services wherever</span>
00022 <span class="comment"> *  you want. You may put them on an HA system and ensure this way </span>
00023 <span class="comment"> *  their continuous availability. Your service will be always up</span>
00024 <span class="comment"> *  and running, ready to accept jobs.</span>
00025 <span class="comment"> *</span>
00026 <span class="comment"> *  Your next problem is dealing with the Grid UI. You still need</span>
00027 <span class="comment"> *  to log-in on a Grid access point to submit your jobs. But once</span>
00028 <span class="comment"> *  you have detached from a specific GrUI node, you are free to</span>
00029 <span class="comment"> *  attempt a connection to a given remote access point, and if it</span>
00030 <span class="comment"> *  is available (and while it is) submit jobs as needed. If at any</span>
00031 <span class="comment"> *  time it is not available, nothing is lost: just look for another</span>
00032 <span class="comment"> *  one and use this to continue working. You may thus enter the</span>
00033 <span class="comment"> *  grid through any door.</span>
00034 <span class="comment"> *</span>
00035 <span class="comment"> *  There is a side advantage too: with your services on a GrUI node</span>
00036 <span class="comment"> *  you can only launch jobs from it. With your services detached from</span>
00037 <span class="comment"> *  any given Grid door, you may use _any_ AND _as many_ as you want:</span>
00038 <span class="comment"> *  this means you may launch jobs using various GrUI nodes simultaneously</span>
00039 <span class="comment"> *  if you so wish. And even split the jobs througho various, separate </span>
00040 <span class="comment"> *  Grids if you feel like it, hence potentially increasing your </span>
00041 <span class="comment"> *  throughput and computing power, harnessing even more resources.</span>
00042 <span class="comment"> *</span>
00043 <span class="comment"> *  Detaching your jobs from the GrUI has one serious drawback though:</span>
00044 <span class="comment"> *  all your job information must travel from your service user interface</span>
00045 <span class="comment"> *  to the grid user interface through the Internet, which may be</span>
00046 <span class="comment"> *  potentially dangerous. We deal with this security issue using SSH</span>
00047 <span class="comment"> *  to handle all communications and provide encryption. As long as </span>
00048 <span class="comment"> *  you use strong passwords you may feel secure. Actually, it is as</span>
00049 <span class="comment"> *  weak (or strong) as working directly on the GrUI node: access to</span>
00050 <span class="comment"> *  it is still managed by standard password mechanisms and subject to</span>
00051 <span class="comment"> *  the same types of attacks. However, remember you now have an extra</span>
00052 <span class="comment"> *  system (the front-end) to maintain and secure. Please, be always</span>
00053 <span class="comment"> *  cautious with any server you use.</span>
00054 <span class="comment"> *</span>
00055 <span class="comment"> *  Sounds convincing? Then read ahead to learn how to use this class.</span>
00056 <span class="comment"> *</span>
00057 <span class="comment"> *  Using this class you may access the Grid in two different ways:</span>
00058 <span class="comment"> *  connected or disconnected mode (or if you prefer, using persistent</span>
00059 <span class="comment"> *  connections or disconnected mode).</span>
00060 <span class="comment"> *</span>
00061 <span class="comment"> *  It is important to understand the differences among them:</span>
00062 <span class="comment"> *</span>
00063 <span class="comment"> *  PERSISTENT CONNECTIONS</span>
00064 <span class="comment"> *</span>
00065 <span class="comment"> *  When working with persistent connections, you first issue a</span>
00066 <span class="comment"> *  Grid::connect() call to stablish a connection to the GrUI. This will</span>
00067 <span class="comment"> *  be kept open during all the time until you call Grid::disconnect().</span>
00068 <span class="comment"> *  All commands issued will travel over the same wire, and hence </span>
00069 <span class="comment"> *  communications will be more efficient.</span>
00070 <span class="comment"> *</span>
00071 <span class="comment"> *  Output of all your commands is collected on a single I/O channel</span>
00072 <span class="comment"> *  that persists during the whole session.</span>
00073 <span class="comment"> *</span>
00074 <span class="comment"> *  On the minus side, persistent connections drive all communications</span>
00075 <span class="comment"> *  between your front-end and the grid access point through pipes, and</span>
00076 <span class="comment"> *  are subject to serious deadlock problems. You must make sure you</span>
00077 <span class="comment"> *  avoid them by clearing periodically the communication buffers. In</span>
00078 <span class="comment"> *  addition, error checking is relayed to YOU: all information will </span>
00079 <span class="comment"> *  travel through the persistent I/O channels, and it will be YOUR</span>
00080 <span class="comment"> *  responsability to detect errors and act accordingly. Debugging is</span>
00081 <span class="comment"> *  thus more difficult.</span>
00082 <span class="comment"> *</span>
00083 <span class="comment"> *  DISCONNECTED MODE</span>
00084 <span class="comment"> *</span>
00085 <span class="comment"> *  When working in disconnected mode, the connections are open and</span>
00086 <span class="comment"> *  closed for each command you issue. This imposes a heavier tax</span>
00087 <span class="comment"> *  on your communications, which may become serious for submitting</span>
00088 <span class="comment"> *  huge numbers of jobs.</span>
00089 <span class="comment"> *</span>
00090 <span class="comment"> *  Each command will return its output separately since it uses a</span>
00091 <span class="comment"> *  new I/O channel every time.</span>
00092 <span class="comment"> *</span>
00093 <span class="comment"> *  On the plus side, you will retrieve job completion status inmediately</span>
00094 <span class="comment"> *  and won't risk deadlocks while running remote jobs. Development and</span>
00095 <span class="comment"> *  debugging will be a lot easier.</span>
00096 <span class="comment"> *</span>
00097 <span class="comment"> *  JOB MANAGEMENT</span>
00098 <span class="comment"> *</span>
00099 <span class="comment"> *  In order to submit your jobs to the grid you need to understand how</span>
00100 <span class="comment"> *  job management has been defined for this class. On the command line</span>
00101 <span class="comment"> *  you would have a lot more versatility, but to make this class more</span>
00102 <span class="comment"> *  useful some compromises had to be reached. We have defined a strict</span>
00103 <span class="comment"> *  protocol to generate/prepare your jobs before submitting them to</span>
00104 <span class="comment"> *  the grid, and you must stick to it if you want to avoid problems.</span>
00105 <span class="comment"> *</span>
00106 <span class="comment"> *  To understand why this has been designed the way it is, you should</span>
00107 <span class="comment"> *  keep in mind that you will be preparing your jobs on one (or many)</span>
00108 <span class="comment"> *  front-end and submitting them from it to one (or many) GrUI nodes.</span>
00109 <span class="comment"> *  Further to it, this has been designhed to make it easy to deploy</span>
00110 <span class="comment"> *  web-based services for users. Therefore many similar jobs might</span>
00111 <span class="comment"> *  be launched simultaneously and we need some way to avoid collusion</span>
00112 <span class="comment"> *  among them. To avoid one job stepping over other we must isolate</span>
00113 <span class="comment"> *  every one from each other. This means providing an isolated environment</span>
00114 <span class="comment"> *  for every job.</span>
00115 <span class="comment"> *</span>
00116 <span class="comment"> *  The easiest way to achieve our goal is to have every job submitted</span>
00117 <span class="comment"> *  placed on an independent directory (which we pair to the job name). </span>
00118 <span class="comment"> *  For single jobs, this means that you should make sure that no two </span>
00119 <span class="comment"> *  potentially simultaneous/overlapping jobs have the same name (i.e. </span>
00120 <span class="comment"> *  are stored in the same directory so there is no risk one overwrites</span>
00121 <span class="comment"> *  files of the other).</span>
00122 <span class="comment"> *</span>
00123 <span class="comment"> *  Sometimes this may result inconvenient to you. E.g. if your whole job</span>
00124 <span class="comment"> *  is submitted split into many separate sub-jobs (which each is a separate</span>
00125 <span class="comment"> *  job from the point of view of the grid) you may want to follow some</span>
00126 <span class="comment"> *  naming convention for your sub-jobs that makes it easier to identify</span>
00127 <span class="comment"> *  and keep track of them. In this case, if you had two simultaneous</span>
00128 <span class="comment"> *  runs, then the names would collide.</span>
00129 <span class="comment"> *</span>
00130 <span class="comment"> *  For example, let's say you are rendering frames of a movie and want</span>
00131 <span class="comment"> *  to identify each job by frame number: 0000, 0001, 0002, 0003... If</span>
00132 <span class="comment"> *  you now try to generate a second movie while the first is being</span>
00133 <span class="comment"> *  processed, then the frames of the second movie (named as well 0000,</span>
00134 <span class="comment"> *  0001, etc...) would overwrite the frames of the first one.</span>
00135 <span class="comment"> *  Generating random names for each frame would be an option, but too</span>
00136 <span class="comment"> *  cumbersome and expensive as you would need to keep track of the</span>
00137 <span class="comment"> *  association of the random names with the actual frames.</span>
00138 <span class="comment"> *</span>
00139 <span class="comment"> *  To deal with this scenario we define 'sessions'. A session is identified</span>
00140 <span class="comment"> *  by a unique identifier, and guarantees that all jobs belonging to this</span>
00141 <span class="comment"> *  session are kept separate from similarly named jobs from other sessions.</span>
00142 <span class="comment"> *</span>
00143 <span class="comment"> *  Actually when you create a session, what we actually do is create</span>
00144 <span class="comment"> *  a subdirectory in the GrUI and direct all further jobs to this </span>
00145 <span class="comment"> *  subdirectory. This way, jobs of two sessions may have the same name</span>
00146 <span class="comment"> *  and not step into each other.</span>
00147 <span class="comment"> *</span>
00148 <span class="comment"> *  PREPARING JOBS FOR THE GRID</span>
00149 <span class="comment"> *</span>
00150 <span class="comment"> *  To prepare a job for the grid you must assign it a name. The same</span>
00151 <span class="comment"> *  preacutions that apply to any local job hold for your grid work too:</span>
00152 <span class="comment"> *  if various simultaneous jobs of the same kind may be run, then each</span>
00153 <span class="comment"> *  must be kept separate from the others by using a different name.</span>
00154 <span class="comment"> *</span>
00155 <span class="comment"> *  Once you have decided the name, you must create a directory locally</span>
00156 <span class="comment"> *  with the same name as your job. In this directory you must install</span>
00157 <span class="comment"> *  everything needed to run your job: executables, libraries, input</span>
00158 <span class="comment"> *  data and a JDL file.</span>
00159 <span class="comment"> *</span>
00160 <span class="comment"> *  The JDL file defines the work that we will ask the grid to carry</span>
00161 <span class="comment"> *  out. Since each single job gets its own directory, you will only</span>
00162 <span class="comment"> *  submit one JDL file for each, and to make processing easier, we</span>
00163 <span class="comment"> *  request that this JDL file have a fixed name: "job.jdl".</span>
00164 <span class="comment"> *</span>
00165 <span class="comment"> *  The grid processing will generate various auxiliary files, for internal</span>
00166 <span class="comment"> *  housekeeping. Again, for simplicity, we have chosen to call each of</span>
00167 <span class="comment"> *  them 'job.*', i.e. 'job.' something. This means that other than 'job.jdl'</span>
00168 <span class="comment"> *  you should NOT create any file named job.anything on your job directory</span>
00169 <span class="comment"> *  to avoid collusion with possible temporary files.</span>
00170 <span class="comment"> *</span>
00171 <span class="comment"> *  In brief, to prepare a job:</span>
00172 <span class="comment"> *  - select a name</span>
00173 <span class="comment"> *  - create a directory named after the job</span>
00174 <span class="comment"> *  - populate this directory with all files needed to run your job</span>
00175 <span class="comment"> *  - generate the file 'job.jdl' with the description of the work to</span>
00176 <span class="comment"> *    be carried out by the grid</span>
00177 <span class="comment"> *  - avoid having files named 'job.*' (starting with 'job.')</span>
00178 <span class="comment"> *</span>
00179 <span class="comment"> *  SUBMITTING JOBS TO THE GRID</span>
00180 <span class="comment"> *</span>
00181 <span class="comment"> *  First consider whether you will be using unique job names or if</span>
00182 <span class="comment"> *  you will follow a convenient naming convention that may cause name</span>
00183 <span class="comment"> *  collisions with other jobs.</span>
00184 <span class="comment"> *</span>
00185 <span class="comment"> *  If you feel pretty safe that the job name is unique (e.g. has been</span>
00186 <span class="comment"> *  generated using one or more random strings), then simply call the</span>
00187 <span class="comment"> *  appropriate *job_submit() function.</span>
00188 <span class="comment"> *</span>
00189 <span class="comment"> *  If you are using names that have low entropy or reusing names for</span>
00190 <span class="comment"> *  similar jobs then it is advisable that you first call one of the</span>
00191 <span class="comment"> *  *new_session() routines to ensure all your jobs will be kept isolated</span>
00192 <span class="comment"> *  from other similarly named jobs, and then use the *job_submit()</span>
00193 <span class="comment"> *  routines to send your jobs.</span>
00194 <span class="comment"> *</span>
00195 <span class="comment"> *  For the curious: when you submit your job, the directory and all</span>
00196 <span class="comment"> *  of its contents will be sent to the remote Grid UI selected and</span>
00197 <span class="comment"> *  then the 'job.jdl' will be submitted to the grid. In the process,</span>
00198 <span class="comment"> *  several files will be generated holding information about your</span>
00199 <span class="comment"> *  job identity in the grid context that will be kept for housekeeping</span>
00200 <span class="comment"> *  and future reference.</span>
00201 <span class="comment"> *</span>
00202 <span class="comment"> *  The above is to be kept in mind when submitting light or numerous</span>
00203 <span class="comment"> *  jobs: the transfer time may become sensibly relevant. Please do </span>
00204 <span class="comment"> *  take it into consideration in your equations when designing jobs</span>
00205 <span class="comment"> *  for the grid using this class. You may find it interesting to first</span>
00206 <span class="comment"> *  store all or some of your job data/execs on the grid and keep them</span>
00207 <span class="comment"> *  already there instead of having to copy them.</span>
00208 <span class="comment"> *</span>
00209 <span class="comment"> *  Grid file management routines are not included yet, but are intended</span>
00210 <span class="comment"> *  for a future release of this class.</span>
00211 <span class="comment"> *</span>
00212 <span class="comment"> */</span>
<a name="l00213"></a><a class="code" href="classGrid.html">00213</a> <span class="keyword">class </span><a class="code" href="classGrid.html">Grid</a> {
00214 
<a name="l00215"></a><a class="code" href="classGrid.html#o0">00215</a>     var <a class="code" href="classGrid.html#o0">$entry_point</a>;   <span class="comment">/**&lt; the grid entry point, should not be needed */</span>
<a name="l00216"></a><a class="code" href="classGrid.html#o1">00216</a>     var <a class="code" href="classGrid.html#o1">$username</a>;      <span class="comment">/**&lt; user name to use to connect to the grid */</span>
<a name="l00217"></a><a class="code" href="classGrid.html#o2">00217</a>     var <a class="code" href="classGrid.html#o2">$hostname</a>;      <span class="comment">/**&lt; name of host that provides access to the grid */</span>
<a name="l00218"></a><a class="code" href="classGrid.html#o3">00218</a>     var <a class="code" href="classGrid.html#o3">$password</a>;      <span class="comment">/**&lt; password to login on the UI node */</span>
<a name="l00219"></a><a class="code" href="classGrid.html#o4">00219</a>     var <a class="code" href="classGrid.html#o4">$passphrase</a>;    <span class="comment">/**&lt; key to unlock the grid access certificate */</span>
<a name="l00220"></a><a class="code" href="classGrid.html#o5">00220</a>     var <a class="code" href="classGrid.html#o5">$work_dir</a>;      <span class="comment">/**&lt; a GrUI directory where we can work */</span>
<a name="l00221"></a><a class="code" href="classGrid.html#o6">00221</a>     var <a class="code" href="classGrid.html#o6">$error_log</a>;     <span class="comment">/**&lt; a local file to store the error log */</span>
00222     
<a name="l00223"></a><a class="code" href="classGrid.html#o7">00223</a>     var <a class="code" href="classGrid.html#o7">$std_in</a>;        <span class="comment">/**&lt; Internal. Standard input of the grid entry */</span>
<a name="l00224"></a><a class="code" href="classGrid.html#o8">00224</a>     var <a class="code" href="classGrid.html#o8">$std_out</a>;       <span class="comment">/**&lt; Internal. Standard output of the grid entry */</span>
<a name="l00225"></a><a class="code" href="classGrid.html#o9">00225</a>     var <a class="code" href="classGrid.html#o9">$std_err</a>;       <span class="comment">/**&lt; Internal. Standard error of the grid entry */</span>
00226                         <span class="comment">// !!! IMPORTANT !!! either:</span>
00227                         <span class="comment">//      a. set files to not hang on wait or</span>
00228                         <span class="comment">//      b. remember to set them to no-hang when needed</span>
00229 
<a name="l00230"></a><a class="code" href="classGrid.html#o10">00230</a>     var <a class="code" href="classGrid.html#o10">$connected</a>;     <span class="comment">/**&lt; Internal: Have we already connected? */</span>
<a name="l00231"></a><a class="code" href="classGrid.html#o11">00231</a>     var <a class="code" href="classGrid.html#o11">$initialized</a>;   <span class="comment">/**&lt; Internal: Have we already identified ourselves? */</span>
<a name="l00232"></a><a class="code" href="classGrid.html#o12">00232</a>     var <a class="code" href="classGrid.html#o12">$session</a>;       <span class="comment">/**&lt; Internal: A unique identifier for this session */</span>
<a name="l00233"></a><a class="code" href="classGrid.html#o13">00233</a>     var <a class="code" href="classGrid.html#o13">$sx</a>;            <span class="comment">/**&lt; Internal: The secure transfer communications line to use */</span>
00234     <span class="comment"></span>
00235 <span class="comment">    /**</span>
00236 <span class="comment">     * Constructor for the class</span>
00237 <span class="comment">     *</span>
00238 <span class="comment">     * Set the values for the class variables using defaults provided in</span>
00239 <span class="comment">     * 'config.php'</span>
00240 <span class="comment">     *</span>
00241 <span class="comment">     * These defaults can be overridden using the functions provided below.</span>
00242 <span class="comment">     */</span>
<a name="l00243"></a><a class="code" href="classGrid.html#a0">00243</a>     function <a class="code" href="classGrid.html#a0">Grid</a>() {
00244         $this-&gt;entry_point = $GLOBALS['grid_server'];
00245         $this-&gt;username    = $GLOBALS['grid_user'];
00246         $this-&gt;hostname    = $GLOBALS['grid_host'];
00247         $this-&gt;password    = $GLOBALS['grid_password'];
00248         $this-&gt;passphrase  = $GLOBALS['grid_passphrase'];
00249         $this-&gt;work_dir    = $GLOBALS['grid_wd_path'];
00250         $this-&gt;error_log   = $GLOBALS['grid_error_log'];
00251         $this-&gt;connected   = FALSE;
00252         $this-&gt;session     = <span class="stringliteral">""</span>;
00253         $this-&gt;sx          = <span class="keyword">new</span> <a class="code" href="classSExec.html">SExec</a>($this-&gt;entry_point, $this-&gt;password);
00254     }
00255     
00256     <span class="comment">// A C C E S S    V A R I A B L E    V A L U E S</span>
00257     <span class="comment">// Note: do we also need "get_XX" routines?</span>
00258 <span class="comment"></span>
00259 <span class="comment">    /**</span>
00260 <span class="comment">     * set the Grid user name</span>
00261 <span class="comment">     *</span>
00262 <span class="comment">     * @param user identity to use in the Grid UI host</span>
00263 <span class="comment">     */</span>
<a name="l00264"></a><a class="code" href="classGrid.html#a1">00264</a>     function <a class="code" href="classGrid.html#a1">set_user</a>($user)
00265     {
00266         $this-&gt;username = <a class="code" href="grid__test_8php.html#a1">$user</a>;
00267         $this-&gt;entry_point=<a class="code" href="grid__test_8php.html#a1">$user</a>.<span class="stringliteral">"</span><span class="stringliteral">@".$this-&gt;hostname;
    }
    </span><span class="comment"></span>
00268 <span class="comment">    /**</span>
00269 <span class="comment">     * set the name of the Grid access host</span>
00270 <span class="comment">     *</span>
00271 <span class="comment">     * @param host name of the remote UI host</span>
00272 <span class="comment">     */</span>
    function set_host($host)
    {
        $this-&gt;hostname = $host;
        $this-&gt;entry_point = $this-&gt;username."<span class="stringliteral">@".$host;
    }
    </span><span class="comment"></span>
00273 <span class="comment">    /**</span>
00274 <span class="comment">     * set the password for the remote grid user/server</span>
<a name="l00275"></a><a class="code" href="classGrid.html#a2">00275</a> <span class="comment">     *</span>
00276 <span class="comment">     *  This is specific to the remote UI server selected.</span>
00277 <span class="comment">     *</span>
00278 <span class="comment">     * @param pass password needed to login on to the grid UI server</span>
00279 <span class="comment">     */</span>
    function set_password($pass)
    {
        $this-&gt;password = $pass;
    }
<span class="comment"></span>
00280 <span class="comment">    /**</span>
00281 <span class="comment">     * set the passphrase for the remote grid user</span>
00282 <span class="comment">     *</span>
00283 <span class="comment">     *  This is grid-wise and independent of the UI-node used.</span>
00284 <span class="comment">     *</span>
00285 <span class="comment">     * @param pass passphrase needed to unlock the grid certificate</span>
00286 <span class="comment">     */</span>
    function set_passphrase($pass)
    {
        $this-&gt;passphrase = $pass;
    }
    <span class="comment"></span>
00287 <span class="comment">    /**</span>
<a name="l00288"></a><a class="code" href="classGrid.html#a3">00288</a> <span class="comment">     * set working directory on the Grid server</span>
00289 <span class="comment">     *</span>
00290 <span class="comment">     * @param work_dir the remote path of the working directory</span>
00291 <span class="comment">     */</span>
    function set_work_dir($wd)
    {
        $this-&gt;work_dir=$wd;
    }
    <span class="comment"></span>
00292 <span class="comment">    /**</span>
00293 <span class="comment">     * set error log</span>
00294 <span class="comment">     *</span>
00295 <span class="comment">     * @param errlog path to a local file where we will store the error log</span>
00296 <span class="comment">     *               (i.e. stderr of the grid connection)</span>
00297 <span class="comment">     */</span>
    function set_error_log($errlog)
    {
        $this-&gt;error_log = $errlog;
    }
    
    function get_connection_status()
    {
        return $this-&gt;connected;
    }

    function get_init_status()
    {
        return $this-&gt;initialized;
    }

//------ P E R S I S T E N T   G R I D   A C C E S S   F U N C T I O N S ------

    //
    // C O N N E C T    T O    T H E    U S E R    I N T E R F A C E   H O S T
    //
    <span class="comment"></span>
00298 <span class="comment">    /**</span>
00299 <span class="comment">     * open a persistent connection to the Grid UI server</span>
<a name="l00300"></a><a class="code" href="classGrid.html#a4">00300</a> <span class="comment">     * </span>
00301 <span class="comment">     *  The Grid User Interface Server is the entry point to the Grid</span>
00302 <span class="comment">     *  for users and user applications. This is where jobs are launched from.</span>
00303 <span class="comment">     * </span>
00304 <span class="comment">     *  This package has been designed to be able to be installed in any</span>
00305 <span class="comment">     *  host, independent of whether it is an UI or not. Thus, to be able to</span>
00306 <span class="comment">     *  submit jobs to the Grid, the server hosting the Web UI must connect to</span>
00307 <span class="comment">     *  a Grid UI host to do the work.</span>
00308 <span class="comment">     * </span>
00309 <span class="comment">     *  This routine opens a connection to a Grid UI host using an specified</span>
<a name="l00310"></a><a class="code" href="classGrid.html#a5">00310</a> <span class="comment">     *  username (i.e. all jobs will be run under said username). To allow the</span>
00311 <span class="comment">     *  caller to communicate with the remote end, it creates two pipes/pty, one for</span>
00312 <span class="comment">     *  input and one for output, and redirects error messages to a file.</span>
00313 <span class="comment">     *</span>
00314 <span class="comment">     *  We need to redirect stderr to a file. This is so to avoid blocking on</span>
00315 <span class="comment">     *  reading to check for errors and to avoid (if we use PTYs) interleave</span>
00316 <span class="comment">     *  of error messages and normal I/O.</span>
00317 <span class="comment">     * </span>
00318 <span class="comment">     *  These pipes lead to a child process that actually manages the </span>
00319 <span class="comment">     *  communication. Using a child process has several advantages: it simplifies</span>
00320 <span class="comment">     *  the communication process by offloading the comm. logic to a separate,</span>
<a name="l00321"></a><a class="code" href="classGrid.html#a6">00321</a> <span class="comment">     *  convenience tool, and by being able to use SSH as the child, we can increase</span>
00322 <span class="comment">     *  security taking advantage of its encryption capabilities.</span>
00323 <span class="comment">     * </span>
00324 <span class="comment">     *  The panorama therefore will look like this:</span>
00325 <span class="comment">     * </span>
<a name="l00326"></a><a class="code" href="classGrid.html#a7">00326</a> <span class="comment">     *  HTML front-end --&gt; processor.php &lt;--&gt; SSH &lt;--&gt; remote host &lt;--&gt; Grid</span>
00327 <span class="comment">     *</span>
00328 <span class="comment">     *  This allows for better resilience: should a GridUI host be </span>
00329 <span class="comment">     * unavailable, we can detect the error condition and try another </span>
00330 <span class="comment">     * one. If the GridUI runs the front-end, then we have a single</span>
<a name="l00331"></a><a class="code" href="classGrid.html#a8">00331</a> <span class="comment">     * point of failure, which is a no-no.</span>
00332 <span class="comment">     *</span>
00333 <span class="comment">     *  @note   Use of persistent connections is greatly DISCOURAGED:</span>
00334 <span class="comment">     * all I/O will go through pipes, and any end of the line may hang</span>
00335 <span class="comment">     * waiting on read (if there is nothing to be read at the other end)</span>
00336 <span class="comment">     * or write (if there is noone to retrieve the data at the other</span>
00337 <span class="comment">     * end).</span>
00338 <span class="comment">     *</span>
00339 <span class="comment">     *  Just picture this: you open a connection to a GridUI and the</span>
00340 <span class="comment">     * remote host issues an unusually large 'motd' that fills the</span>
00341 <span class="comment">     * pipe. The remote shell will hang waiting for someone to read and</span>
00342 <span class="comment">     * empty the pipe before continuing. Now, on the local side we do</span>
00343 <span class="comment">     * issue a remote command (without checking the output): we hang </span>
00344 <span class="comment">     * waiting for the other end to read it, but the other end is hung.</span>
00345 <span class="comment">     * Sadly a 'motd' may contain anything, and we can't predict what</span>
00346 <span class="comment">     * the remote prompt will look like...</span>
00347 <span class="comment">     *</span>
00348 <span class="comment">     *  Be careful. Be _very_ careful.</span>
00349 <span class="comment">     *</span>
00350 <span class="comment">     *  AND always consider setting the pipe ends to non-blocking status.</span>
00351 <span class="comment">     * This is actually the default, but has its tricks too. Be careful.</span>
00352 <span class="comment">     * Be _very_ careful.</span>
00353 <span class="comment">     *</span>
00354 <span class="comment">     *  @note   There is no easy way to know the exit status of a remote</span>
00355 <span class="comment">     * command while using persisten connections. Your only chance is to</span>
00356 <span class="comment">     * review the output log and check it yourself for error messages.</span>
00357 <span class="comment">     *</span>
00358 <span class="comment">     *  We could be doing better here, but for now we will leave this for</span>
00359 <span class="comment">     * later. After all, the point here is to give the user maximum</span>
00360 <span class="comment">     * efficiency.</span>
00361 <span class="comment">     *</span>
00362 <span class="comment">     *  @return TRUE on success, FALSE otherwise.</span>
00363 <span class="comment">     */</span>

    function pconnect()
    {   
        global $php_version;
        global $debug;
        
        // Open a child process with the 'proc_open' function. 
        //
        // Some tricks: we must open the connection using '-x' to disable
        // X11 forwarding, and use '-t -t' to avoid SSH generating an error
        // because we are not connected to any terminal.
        // NOTE:
        //   We require users to have an account and password on
        //   the UI and provide their user/password through the web or
        //   otherwise (e.g. using myproxy)
        //
        // NOTE: if the web server is trusted remotely (i.e. it's SSH public 
        // key is accepted in ~user@host:.ssh/authorized_keys) then any 
        // password will do.
        if ($php_version &lt; 5) {
            $descriptorspec = array(
                0 =&gt; array("pipe", <span class="stringliteral">"r"</span>),  <span class="comment">// connect child's stdin to the read end of a pipe</span>
00364                 1 =&gt; array(<span class="stringliteral">"pipe"</span>, <span class="stringliteral">"w"</span>),  <span class="comment">// connect child's stdout to the write end of a pipe</span>
00365                 2 =&gt; array(<span class="stringliteral">"file"</span>, $this-&gt;error_log, <span class="stringliteral">"a"</span>) <span class="comment">// stderr is a file to write to</span>
00366             );
00367             $this-&gt;process = proc_open(<span class="stringliteral">"SSH/SSH.sh $this-&gt;entry_point"</span>, 
00368                              $descriptorspec,
00369                              $pipes);
00370             <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>) echo <span class="stringliteral">"SSH/SSH.sh $this-&gt;entry_point\n"</span>;
00371             <span class="comment">// check status</span>
00372             <span class="keywordflow">if</span> (!is_resource($this-&gt;process)) 
00373             {
00374                 <a class="code" href="util_8php.html#a4">letal</a>(<span class="stringliteral">"Grid::connect"</span>, <span class="stringliteral">"cannot connect to the Grid"</span>);
00375                 <span class="keywordflow">return</span> $this-&gt;connected = FALSE;
00376             }
00377             <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>) echo <span class="stringliteral">"proc_open\n"</span>;
00378             <span class="comment">// give SSH it's due password</span>
00379             <span class="comment">// XXX - this might be better..</span>
00380             fwrite($pipes[0], <span class="stringliteral">"$this-&gt;password\n"</span>);
00381             <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>) echo <span class="stringliteral">"pwd sent: $this-&gt;password\n"</span>;
00382             fflush($pipes[0]);
00383          
00384         }
00385         <span class="keywordflow">else</span> {  <span class="comment">/* php5 -- we can use PTYs */</span>
00386                 <span class="comment">/* XXX -- untested -- probably unneeded */</span>
00387             $descriptorspec = array(
00388                 0 =&gt; array(<span class="stringliteral">"pty"</span>),
00389                 1 =&gt; array(<span class="stringliteral">"pty"</span>),
00390                 2 =&gt; array(<span class="stringliteral">"file"</span>, $this-&gt;error_log, <span class="stringliteral">"a"</span>)
00391             );
00392             $this-&gt;process = proc_open(<span class="stringliteral">"ssh -x -t -t $this-&gt;entry_point"</span>, 
00393                              $descriptorspec,
00394                              $pipes);
00395                 
00396             <span class="comment">// check status</span>
00397             <span class="keywordflow">if</span> (!is_resource($this-&gt;process)) 
00398             {
00399                 <a class="code" href="util_8php.html#a4">letal</a>(<span class="stringliteral">"Grid::connect"</span>, <span class="stringliteral">"cannot connect to the Grid"</span>);
00400                 <span class="keywordflow">return</span> $this-&gt;connected = FALSE;
00401             }
00402 
00403             <a class="code" href="results_8php.html#a2">$status</a> = proc_get_status($this-&gt;process);
00404             <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a>-&gt;running == FALSE) {
00405                 fclose($pipes[0]); fclose($pipes[1]); fclose($pipes[2]);
00406                 proc_close($this-&gt;process);
00407                 <a class="code" href="util_8php.html#a4">letal</a>(<span class="stringliteral">"Grid::connect"</span>, <span class="stringliteral">"connection exited "</span>.$status-&gt;exitcode);
00408                 <span class="keywordflow">return</span> $this-&gt;connected = FALSE;
<a name="l00409"></a><a class="code" href="classGrid.html#a9">00409</a>             }
00410             <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a>-&gt;signaled) {
00411                 fclose($pipes[0]); fclose($pipes[1]); fclose($pipes[2]);
00412                 proc_close($this-&gt;process);
00413                 <a class="code" href="util_8php.html#a4">letal</a>(<span class="stringliteral">"Grid::connect"</span>, <span class="stringliteral">"connection terminated by "</span>.$status-&gt;termsig);
00414                 <span class="keywordflow">return</span> $this-&gt;connected = FALSE;
00415             }
00416             <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a>-&gt;stopped) {
00417                 <span class="comment">// Tell the user and hope for the best</span>
00418                 <a class="code" href="util_8php.html#a2">warning</a>(<span class="stringliteral">"Grid::connect stopped by "</span>.$status-&gt;stopsig.
00419                 <span class="stringliteral">" it may still have a chance though"</span>);
00420             }
00421 
00422             <span class="comment">// Give ssh it's due password</span>
00423             $dummy = fgets($pipes[1],1024);     <span class="comment">/* wait for prompt */</span>
00424             <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>) echo $dummy.<span class="stringliteral">"\n"</span>;
00425             fwrite($pipes[0], <span class="stringliteral">"$this-&gt;password\n"</span>);
00426             fflush($pipes[0]);
00427 
00428         }
00429         
00430         <span class="comment">// $pipes now looks like this:</span>
00431         <span class="comment">//   0 =&gt; writeable handle connected to child stdin</span>
00432         <span class="comment">//   1 =&gt; readable handle connected to child stdout</span>
00433         <span class="comment">// Any error output will be appended to $wd_path/error-output.txt</span>
00434         $this-&gt;std_in = $pipes[0];
00435         $this-&gt;std_out = $pipes[1];
00436         $this-&gt;std_err = fopen($this-&gt;error_log, <span class="stringliteral">"r"</span>);
00437 
00438         <span class="comment">// We now have a connection to the remote Grid User Interface</span>
00439         <span class="comment">// Server which we may use to send commands/receive output</span>
00440         <span class="keywordflow">return</span> $this-&gt;connected = TRUE;
00441     }
00442 <span class="comment"></span>
00443 <span class="comment">    /**</span>
00444 <span class="comment">     * Close the connection with the remote Grid access point (UI node)</span>
00445 <span class="comment">     *</span>
00446 <span class="comment">     *  What we are going to do is close the communication pipes</span>
00447 <span class="comment">     *  and kill the child process that actually handles communication</span>
00448 <span class="comment">     *  with the remote Grid UI host (ssh).</span>
00449 <span class="comment">     *  This function returns the exit status of the connection (i.e. of</span>
00450 <span class="comment">     *  the intermediate program that handles the connection --in this</span>
00451 <span class="comment">     *  case SSH).</span>
00452 <span class="comment">     *</span>
00453 <span class="comment">     *  @return integer exit status of the connection (or the handling program)</span>
00454 <span class="comment">     */</span>
00455     function pdisconnect()
00456     {
00457         global <a class="code" href="config_8php.html#a21">$debug</a>;
00458         <span class="keywordflow">if</span> ($this-&gt;connected == FALSE)
00459                 <span class="keywordflow">return</span> $ret = 0;
00460 
00461         <span class="comment">// We need to close the 'child' process, otherwise the call to</span>
00462         <span class="comment">// the 'proc_close()' function hangs!!!</span>
00463         fwrite($this-&gt;std_in, <span class="stringliteral">"logout\n"</span>);
00464         fflush($this-&gt;std_in);
00465 
00466         fclose($this-&gt;std_in);
00467 
00468         <span class="comment">// The output from the commands</span>
00469         <span class="comment">//  Note that this may</span>
00470         <span class="comment">//      a) disrupt normal output</span>
00471         <span class="comment">//      b) get into an infinite loop if the child is in one</span>
00472         <span class="comment">//  But it is useful for debugging, hence here.</span>
00473         <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a> == TRUE)
00474             <span class="keywordflow">do</span> {
00475             
00476                 $line = fgets($this-&gt;std_out, 1024);
00477                 echo $line.<span class="stringliteral">"\n"</span>;
00478             } <span class="keywordflow">while</span> (!feof($this-&gt;std_out) &amp;&amp; (strlen($line) != 0));
00479 
00480         fclose($this-&gt;std_out);
00481 
00482         <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a> == TRUE)
00483             <span class="keywordflow">do</span> {
00484             
00485                 $line = fgets($this-&gt;std_err, 1024);
00486                 echo $line.<span class="stringliteral">"\n"</span>;
00487             } <span class="keywordflow">while</span> (!feof($this-&gt;std_err) &amp;&amp; (strlen($line) != 0));
00488 
00489         fclose($this-&gt;std_err);
00490 
00491         <span class="comment">// It's important that we close any open files before calling</span>
00492         <span class="comment">// proc_close in order to avoid a deadlock</span>
00493 
00494         <a class="code" href="auth_8php.html#a4">$return_value</a> = proc_close($this-&gt;process);
00495         
00496         $this-&gt;connected = FALSE;
00497 
00498         <span class="keywordflow">return</span> <a class="code" href="auth_8php.html#a4">$return_value</a>;   
00499     }
00500     
00501     <span class="comment">// I D E N T I F Y    T O    T H E    G R I D</span>
00502     <span class="comment"></span>
00503 <span class="comment">    /**</span>
00504 <span class="comment">     * Start the Grid services</span>
00505 <span class="comment">     *</span>
00506 <span class="comment">     *  This function starts the grid services on the remote UI server host.</span>
00507 <span class="comment">     *  This is done by unlocking the certificate that we are going to use </span>
00508 <span class="comment">     *  to run our jobs on the grid using the passphrase provided.</span>
00509 <span class="comment">     *</span>
00510 <span class="comment">     *  We need to have a connection open with the remote grid server as the </span>
00511 <span class="comment">     *  user with whose identity we want to run the jobs. This connection is</span>
00512 <span class="comment">     *  created by Grid::pconnect().</span>
00513 <span class="comment">     *</span>
00514 <span class="comment">     *  To ease things up, we check if we are already connected, and if we</span>
00515 <span class="comment">     *  aren't, we try to connect ourselves. That is, there is no need to</span>
00516 <span class="comment">     *  call Grid::Connect() first unless you want to do something else</span>
00517 <span class="comment">     *  on the Grid-UI before initializing the Grid.</span>
00518 <span class="comment">     *</span>
00519 <span class="comment">     *  Grid services have a lifetime of their own. By default they are</span>
00520 <span class="comment">     *  available for 12:00 hours (that's the default value of</span>
<a name="l00521"></a><a class="code" href="classGrid.html#a10">00521</a> <span class="comment">     *  grid-proxy-init itself), but their duration may be fine tuned</span>
00522 <span class="comment">     *  if we have some knowledge about the time required to run our</span>
00523 <span class="comment">     *  job.</span>
00524 <span class="comment">     *</span>
00525 <span class="comment">     *  Session duration is specified in hours+minutes. If the number of</span>
00526 <span class="comment">     *  minutes is negative, the specified minutes are substracted from</span>
00527 <span class="comment">     *  the specified hours (e.g: 1, -15 is fifteen minutes to one hour,</span>
00528 <span class="comment">     *  i.e. 45 minutes). If the total time specified is negative then</span>
00529 <span class="comment">     *  the default of 12:00 is used.</span>
00530 <span class="comment">     *</span>
00531 <span class="comment">     *  @param  hours       Estimated duration in hours of the session</span>
00532 <span class="comment">     *</span>
00533 <span class="comment">     *  @param  minutes     Estimated duration in minutes of the session</span>
00534 <span class="comment">     *</span>
00535 <span class="comment">     */</span>
00536     function pinitialize($hours=12, $minutes=0)
00537     {
00538         global <a class="code" href="config_8php.html#a21">$debug</a>;
00539 
00540         $total_minutes = ($hours * 60) + ($minutes);
00541         <span class="keywordflow">if</span> ($total_minutes &lt; 0) {
00542             <span class="comment">//use default</span>
00543             $hours = 12;
00544             $minutes = 0;
00545         } <span class="keywordflow">else</span> {
00546             $hours = floor($total_minutes / 60);
00547             $minutes = $total_minutes % 60;
00548         }
00549 
00550         <span class="keywordflow">if</span> ($this-&gt;connected == FALSE)
00551                 $this-&gt;pconnect();
00552         
00553         <span class="comment">// Remote EGEE middleware interaction</span>
00554         <span class="comment">// We run the Globus and Middleware commands in the User Interface, but </span>
00555         <span class="comment">// the output goes to the remote machine in the current directory</span>
00556         fwrite($this-&gt;std_in, <span class="stringliteral">"grid-proxy-init  -pwstdin -valid $hours:$minutes\n"</span>);
00557         fflush($this-&gt;std_in);
00558         <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>) {
00559             echo fgets($this-&gt;std_out, 1024).<span class="stringliteral">"\n"</span>;      <span class="comment">// last (should have been eaten</span>
00560                                                     <span class="comment">// by connect() )</span>
00561             echo fgets($this-&gt;std_out, 1024).<span class="stringliteral">"\n"</span>;      <span class="comment">// command</span>
00562             echo fgets($this-&gt;std_out, 1024).<span class="stringliteral">"\n"</span>; <span class="comment">// whoami</span>
00563         } <span class="keywordflow">else</span> {
00564             fgets($this-&gt;std_out, 1024);        <span class="comment">// this one should not be needed</span>
00565             fgets($this-&gt;std_out, 1024);
00566             fgets($this-&gt;std_out, 1024);
00567         }
00568         fwrite($this-&gt;std_in, <span class="stringliteral">"$this-&gt;passphrase\n"</span>);
00569         fflush($this-&gt;std_in);
00570         <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>) {
00571                 echo<span class="stringliteral">"&lt;p&gt;&lt;hr&gt;&lt;p&gt;"</span>;
00572                 echo fgets($this-&gt;std_out, 1024).<span class="stringliteral">"\n"</span>; <span class="comment">// password</span>
00573                 echo fgets($this-&gt;std_out, 1024).<span class="stringliteral">"\n"</span>; <span class="comment">// creating...</span>
00574                 echo fgets($this-&gt;std_out, 1024).<span class="stringliteral">"\n"</span>; <span class="comment">// validity</span>
00575         } <span class="keywordflow">else</span> {
00576             fgets($this-&gt;std_out, 1024);    <span class="comment">// remove passphrase from std_out</span>
00577 <span class="comment">//          fgets($this-&gt;std_out, 1024);</span>
00578 <span class="comment">//          fgets($this-&gt;std_out, 1024);</span>
00579         }
00580         <span class="comment">// The output from grid-proxy-init will go to the session log</span>
00581         <span class="comment">// in std_out</span>
00582         <span class="comment">// Make sure it is read or the child may block on writing.</span>
00583         
00584         <span class="comment">// Create the working directory if it doesn't exist</span>
00585         fwrite($this-&gt;std_in, <span class="stringliteral">"mkdir -p $this-&gt;work_dir\n"</span>);
00586         fflush($this-&gt;std_in);
00587     }
00588 <span class="comment"></span>
00589 <span class="comment">    /**</span>
00590 <span class="comment">     *  Destroy remote grid identity</span>
00591 <span class="comment">     *</span>
00592 <span class="comment">     *  Destroy the certification we initialized so that no more jobs</span>
00593 <span class="comment">     *  can be launched under our identity.</span>
00594 <span class="comment">     *</span>
00595 <span class="comment">     *  Note that once you call this, no more work will be performed on</span>
00596 <span class="comment">     * the Grid on your behalf... BEWARE of race conditions!!!</span>
00597 <span class="comment">     *</span>
00598 <span class="comment">     *  As an example, suppose you have two simultaneous works, A and B:</span>
00599 <span class="comment">     *      A connects to the Grid</span>
00600 <span class="comment">     *      A submits job to the Grid</span>
00601 <span class="comment">     *                                  B connects to the Grid</span>
<a name="l00602"></a><a class="code" href="classGrid.html#a11">00602</a> <span class="comment">     *      A destroys proxy</span>
00603 <span class="comment">     *                                  B submits job to the Grid &lt;-- FAILS!!!</span>
00604 <span class="comment">     *                                  B destroys proxy</span>
00605 <span class="comment">     *</span>
00606 <span class="comment">     *  In general, you should not use this function, but rely instead on</span>
00607 <span class="comment">     * the proxy's lifetime to do the control. Use this function when you</span>
00608 <span class="comment">     * really want to make sure NO MORE WORK is performed at all. This may</span>
00609 <span class="comment">     * be the case if you want to cancel all outstanding jobs.</span>
00610 <span class="comment">     *</span>
00611 <span class="comment">     *  @note: no error checking is performed. You are supposed to check</span>
00612 <span class="comment">     * the standard output to verify success yourself (just as in all </span>
00613 <span class="comment">     * other persistent commands).</span>
00614 <span class="comment">     */</span>
00615     function pdestroy()
00616     {
00617         global <a class="code" href="config_8php.html#a21">$debug</a>;
00618         fwrite($this-&gt;std_in, <span class="stringliteral">"grid-proxy-destroy\n"</span>);
00619         fflush($this-&gt;std_in);
00620         
00621         <span class="comment">// The output from grid-proxy-destroy will go to the session log</span>
00622         <span class="comment">// in std_out. There should be none.</span>
00623         <span class="comment">// Make sure it is read or the child may block on writing.</span>
00624 
00625     }
00626 
00627     <span class="comment">// J O B    M A N I P U L A T I O N</span>
00628     <span class="comment">// For the moment these are just stubs to be filled in</span>
00629     <span class="comment">//</span>
00630     <span class="comment"></span>
00631 <span class="comment">    /**</span>
00632 <span class="comment">     *  Create a new session</span>
00633 <span class="comment">     *</span>
00634 <span class="comment">     * @note: untested.</span>
00635 <span class="comment">     */</span>
00636     function pnew_session()
00637     {
00638         list($usec, $sec) = explode(<span class="charliteral">' '</span>, microtime());
00639         $seed = (<span class="keywordtype">float</span>) $sec + ((<span class="keywordtype">float</span>) $usec * 100000);
00640         srand($seed);
00641         $rand1 = rand(); $rand2 = rand();
00642         $session = <span class="stringliteral">"session-$rand1-$rand2"</span>;
00643         fwrite($this-&gt;std_in, <span class="stringliteral">"mkdir -p "</span>.$this-&gt;work_dir.<span class="stringliteral">"/"</span>.$session.<span class="stringliteral">"\n"</span>);
00644         <span class="keywordflow">return</span> $session;
00645     }
00646 <span class="comment"></span>
00647 <span class="comment">    /**</span>
00648 <span class="comment">     * Submit a job to the Grid</span>
00649 <span class="comment">     *</span>
00650 <span class="comment">     *  This function submits a job to the Grid, optionally tagging it</span>
00651 <span class="comment">     * as part of a specific session.</span>
00652 <span class="comment">     *</span>
00653 <span class="comment">     *  @param  job     The name of the job (same as the subdirectory it is in)</span>
00654 <span class="comment">     *  @param  session Optional name of the session to which this job belongs</span>
00655 <span class="comment">     *                  (obtained from a previous call to pnew_session).</span>
00656 <span class="comment">     * </span>
00657 <span class="comment">     */</span>
00658     function pjob_submit($job, $session=<span class="stringliteral">""</span>)
00659     {
00660         global <a class="code" href="config_8php.html#a21">$debug</a>;
00661         
00662         <span class="comment">// Take a job package and submit it to the Grid</span>
00663         <span class="comment">//  Job package:</span>
00664         <span class="comment">//      everything needed to run the job</span>
00665         <span class="comment">//</span>
00666         <span class="comment">// 1. copy the job package to the grid server</span>
00667         
00668         <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>) {
00669             echo <span class="stringliteral">"Copying job $job to remote end "</span>.
00670                 <span class="stringliteral">"$this-&gt;entry_point:$this-&gt;work_dir/$session"</span> .
00671                 <span class="stringliteral">"with $this-&gt;password\n\n"</span>;
00672         }
00673         <a class="code" href="results_8php.html#a2">$status</a> = $this-&gt;sx-&gt;ssh_copy(
00674                 $job, 
00675                 <span class="stringliteral">"$this-&gt;entry_point:$this-&gt;work_dir/$session"</span>, 
00676                 $this-&gt;password);
00677         <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a> == FALSE)
00678             <a class="code" href="util_8php.html#a4">letal</a>(<span class="stringliteral">"Job submission"</span>, <span class="stringliteral">"Can't copy job to Grid server"</span>);
00679         
00680         <span class="comment">// set real job name:</span>
<a name="l00681"></a><a class="code" href="classGrid.html#a12">00681</a>         <span class="comment">//  we might have got a long pathname for the job</span>
00682         <span class="comment">//  scp will only copy the last element of the path, which is OK</span>
00683         <span class="comment">//  but we must be sure we use that portion as well for the</span>
00684         <span class="comment">//  remote directory name</span>
00685         $job = basename($job);
00686         
00687         <span class="comment">// 2. submit job to the grid</span>
00688         <span class="comment">// we may need to issue a fwrite($this-&gt;std_in, "cd $this-&gt;work_dir\n");</span>
00689         fwrite($this-&gt;std_in, <span class="stringliteral">"edg-job-submit"</span>
00690                             . <span class="stringliteral">"  -o $this-&gt;work_dir/$job/job.id"</span>
00691                             . <span class="stringliteral">"  $this-&gt;work_dir/$job/job.jdl"</span>
00692                             . <span class="stringliteral">"  &gt; $this-&gt;work_dir/$job/job-info.out\n"</span>);
00693         fflush($this-&gt;std_in);
00694         
00695         <span class="comment">/* This might be used for local files, not remote ones</span>
00696 <span class="comment">        return preg_grep("/^https:/", file("$this-&gt;work_dir/$job/job.id"));</span>
00697 <span class="comment">        * Alternately, we might test for completion of edg-job-submit and</span>
00698 <span class="comment">        * then scp those files back to user's home host and then use the</span>
00699 <span class="comment">        * local code above.</span>
00700 <span class="comment">        */</span>
00701         <span class="keywordflow">return</span>;
<a name="l00702"></a><a class="code" href="classGrid.html#a13">00702</a>     }
00703     <span class="comment"></span>
00704 <span class="comment">    /**</span>
00705 <span class="comment">     *  Get Grid ID of a submitted job.</span>
00706 <span class="comment">     */</span>
00707     function pjob_get_id($job, $session=<span class="stringliteral">""</span>)
00708     {
00709         global <a class="code" href="config_8php.html#a21">$debug</a>;
00710         <span class="comment">// XXX first we should check that job.id exists</span>
00711         <span class="comment">// there are two possible scenarios:</span>
00712         <span class="comment">//  mistake - we are called without first calling job_submit</span>
00713         <span class="comment">//  correct - we are called after job_submit: then</span>
00714         <span class="comment">//      - job_submit has completed -- job.id exists</span>
00715         <span class="comment">//      - job_submit has NOT completed -- job.id does'n exist yet</span>
00716         <span class="comment">//        but job-info.out does</span>
00717         <span class="comment">// check job-info.out exists: if not, then warn user</span>
00718         <span class="comment">// check job.id exists: if not wait/warn user</span>
00719 
00720         <span class="comment">// we may have received a long pathname, but only care about</span>
00721         <span class="comment">// its last component remotely</span>
00722         $remote_dir = basename($job);
00723         <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>) {
<a name="l00724"></a><a class="code" href="classGrid.html#a14">00724</a>             echo <span class="stringliteral">"Retrieving "</span>. 
00725             <span class="stringliteral">"$this-&gt;entry_point:$this-&gt;work_dir/$session/$remote_dir/job.id"</span> .
00726             <span class="stringliteral">" into $job using $this-&gt;password\n\n"</span>;
00727         }
00728         <a class="code" href="results_8php.html#a2">$status</a> = $this-&gt;sx-&gt;ssh_copy(
00729             <span class="stringliteral">"$this-&gt;entry_point:$this-&gt;work_dir/$session/$remote_dir/job.id"</span>,
00730             $job,
00731             $this-&gt;password);
00732         <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a> == FALSE) {
00733             <span class="comment">// this is a warning since job-submit may not have finished yet</span>
00734             <a class="code" href="util_8php.html#a2">warning</a>(<span class="stringliteral">"Get job ID: could not retrieve grid job ID\n\n"</span>);
00735             <span class="keywordflow">return</span>;
00736         }
00737         <span class="keywordflow">else</span> {
00738             <span class="keywordflow">return</span> preg_grep(<span class="stringliteral">"/^https:/"</span>, file(<span class="stringliteral">"$job/job.id"</span>));
00739         }
00740         <span class="keywordflow">return</span>; <span class="comment">// empty</span>
00741     }
00742 <span class="comment"></span>
00743 <span class="comment">    /**</span>
00744 <span class="comment">     * check job status</span>
00745 <span class="comment">     *</span>
00746 <span class="comment">     * </span>
00747 <span class="comment">     */</span>
00748     function pjob_status($job, $session=<span class="stringliteral">""</span>)
00749     {
00750         global <a class="code" href="config_8php.html#a21">$debug</a>;
00751         
00752         $rjob = basename($job);
00753         $job_id = $this-&gt;pjob_get_id($rjob);
00754         <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>) print_r($job_id);
00755         fwrite($this-&gt;std_in, <span class="stringliteral">"edg-job-status "</span>.$job_id[1].<span class="stringliteral">" &gt; $this-&gt;work_dir/$session/$rjob/job.stat\n"</span>);
00756         fflush($this-&gt;std_out);
00757 <span class="comment">// wait for completion and copy locally as above and return.</span>
00758         sleep(1);
00759         <span class="keywordflow">if</span> ($debug) {
00760             echo <span class="stringliteral">"Retrieving "</span> .
00761                 <span class="stringliteral">"$this-&gt;entry_point:$this-&gt;work_dir/$session/$rjob/job.stat"</span> .
00762                 <span class="stringliteral">" into $job using $this-&gt;password\n\n"</span>;
00763         }
00764         $status = $this-&gt;sx-&gt;ssh_copy(
00765             <span class="stringliteral">"$this-&gt;entry_point:$this-&gt;work_dir/$session/$rjob/job.stat"</span>,
00766             $job,
00767             $this-&gt;password);
00768         <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a> == FALSE) {
00769             <span class="comment">// this is a warning since job-submit may not have finished yet</span>
00770             <a class="code" href="util_8php.html#a2">warning</a>(<span class="stringliteral">"Get job status: could not retrieve grid job status\n\n"</span>);
00771             <span class="keywordflow">return</span>;
00772         }
<a name="l00773"></a><a class="code" href="classGrid.html#a15">00773</a>         <span class="keywordflow">else</span> {
00774             <span class="keywordflow">return</span> preg_grep(<span class="stringliteral">"/^Current Status:/"</span>, file(<span class="stringliteral">"$job/job.stat"</span>));
00775         }
00776         <span class="keywordflow">return</span>; <span class="comment">// empty</span>
00777         
00778     }
00779     <span class="comment"></span>
00780 <span class="comment">    /**</span>
00781 <span class="comment">     * retrieve results</span>
00782 <span class="comment">     *</span>
00783 <span class="comment">     * @note STUB. DO NOT USE YET</span>
00784 <span class="comment">     */</span>
00785     function pjob_output($job, $session=<span class="stringliteral">""</span>)
00786     {
00787         global <a class="code" href="config_8php.html#a21">$debug</a>;
00788         
00789         $rjob = basename($job);
00790         $job_id = $this-&gt;pjob_get_id($rjob);
00791         <span class="comment">// get output pack from the grid to UI... </span>
00792         <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>) {
00793             print_r($job_id);
00794             echo <span class="stringliteral">"sending edg-job-get-output "</span> .
00795             <span class="stringliteral">"--dir $this-&gt;work_dir/$session/$rjob/ "</span> . 
00796             $job_id[1] . <span class="stringliteral">"&gt; job.out\n"</span>;
00797         }
00798         fwrite($this-&gt;std_in, <span class="stringliteral">"edg-job-get-output "</span> .
00799             <span class="stringliteral">"--dir $this-&gt;work_dir/$session/$rjob/ "</span> . 
00800             $job_id[1] . <span class="stringliteral">"&gt; job.out\n"</span>);
00801         sleep(5);   <span class="comment">// XXX JR XXX should check stdout</span>
00802         <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>)
00803             echo <span class="stringliteral">"getting $this-&gt;entry_point:$this-&gt;work_dir/$session/$rjob/"</span>
00804             .$this-&gt;username.<span class="stringliteral">"_* into $job\n\n"</span>;
00805         <a class="code" href="results_8php.html#a2">$status</a> = $this-&gt;sx-&gt;ssh_copy(
00806             <span class="stringliteral">"$this-&gt;entry_point:$this-&gt;work_dir/$session/$rjob/"</span>.$this-&gt;username.<span class="stringliteral">"_*"</span>,
00807             $job,
00808             $this-&gt;password);
00809         <span class="keywordflow">return</span> <a class="code" href="results_8php.html#a2">$status</a>;
00810     }
00811 
00812 
00813 
<a name="l00814"></a><a class="code" href="classGrid.html#a16">00814</a> <span class="comment">//------ C O N N E C T I O N L E S S    G R I D   A C C E S S   F U N C T I O N S ------</span>
00815 <span class="comment"></span>
00816 <span class="comment">    /**</span>
00817 <span class="comment">     * Start the Grid services</span>
00818 <span class="comment">     *</span>
00819 <span class="comment">     *  This function starts the grid services on the remote UI server host.</span>
00820 <span class="comment">     *  This is done by unlocking the certificate that we are going to use </span>
00821 <span class="comment">     *  to run our jobs on the grid using the passphrase provided.</span>
00822 <span class="comment">     *</span>
00823 <span class="comment">     *  Grid services have a lifetime of their own. By default they are</span>
00824 <span class="comment">     *  available for 12:00 hours (that's the default value of</span>
00825 <span class="comment">     *  grid-proxy-init itself), but their duration may be fine tuned</span>
00826 <span class="comment">     *  if we have some knowledge about the time required to run our</span>
00827 <span class="comment">     *  job.</span>
00828 <span class="comment">     *</span>
00829 <span class="comment">     *  Session duration is specified in hours+minutes. If the number of</span>
00830 <span class="comment">     *  minutes is negative, the specified minutes are substracted from</span>
00831 <span class="comment">     *  the specified hours (e.g: 1, -15 is fifteen minutes to one hour,</span>
00832 <span class="comment">     *  i.e. 45 minutes). If the total time specified is negative then</span>
00833 <span class="comment">     *  the default of 12:00 is used.</span>
00834 <span class="comment">     *</span>
00835 <span class="comment">     *  @param  hours       Estimated duration in hours of the session</span>
00836 <span class="comment">     *</span>
00837 <span class="comment">     *  @param  minutes     Estimated duration in minutes of the session</span>
00838 <span class="comment">     *</span>
00839 <span class="comment">     *  @return TRUE on success, FALSE otherwise</span>
00840 <span class="comment">     */</span>
00841      
00842     function initialize($hours=12, $minutes=0)
00843     {
00844         global <a class="code" href="config_8php.html#a21">$debug</a>;
00845         
00846         $total_minutes = ($hours * 60) + ($minutes);
00847         <span class="keywordflow">if</span> ($total_minutes &lt; 0) {
00848             <span class="comment">//use default</span>
00849             $hours = 12;
00850             $minutes = 0;
<a name="l00851"></a><a class="code" href="classGrid.html#a17">00851</a>         } <span class="keywordflow">else</span> {
00852             $hours = floor($total_minutes / 60);
00853             $minutes = $total_minutes % 60;
00854         }
00855         $rin = $this-&gt;sx-&gt;ssh_popen(
00856             $this-&gt;entry_point,
00857             $this-&gt;password,
00858             <span class="stringliteral">"/opt/globus/bin/grid-proxy-init -pwstdin -valid $hours:$minutes"</span>, 
00859             <span class="stringliteral">"w"</span>
00860             );
00861         fputs($rin, $this-&gt;passphrase.<span class="stringliteral">"\n"</span>);
00862         $status = $this-&gt;sx-&gt;ssh_pclose($rin);
00863         <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a> != 0)
00864             <span class="comment">// something went airy</span>
00865             <span class="keywordflow">return</span> FALSE;
00866         
00867         <span class="comment">// Create working dir</span>
00868         <a class="code" href="results_8php.html#a2">$status</a> = $this-&gt;sx-&gt;ssh_exec(
00869             $this-&gt;entry_point,
00870             $this-&gt;password,
00871             <span class="stringliteral">"mkdir -p $this-&gt;work_dir"</span>,
00872             $out);
00873             
00874         <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a> == 0) {
00875             <span class="keywordflow">return</span> $this-&gt;initialized = TRUE;
00876         } <span class="keywordflow">else</span> {
00877             <span class="keywordflow">return</span> $this-&gt;initialized = FALSE;
00878         }
00879     }
00880 <span class="comment"></span>
00881 <span class="comment">    /**</span>
00882 <span class="comment">     *  Destroy remote grid identity</span>
00883 <span class="comment">     *</span>
00884 <span class="comment">     *  We destroy the certification we initialized so that no more jobs</span>
00885 <span class="comment">     *  can be launched under our identity.</span>
00886 <span class="comment">     *</span>
00887 <span class="comment">     *  @note   Be careful when using this function: as it destroys our</span>
00888 <span class="comment">     *          Grid-ID, no more work will be able to be executed on the</span>
00889 <span class="comment">     *          grid on our behalf. In other words, please, make sure there</span>
00890 <span class="comment">     *          is no work pending and that all your work has terminated</span>
00891 <span class="comment">     *          before destroying your Grid-ID.</span>
00892 <span class="comment">     *</span>
00893 <span class="comment">     *  @param pipes    The set of pipes to communicate (stdin/stdout) with</span>
00894 <span class="comment">     *                  the remote grid server entry point</span>
00895 <span class="comment">     *</span>
00896 <span class="comment">     *  @return exit status of the destroy command.</span>
00897 <span class="comment">     */</span>
00898     function destroy()
00899     {
00900         <span class="keywordflow">return</span> $this-&gt;sx-&gt;ssh_exec(
00901             $this-&gt;entry_point,
00902             $this-&gt;password,
00903             <span class="stringliteral">"grid-proxy-destroy"</span>,
00904             $out);
00905     }
00906 <span class="comment"></span>
00907 <span class="comment">    /**</span>
<a name="l00908"></a><a class="code" href="classGrid.html#a18">00908</a> <span class="comment">     *  Create a new session</span>
00909 <span class="comment">     *</span>
00910 <span class="comment">     * untested!</span>
00911 <span class="comment">     */</span>
00912     function new_session()
00913     {
00914         <a class="code" href="results_8php.html#a2">$status</a> = $this-&gt;sx-&gt;ssh_exec( 
00915             $this-&gt;entry_point,
00916             $this-&gt;password,
00917             <span class="stringliteral">"mktemp -d -p $this-&gt;work_dir sess_XXXXXXXXXXXXXXXX"</span>,
00918             $out);
00919         <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a> == 0) {
00920             $this-&gt;work_dir = $out;
00921             <span class="keywordflow">return</span> TRUE;
00922         } <span class="keywordflow">else</span>
00923             <span class="keywordflow">return</span> FALSE;
00924     }
00925 <span class="comment"></span>
00926 <span class="comment">    /**</span>
00927 <span class="comment">     * destroy the current session</span>
00928 <span class="comment">     */</span>
00929     function destroy_session()
00930     {
00931         <a class="code" href="results_8php.html#a2">$status</a> = $this-&gt;sx-&gt;ssh_exec(
00932             $this-&gt;entry_point,
00933             $this-&gt;password,
00934             <span class="stringliteral">"rm -rf $this-&gt;work_dir"</span>,
00935             $out);
00936         <span class="comment">// strip session part</span>
00937         $this-&gt;work_dir = dirname($this-&gt;work_dir);
00938         <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a> == 0)
00939             <span class="keywordflow">return</span> TRUE;
00940         <span class="keywordflow">else</span>
00941             <span class="keywordflow">return</span> FALSE;
00942     }
00943 <span class="comment"></span>
00944 <span class="comment">    /**</span>
00945 <span class="comment">     * submit a job to the grid</span>
00946 <span class="comment">     */</span>
00947     function job_submit($job, &amp;$out)
00948     {
00949         global <a class="code" href="config_8php.html#a21">$debug</a>;
00950         
00951         <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>) {
00952             echo <span class="stringliteral">"Copying job $job to remote end "</span>.
00953                 <span class="stringliteral">"$this-&gt;entry_point:$this-&gt;work_dir"</span> .
00954                 <span class="stringliteral">" with $this-&gt;password\n\n"</span>;
00955         }
00956         <span class="comment">// Copy job details over to remote end</span>
00957         <a class="code" href="results_8php.html#a2">$status</a> = $this-&gt;sx-&gt;ssh_copy(
00958             $job, 
00959             <span class="stringliteral">"$this-&gt;entry_point:$this-&gt;work_dir"</span>,
00960             $this-&gt;password);
00961         <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a> == FALSE)
00962             <span class="comment">// copy failed</span>
00963             <span class="keywordflow">return</span> FALSE;
<a name="l00964"></a><a class="code" href="classGrid.html#a19">00964</a>         <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>)
00965             echo <span class="stringliteral">"Submitting "</span>
00966             . <span class="stringliteral">"/opt/edg/bin/edg-job-submit"</span>
00967             . <span class="stringliteral">"  -o $this-&gt;work_dir/$job/job.id"</span>
00968             . <span class="stringliteral">"  $this-&gt;work_dir/$job/job.jdl"</span>
00969             . <span class="stringliteral">"  | tee $this-&gt;work_dir/$job/job.info.out"</span>;
00970 
00971         <span class="comment">// NOTE: with direct execution we don't go through the login</span>
00972         <span class="comment">// process, hence needed environment variables must be set.</span>
00973         <a class="code" href="results_8php.html#a2">$status</a> = $this-&gt;sx-&gt;ssh_exec(
00974             $this-&gt;entry_point,
00975             $this-&gt;password,
00976             <span class="stringliteral">"(export EDG_WL_LOCATION=/opt/edg ;"</span>
00977             . <span class="stringliteral">" /opt/edg/bin/edg-job-submit"</span>
<a name="l00978"></a><a class="code" href="classGrid.html#a20">00978</a>             . <span class="stringliteral">"  -o $this-&gt;work_dir/$job/job.id"</span>
00979             . <span class="stringliteral">"  $this-&gt;work_dir/$job/job.jdl"</span>
00980             . <span class="stringliteral">"  | tee $this-&gt;work_dir/$job/job.info.out"</span>
00981             . <span class="stringliteral">")"</span>,
00982             $out);
00983         <span class="comment">// note: perhaps we should use 'tee' and get the job.info.out?</span>
00984         <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>) echo <span class="stringliteral">"submit status was $status\n"</span>;
00985         <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a> == 0)
00986             <span class="keywordflow">return</span> TRUE;
00987         <span class="keywordflow">else</span>
00988             <span class="keywordflow">return</span> FALSE;
00989     }
00990     
00991     function job_get_id($job)
00992     {
00993         <span class="comment">// if we have been called successfully previously, then</span>
00994         <span class="comment">//  we have a cached copy of the 'job.id' file locally.</span>
<a name="l00995"></a><a class="code" href="classGrid.html#a21">00995</a>         <span class="comment">//  Use it instead and save bandwidth.</span>
00996         <span class="keywordflow">if</span> (file_exists(<span class="stringliteral">"$job/job.id"</span>))
00997             <span class="keywordflow">return</span> preg_grep(<span class="stringliteral">"/^https:/"</span>, file(<span class="stringliteral">"$job/job.id"</span>));
00998         
00999         <span class="comment">// we may have received a long pathname, but only care about</span>
01000         <span class="comment">// its last component remotely</span>
01001         $remote_dir = basename($job);
01002         <a class="code" href="results_8php.html#a2">$status</a> = $this-&gt;sx-&gt;ssh_copy(
01003             <span class="stringliteral">"$this-&gt;entry_point:$this-&gt;work_dir/$remote_dir/job.id"</span>,
01004             $job, 
01005             $this-&gt;password);
01006         <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a> == FALSE) {
01007             <span class="comment">// this is a warning since job-submit might not have finished yet</span>
01008             <a class="code" href="util_8php.html#a2">warning</a>(<span class="stringliteral">"Get job ID: could not retrieve grid job ID"</span>);
01009             <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
01010         }
01011         <span class="keywordflow">else</span> {
01012             <span class="keywordflow">return</span> preg_grep(<span class="stringliteral">"/^https:/"</span>, file(<span class="stringliteral">"$job/job.id"</span>));
<a name="l01013"></a><a class="code" href="classGrid.html#a22">01013</a>         }
01014         <span class="comment">// NOTE: this returns an array of \n terminated strings, which is</span>
01015         <span class="comment">// highly inconvenient. CORRECT</span>
01016         <span class="keywordflow">return</span>;
01017     }
01018 
01019     function job_status($job, &amp;$out)
01020     {
01021         global <a class="code" href="config_8php.html#a21">$debug</a>;
01022         
01023         $rjob = basename($job);
01024         $job_id = $this-&gt;job_get_id($rjob);
01025         <span class="keywordflow">if</span> (<a class="code" href="config_8php.html#a21">$debug</a>)
01026             echo <span class="stringliteral">"Sending\n\t"</span> .
01027                 <span class="stringliteral">"(export EDG_WL_LOCATION=/opt/edg ; "</span> .
01028                 <span class="stringliteral">"/opt/edg/bin/edg-job-status "</span>. $job_id[1] .<span class="stringliteral">")"</span>,
01029         <a class="code" href="results_8php.html#a2">$status</a> = $this-&gt;sx-&gt;ssh_exec(
01030             $this-&gt;entry_point,
01031             $this-&gt;password,
01032             <span class="stringliteral">"(export EDG_WL_LOCATION=/opt/edg ; "</span> .
01033             <span class="stringliteral">"/opt/edg/bin/edg-job-status "</span>. $job_id[1] .<span class="stringliteral">")"</span>,
01034             $out);
01035         <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a> != 0)
01036             <span class="keywordflow">return</span> <span class="stringliteral">""</span>;
01037         <span class="keywordflow">else</span>
01038             <span class="keywordflow">return</span> $out;        
01039     }
01040     
01041     function job_output($job, &amp;$out)
01042     {
01043         global <a class="code" href="config_8php.html#a21">$debug</a>;
01044         
01045         $rjob = basename($job);
01046         $job_id = $this-&gt;pjob_get_id($rjob);
01047         <a class="code" href="results_8php.html#a2">$status</a> = $this-&gt;sx-&gt;ssh_exec(
01048             $this-&gt;entry_point,
01049             $this-&gt;password,
01050             <span class="stringliteral">"(export EDG_WL_LOCATION=/opt/edg ; "</span> .
01051             <span class="stringliteral">" export PATH=/opt/globus/bin:/opt/edg/bin:\$PATH ;"</span> .
01052             <span class="stringliteral">"/opt/edg/bin/edg-job-get-output "</span> .
01053             <span class="stringliteral">"--dir $this-&gt;work_dir/$rjob/ "</span> .
01054             $job_id[1].<span class="stringliteral">")"</span>,
01055             $out);
01056         <span class="keywordflow">if</span> (<a class="code" href="results_8php.html#a2">$status</a> != 0)
<a name="l01057"></a><a class="code" href="classGrid.html#a23">01057</a>             <span class="keywordflow">return</span> FALSE;
01058         <a class="code" href="results_8php.html#a2">$status</a> = $this-&gt;sx-&gt;ssh_copy(
01059             <span class="stringliteral">"$this-&gt;entry_point:$this-&gt;work_dir/$session/$rjob/"</span>.$this-&gt;username.<span class="stringliteral">"_*"</span>,
01060             $job,
01061             $this-&gt;password);
01062         <span class="keywordflow">return</span> <a class="code" href="results_8php.html#a2">$status</a>;
01063     }
01064 }
01065 ?&gt;
01066 
01067 </pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Apr 21 15:51:36 2005 for egTinker by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > </a>1.3.6 </small></address>
</body>
</html>
